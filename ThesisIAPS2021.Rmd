---
title: "ThesisIAPS2021"
author: "Helio"
date: "13/09/2021"
output: html_document
---


Related scripts
- Paper_analyses_subj_Obje_arousal

Related datasets
db_full4new_stim_screen_pupil_nopract

#######################################
PUPIL
######################################
```{r}
unique(db_full4new_stim_screen_pupil_nopract$ssid)
# missing data

356
# 357 = 312_2021 (missing pratice behavioural data)
611-617

312 = 357

311/357 = 611

# Pupil

```


Importing new datasets

```{r}
library(readr)
library(tidyverse)
# currendatasets::
db_full4new_stim_screen_pupil_nopract

# importinng subjects 356, 357 and 611 to 616, note that gaze data for 616 is invalid
# participant 615 is obese so the physio data might be compromised due to heavy breathing during the session
db_356_357_611_616 <- read_csv("tmp.df4_sum_full_bio_hr_self_parsed_356_357_611_616.csv")


# rename a few columns to match current dataset

db_356_357_611_616<- db_356_357_611_616 %>%
  rename(Gender = gender)%>%
  rename(menalHealth = `mental_health-text`)

# subset stim to match current dataset

db_356_357_611_616_stim<- subset(db_356_357_611_616, db_356_357_611_616$screencontent == "stim")

# a few more columns need renaming

# db_356_357_611_616_stim<- db_356_357_611_616_stim %>% 
#   rename(Age = Age)%>%
#   rename(Gender = gender_response)


# NOW bind rows
db_full4new_stim_screen_pupil_nopract_backup_befoe356_611_616<- db_full4new_stim_screen_pupil_nopract
db_full4new_stim_screen_pupil_nopract<- db_full4new_stim_screen_pupil_nopract_backup_befoe356_611_616

colnames(db_356_357_611_616_stim)
colnames(db_full4new_stim_screen_pupil_nopract)





db_full4new_stim_screen_pupil_select <- db_full4new_stim_screen_pupil_nopract %>%
  select(c(ssid,subject, Condition,screencontent, screencontent_no, text, tNo,trialUnq,
           stimIAPS,stimDescription, arousal, valence,
           ArousalMean, ValenceMean, pup_basCor, gaze_loss_prop,gaze_valid_prop,
           completion_code, Gender:BVAQ, WASIM, BIO_CDA.AmpSum:BIO_Global.Mean,
           fix_count:RMS, POGsd:SacAmp))

pupil_select_cols<- names(db_full4new_stim_screen_pupil_select)

colnames(db_full4new_stim_screen_pupil_select)

# select similar columns in the new data and make them if they don't exist

db_356_357_611_616_stim$correction <- db_356_357_611_616_stim$`EyesightResponse-text`
db_356_357_611_616_stim$mentalHealth<- db_356_357_611_616_stim$menalHealth
db_356_357_611_616_stim$eyeColor<- db_356_357_611_616_stim$`eye_colour-text`
db_356_357_611_616_stim$FirstLanguage<- NA

db_356_357_611_616_stim$IAS<- NA
db_356_357_611_616_stim$STAIIT<- NA
db_356_357_611_616_stim$STAIIS<- NA
db_356_357_611_616_stim$sdevgaze_parsed<- NULL

db_356_357_611_616_stim$Group <- if_else(db_356_357_611_616_stim$ssid> 400, "ASD", "NT")

# select
db_356_357_611_616_stim_select<- select(db_356_357_611_616_stim, 
                                        c(pupil_select_cols))



# now merge current and new
db_full4new_stim_screen_pupil_select_priortomerge<- db_full4new_stim_screen_pupil_select
db_356_357_611_616_stim_select$ssid<- as.character(db_356_357_611_616_stim_select$ssid)
db_full4new_stim_screen_pupil_select$ssid<- as.character(db_full4new_stim_screen_pupil_select$ssid)
db_356_357_611_616_stim_select$tNo<- as.character(db_356_357_611_616_stim_select$tNo)
db_full4new_stim_screen_pupil_select$tNo <- as.character(db_full4new_stim_screen_pupil_select$tNo)

db_full4new_stim_screen_pupil_select<- 
  bind_rows(db_full4new_stim_screen_pupil_select, db_356_357_611_616_stim_select)


save(db_356_357_611_616,db_356_357_611_616_stim, db_full4new_stim_screen_pupil_nopract, db_full4new_stim_screen_pupil_select, "InteroStudy21Thesis.Rdata")


```
demographics

```{r}
db_full4new_stim_screen_pupil_select$Group<- if_else(as.numeric(db_full4new_stim_screen_pupil_select$ssid)>
                                                       500 & as.numeric(db_full4new_stim_screen_pupil_select$ssid) < 700, "ASD", "NT")

unique(db_full4new_stim_screen_pupil_select$Gender)
table(is.na(db_full4new_stim_screen_pupil_select$Gender))

demog_summ<- db_full4new_stim_screen_pupil_select%>%
  group_by(ssid, Group, Gender)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)

write_csv(demog_summ, "demog_summ.csv")

save(db_356_357_611_616,db_356_357_611_616_stim, db_full4new_stim_screen_pupil_nopract, db_full4new_stim_screen_pupil_select,demog_summ, "InteroStudy21Thesis.Rdata")
                                                     

```


Merge brightness data

```{r}
db_full4new_stim_screen_pupil_select$stimIAPS[db_full4new_stim_screen_pupil_select$stimIAPS== "2900.1.jpg"]<- "2900.jpg1.jpg"

db_full4new_stim_screen_pupil_select$stimIAPS[db_full4new_stim_screen_pupil_select$stimIAPS== "2345.1.jpg"]<- "2345.jpg1.jpg"

db_full4new_stim_screen_pupil_select$Label<- substr(db_full4new_stim_screen_pupil_select$stimIAPS, 1,8)

db_full4new_stim_screen_pupil_select$stimIAPS2<- substr(db_full4new_stim_screen_pupil_select$stimIAPS, 1,4)
imageJ_IAPS
imageJ_IAPS$stimIAPS2<- imageJ_IAPS$Label2

imageJ_IAPS$Label2<- NULL

db_full4new_stim_screen_pupil_select1 <- dplyr::left_join(db_full4new_stim_screen_pupil_select, imageJ_IAPS, by = "stimIAPS2")


save(db_356_357_611_616,db_356_357_611_616_stim, 
     db_full4new_stim_screen_pupil_nopract, db_full4new_stim_screen_pupil_select,
     demog_summ,db_full4new_stim_screen_pupil_select1,
     imageJ_IAPS, file = "test.Rdata")
```


Pupil models

```{r}

# flag outliers
# pupil  - flad outliers based on range of responses of each participant
# for arousal - and valence flag it based on average responses across participants

db_full4new_stim_screen_pupil_select1


 db_full4new_stim_screen_pupil_select1<- db_full4new_stim_screen_pupil_select1 %>%
  group_by(stimIAPS) %>%
  mutate(arousal_outler = if_else(arousal > (median(arousal, na.rm = TRUE) + 
                                               (4*mad(arousal, na.rm = TRUE))), TRUE,
         if_else(arousal < (median(arousal, na.rm = TRUE) - 
                              (4*mad(arousal, na.rm = TRUE))), TRUE, FALSE)))%>%
   mutate(valence_outler = if_else(valence > (median(valence, na.rm = TRUE) + 
                                               (4*mad(valence, na.rm = TRUE))), TRUE,
         if_else(valence < (median(valence, na.rm = TRUE) - 
                              (4*mad(valence, na.rm = TRUE))), TRUE, FALSE)))%>%
  group_by(ssid)%>%
   mutate(pupil_outlier = if_else(pup_basCor > (median(pup_basCor, na.rm = TRUE) 
                                                + (3*mad(pup_basCor, na.rm = TRUE))), TRUE,
         if_else(pup_basCor < (median(pup_basCor, na.rm = TRUE) - 
                                 (3*mad(pup_basCor, na.rm = TRUE))), TRUE, FALSE)))
 
 
 # quick check
 db_full4new_stim_screen_pupil_select1%>%
   subset(ssid == 339)%>%
   # subset(pupil_outlier == FALSE)%>%
   
   ggplot(aes(pup_basCor))+
   geom_histogram()+
   facet_grid(~pupil_outlier)

 db_full4new_stim_screen_pupil_select1%>%
   subset(ssid == 339)%>%
   # subset(pupil_outlier == FALSE)%>%
   
   ggplot(aes(arousal))+
   geom_histogram()+
   facet_grid(~arousal_outler)



```

center and scale predictors
```{r}
table(is.na(db_full4new_stim_screen_pupil_select1$Group))
db_full4new_stim_screen_pupil_select1<- db_full4new_stim_screen_pupil_select1 %>%
    ungroup()%>%
  mutate(arousal_c = scale(arousal, center = TRUE, scale = TRUE)[,1],
         valence_c = scale(valence, center = TRUE, scale = TRUE)[,1],
         Mean_gray_z = scale(Mean)[,1],
         TASc = scale(TAS)[,1],
         AQc = scale(AQ)[,1],
         BPQc = scale(BPQ)[,1],
         WASIM_c =scale(WASIM)[,1],
         DASSTotalc = scale(DASSTotal)[,1])


db_full4new_stim_screen_pupil_select1$Group_NT_pos<- if_else(db_full4new_stim_screen_pupil_select1$Group == "NT", +.5, -.5)

```

Formal models

```{r}
options(contrasts = c("contr.sum","contr.poly"))
options(scipen = 999)

# first concordance

# across all participants
db_full4new_stim_screen_pupil_select1%>%
  # subset(Group == "NT")%>%
  subset(pupil_outlier == FALSE)%>%
   # subset(valence_outler == FALSE)%>%
  # subset(arousal_outler == FALSE)%>%
  subset(ssid!= 356)%>% #clear pupil outlier
  subset(ssid!= 351)%>%
  subset(ssid!= 344)%>% #anthony
  group_by(ssid, Group)%>%
  mutate(cor_ar_pup = cor(arousal_c, pup_basCor, use = "complete"))%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(TAS,cor_ar_pup))+
  geom_point(aes(color = Group))+
  # geom_text(aes(label = ssid))+
    geom_smooth(method = lm, se = F)+
    ggpubr::stat_cor()+
  p$graphstyle



db_full4new_stim_screen_pupil_select1%>%
  # subset(Group == "NT")%>%
  subset(pupil_outlier == FALSE)%>%
   # subset(valence_outler == FALSE)%>%
  # subset(arousal_outler == FALSE)%>%
  subset(ssid!= 356)%>% #clear pupil outlier
  subset(ssid!= 351)%>%
  subset(ssid!= 344)%>% #anthony
  group_by(ssid, Group)%>%
  mutate(cor_ar_pup = cor(arousal_c, pup_basCor, use = "complete"))%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(AQ,cor_ar_pup))+
  geom_point(aes(color = Group))+
  # geom_text(aes(label = ssid))+
    geom_smooth(method = lm, se = F)+
    ggpubr::stat_cor()+
  p$graphstyle


```

# aq
```{r}
db_full4new_stim_screen_pupil_select1%>%
  subset(Group == "ASD")%>%
  subset(pupil_outlier == FALSE)%>%
   subset(gaze_valid_tresh == "include")%>%
  subset(arousal_outler == FALSE)%>%
  subset(ssid!= 356)%>% #clear pupil outlier
  subset(ssid!= 351)%>%
  subset(ssid!= 344)%>% #anthony
  group_by(ssid, Group)%>%
  mutate(cor_ar_pup = cor(arousal_c, pup_basCor, use = "complete"))%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(TAS,cor_ar_pup, color = Group))+
  geom_point()+
  geom_text(aes(label = ssid))+
    geom_smooth(method = lm, se = F)+
    ggpubr::stat_cor()

table(is.na(db_full4new_stim_screen_pupil_select1$TAS))

test<- subset(db_full4new_stim_screen_pupil_select1, is.na(TAS))
test$ssid

unique(test$ssid)
 # 344 601 352 355 614

db_full4new_stim_screen_pupil_select1$TAS[db_full4new_stim_screen_pupil_select1$ssid == 355]<- 67
db_full4new_stim_screen_pupil_select1$AQ[db_full4new_stim_screen_pupil_select1$ssid == 355]<- 19
# db_full4new_stim_screen_pupil_select1$AQ[db_full4new_stim_screen_pupil_select1$ssid == 355]<- 19

db_full4new_stim_screen_pupil_select1$TAS[db_full4new_stim_screen_pupil_select1$ssid == 352]<- 46
db_full4new_stim_screen_pupil_select1$AQ[db_full4new_stim_screen_pupil_select1$ssid == 352]<- 19

# 601
db_full4new_stim_screen_pupil_select1$TAS[db_full4new_stim_screen_pupil_select1$ssid == 601]
db_full4new_stim_screen_pupil_select1$AQ[db_full4new_stim_screen_pupil_select1$ssid == 601]


# 614
db_full4new_stim_screen_pupil_select1$TAS[db_full4new_stim_screen_pupil_select1$ssid == 601]
db_full4new_stim_screen_pupil_select1$AQ[db_full4new_stim_screen_pupil_select1$ssid == 601]

db_full4new_stim_screen_pupil_select1$Alexithymia_cutoff<- if_else(db_full4new_stim_screen_pupil_select1$TAS>60, "High", "Low")

db_full4new_stim_screen_pupil_select1%>%
  subset(!is.na(TAS))%>%
  subset(pupil_outlier == FALSE)%>%
   subset(gaze_valid_tresh == "include")%>%
  subset(arousal_outler == FALSE)%>%
  subset(ssid!= 356)%>% #clear pupil outlier
  subset(ssid!= 351)%>%
  subset(ssid!= 344)%>% #anthony
  group_by(ssid, Group,Alexithymia_cutoff)%>%
  mutate(cor_ar_pup = cor(arousal_c, pup_basCor, use = "complete"))%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(Group,cor_ar_pup, color = Alexithymia_cutoff))+
  geom_point()+
  stat_summary(geom = 'pointrange')+
  # geom_text(aes(label = ssid))+
    geom_smooth(method = lm, se = F)+
    ggpubr::stat_compare_means()

```

mixed models

```{r}
options(contrasts = c("contr.sum","contr.poly"))
options(scipen = 999)
library(lmerTest)

# compute average pupil validity
db_full4new_stim_screen_pupil_select1<- db_full4new_stim_screen_pupil_select1 %>%
  group_by(ssid)%>%
  mutate(avg_gaze_valid = mean(gaze_valid_prop, na.rm = TRUE))%>%
  ungroup()%>%
  mutate(gaze_valid_tresh = if_else(avg_gaze_valid> .8, "include", "exclude"))

db_full4new_stim_screen_pupil_select1%>%
  ggplot(aes(avg_gaze_valid))+
  geom_histogram()+
  facet_grid(~gaze_valid_tresh)

db_full4new_stim_screen_pupil_select1%>%
  subset(gaze_valid_tresh == "exclude")


```

```{r}
lmer_intero_pupil<- list()

# factor random effects

db_full4new_stim_screen_pupil_select1<- db_full4new_stim_screen_pupil_select1%>%
  mutate(stimIAPS2 = factor(stimIAPS2),
         ssid = factor(ssid))

# pupil against subjective ratings and alexithymia
pupil_arousal_findings$pup_self_tas <- lmer(pup_basCor ~ (arousal_c)* 
                                                    TASc  *Group_NT_pos+
  Mean_gray_z +
                                                      (1|stimIAPS2)+
                                                    (1  | ssid),
                                                  REML = FALSE,
                      data = db_full4new_stim_screen_pupil_select1%>%
    subset(ssid!= 356)%>%
         subset(gaze_valid_tresh == "include")%>%
   subset(ssid!= 351))


summary(pupil_arousal_findings$pup_self_tas )
print(pupil_arousal_findings$pup_self_tas, correlation =TRUE)  

# db_full4new_stim_screen_pupil_select1%>%
#   group_by(stimIAPS2)%>%
#   summarise_if(is.numeric, mean, na.rm = TRUE)%>%
#   ggplot(aes(Mean_gray_z, valence))+
#   geom_point()+
#   geom_smooth(method = 'lm')+
#   ggpubr::stat_cor()


# same as above but no outliers
pupil_arousal_findings$pup_self_tas_no_outl <- lmer(pup_basCor ~ (arousal_c)* 
                                                    TASc  +
                                                    # *Group_NT_pos+
  Mean_gray_z +
                                                      (1|stimIAPS2)+
                                                    (1  | ssid),
                                                  REML = FALSE,
                      data = db_full4new_stim_screen_pupil_select1%>%
    subset(pupil_outlier == FALSE)%>%
     subset(arousal_outler == FALSE)%>%
    subset(ssid!= 356)%>%
      subset(gaze_valid_tresh == "include")%>%
         # subset(as.numeric(ssid) < 500))
   subset(ssid!= 351))

summary(pupil_arousal_findings$pup_self_tas_no_outl)

sjPlot::tab_model(pupil_arousal_findings$pup_self_tas_no_outl)

interactions::probe_interaction(pupil_arousal_findings$pup_self_tas_no_outl,
                                pred= arousal_c, modx = TASc)

# AQ

pupil_arousal_findings$pup_self_tasaq_no_outl <- lmer(pup_basCor ~ (arousal_c)* 
                                                    (AQc+TASc)+
                                                    # *Group_NT_pos+
  Mean_gray_z +
                                                      (1|stimIAPS2)+
                                                    (1  | ssid),
                                                  REML = FALSE,
                      data = db_full4new_stim_screen_pupil_select1%>%
    subset(pupil_outlier == FALSE)%>%
     # subset(arousal_outler == FALSE)%>%
    subset(ssid!= 356)%>%
      subset(gaze_valid_tresh == "include")%>%
         # subset(as.numeric(ssid) < 500))
   subset(ssid!= 351))


pupil_arousal_findings$pup_self_aq_no_outl <- lmer(pup_basCor ~ (arousal_c)* 
                                                    (AQc)+
                                                    # *Group_NT_pos+
  Mean_gray_z +
                                                      (1|stimIAPS2)+
                                                    (1  | ssid),
                                                  REML = FALSE,
                      data = db_full4new_stim_screen_pupil_select1%>%
    subset(pupil_outlier == FALSE)%>%
     # subset(arousal_outler == FALSE)%>%
    subset(ssid!= 356)%>%
      subset(gaze_valid_tresh == "include")%>%
         # subset(as.numeric(ssid) < 500))
   subset(ssid!= 351))

summary(pupil_arousal_findings$pup_self_tasaq_no_outl)
summary(pupil_arousal_findings$pup_self_aq_no_outl)

anova(pupil_arousal_findings$pup_self_tasaq_no_outl, pupil_arousal_findings$pup_self_tas_no_outl,
      pupil_arousal_findings$pup_self_aq_no_outl)

car::vif(pupil_arousal_findings$pup_self_tasaq_no_outl)



interactions::probe_interaction(pupil_arousal_findings$pup_self_tasaq_no_outl,
                                pred= arousal_c, modx = AQc)

```

```{r}
# just NT

pupil_arousal_findings$pup_self_tas_no_outl_NT <- lmer(pup_basCor ~ (arousal_c)* 
                                                    (TASc  )+
                                                    # *Group_NT_pos+
  Mean_gray_z +
                                                      (1|stimIAPS2)+
                                                    (1  | ssid),
                                                  REML = FALSE,
                      data = db_full4new_stim_screen_pupil_select1%>%
    subset(pupil_outlier == FALSE)%>%
     subset(arousal_outler == FALSE)%>%
    subset(Group ==  "NT")%>%
    subset(ssid!= 356)%>%
      # subset(ssid!= 357)%>%
      subset(gaze_valid_tresh == "include")%>%
         # subset(as.numeric(ssid) < 500))
   subset(ssid!= 351))


  # subset(ssid!= 356)%>% #clear pupil outlier
  # subset(ssid!= 351)%>%
  # subset(ssid!= 344)%>%
summary(pupil_arousal_findings$pup_self_tas_no_outl_NT)


pupil_arousal_findings$pup_self_tasaq_no_outl_NT <- lmer(pup_basCor ~ (arousal_c)* 
                                                    (TASc+AQc  )+
                                                    # *Group_NT_pos+
  Mean_gray_z +
                                                      (1|stimIAPS2)+
                                                    (1  | ssid),
                                                  REML = FALSE,
                      data = db_full4new_stim_screen_pupil_select1%>%
    subset(pupil_outlier == FALSE)%>%
     # subset(arousal_outler == FALSE)%>%
    subset(Group ==  "NT")%>%
    subset(ssid!= 356)%>%
      # subset(ssid!= 357)%>%
      subset(gaze_valid_tresh == "include")%>%
         # subset(as.numeric(ssid) < 500))
   subset(ssid!= 351))

summary(pupil_arousal_findings$pup_self_tasaq_no_outl_NT)

```


```{r}

# just ASD

pupil_arousal_findings$pup_self_tas_no_outl_ASD <- lmer(pup_basCor ~ (arousal)* 
                                                    TASc  +
                                                    # *Group_NT_pos+
  Mean_gray_z +
                                                      (1|stimIAPS2)+
                                                    (1  | ssid),
                                                  REML = FALSE,
                      data = db_full4new_stim_screen_pupil_select1%>%
    subset(pupil_outlier == FALSE)%>%
     subset(arousal_outler == FALSE)%>%
    subset(Group ==  "ASD")%>%
      subset(gaze_valid_tresh == "include"))


  # subset(ssid!= 356)%>% #clear pupil outlier
  # subset(ssid!= 351)%>%
  # subset(ssid!= 344)%>%
summary(pupil_arousal_findings$pup_self_tas_no_outl_ASD)


summary(pupil_arousal_findings$pup_self_tas_no_outl_NT)


interactions::interact_plot(pupil_arousal_findings$pup_self_tas_no_outl_NT, 
                            pred = arousal_c, modx = TASc)

```

#predict arousal now

```{r}
db_full4new_stim_screen_pupil_select1

pupil_arousal_findings$pupil_from_brightness_lm <- lm(pup_basCor ~ 
                                                    Mean,
                                                    
                      data = db_full4new_stim_screen_pupil_select1, na.action=na.exclude) 


summary(pupil_arousal_findings$pupil_from_brightness)

plot(pupil_arousal_findings$pupil_from_brightness)

# store residuals

db_full4new_stim_screen_pupil_select1$pup_resid_lm <- resid(pupil_arousal_findings$pupil_from_brightness_lm,
                                                            na.action=na.exclude)



pupil_arousal_findings$arous_pup_tas_no_outl_NT <- lmer(arousal ~ pup_basCor* 
                                                    TASc  +
                                                    # *Group_NT_pos+
  Mean_gray_z +
                                                      (1|stimIAPS2)+
                                                    (1  | ssid),
                                                  REML = FALSE,
                      data = db_full4new_stim_screen_pupil_select1%>%
    subset(pupil_outlier == FALSE)%>%
     subset(arousal_outler == FALSE)%>%
    subset(Group ==  "NT")%>%
    subset(ssid!= 356)%>%
      # subset(ssid!= 357)%>%
      subset(gaze_valid_tresh == "include")%>%
         # subset(as.numeric(ssid) < 500))
   subset(ssid!= 351))



summary(pupil_arousal_findings$arous_pup_tas_no_outl_NT)

```



Group, ignoring TAS

```{r}
pupil_arousal_findings$arous_pup_GR_no_outl <- lmer(pup_basCor ~ arousal_c* 
                                                    Group_NT_pos  +
  Mean_gray_z +
                                                      (1|stimIAPS2)+
                                                    (1  | ssid),
                                                  REML = FALSE,
                      data = db_full4new_stim_screen_pupil_select1%>%
    subset(pupil_outlier == FALSE)%>%
     subset(arousal_outler == FALSE)%>%
    # subset(Group ==  "NT")%>%
    subset(ssid!= 356)%>%
      # subset(ssid!= 357)%>%
      subset(gaze_valid_tresh == "include")%>%
         # subset(as.numeric(ssid) < 500))
   subset(ssid!= 351))

anova(pupil_arousal_findings$arous_pup_GR_no_outl)

summary(pupil_arousal_findings$arous_pup_GR_no_outl)

MuMIn::r.squaredGLMM(pupil_arousal_findings$arous_pup_GR_no_outl)

MuMIn::r.squaredGLMM(pupil_arousal_findings$pup_self_tas_no_outl_NT)

interactions::interact_plot(pupil_arousal_findings$arous_pup_GR_no_outl,
                            pred = arousal_c, modx = Group_NT_pos)

```

SCR

```{r}

db_full4new_stim_screen_pupil_select1

db_full4new_stim_screen_pupil_select1_scr<- db_full4new_stim_screen_pupil_select1

db_full4new_stim_screen_pupil_select1_scr<- 
  subset(db_full4new_stim_screen_pupil_select1_scr, as.numeric(as.character(ssid))>303)

unique(db_full4new_stim_screen_pupil_select1_scr$ssid)

db_full4new_stim_screen_pupil_select1_scr$ssid<- as.character(db_full4new_stim_screen_pupil_select1_scr$ssid)

db_full4new_stim_screen_pupil_select1_scr$ssid
 

db_full4new_stim_screen_pupil_select1_scr<- db_full4new_stim_screen_pupil_select1_scr%>%
       ungroup()%>%
  mutate(arousal_c = scale(arousal, center = TRUE, scale = TRUE)[,1],
         valence_c = scale(valence, center = TRUE, scale = TRUE)[,1],
         Mean_gray_z = scale(Mean)[,1],
         TASc = scale(TAS)[,1],
         AQc = scale(AQ)[,1],
         BPQc = scale(BPQ)[,1],
         WASIM_c =scale(WASIM)[,1],
         DASSTotalc = scale(DASSTotal)[,1])
 
  # ungroup%>%
  # mutate(valence_c = scale(valence, center = TRUE, scale = TRUE)[,1])%>%
  # mutate(arousal_c = scale(arousal, center = TRUE, scale = TRUE)[,1])%>%
  # mutate(TASc = scale(TAS, center = TRUE, scale = TRUE)[,1])
 
 # flag non responders
 
 
# db_full4new_stim_screen_pupil_select1_scr$bio
 
 # flag outliers

```

model

PHASI MAX
TTP

AMp SUm
SCR

```{r}
unique(db_full4new_stim_screen_pupil_select1_scr$ssid)

db_full4new_stim_screen_pupil_select1_scr %>%
 subset(arousal_outler == FALSE)%>%
       subset(BIO_CDA.SCR_outl  == FALSE)%>%
  subset(BIO_CDA.PhasicMax!= 0)%>%
  group_by(ssid)%>%
  mutate(BIO_CDA.PhasicMax_log = log1p(BIO_CDA.PhasicMax+.1))%>%
  mutate(BIO_CDA.PhasicMax_log_z = scale(BIO_CDA.PhasicMax_log))%>% 
  mutate(cor_scr_ar = cor(BIO_CDA.PhasicMax_z, arousal))%>%
  mutate(cor_scr_ar2 = cor(BIO_CDA.PhasicMax_log_z, arousal))%>%
  mutate(cor_scr_ar3 = cor(BIO_CDA.PhasicMax_log, arousal))%>%
  group_by(ssid, Group)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(TAS, cor_scr_ar))+
  geom_point()+
  geom_smooth(method = lm, se = F)+
  facet_grid(~Group)+
  ggpubr::stat_cor()

```


```{r}
lmer_scr_intero_thesis<- list()

db_full4new_stim_screen_pupil_select1_scr<- db_full4new_stim_screen_pupil_select1_scr%>%
  group_by(ssid)%>%
  mutate(BIO_CDA.SCR_z = scale(BIO_CDA.SCR))%>%
  # mutate(BIO_CDA.SCR_outl = if_else(log1p(BIO_CDA.SCR+.1)> (median(log1p(BIO_CDA.SCR+.1), na.rm = TRUE)+ 
  #                                     (20*(mad(log1p(BIO_CDA.SCR+.1), na.rm = TRUE)))), TRUE, FALSE))
  mutate(BIO_CDA.SCR_outl = if_else(abs(BIO_CDA.SCR_z)> 3, TRUE, FALSE))

table(db_full4new_stim_screen_pupil_select1_scr$ssid, db_full4new_stim_screen_pupil_select1_scr$BIO_CDA.SCR_outl)


lmer_scr_intero_thesis$SCR_ar_TAS <- lmer(log(BIO_CDA.SCR+.1) ~ arousal_c *
                                            TASc+
                                             (1|ssid) + 
                                            (1|stimIAPS),
                        REML = FALSE,
                        data = db_full4new_stim_screen_pupil_select1_scr%>%
     subset(arousal_outler == FALSE)%>%
       subset(BIO_CDA.SCR_outl  == FALSE)%>%
  subset(BIO_CDA.SCR!= 0)) # exlude non responding trials

anova(lmer_scr_intero_thesis$SCR_ar_TAS)

summary(lmer_scr_intero_thesis$SCR_ar_TAS)

range(db_full4new_stim_screen_pupil_select1_scr$BIO_CDA.ISCR, na.rm = TRUE)
range(db_full4new_stim_screen_pupil_select1_scr$BIO_CDA.SCR, na.rm = TRUE)
range(db_full4new_stim_screen_pupil_select1_scr$BIO_CDA.PhasicMax, na.rm = TRUE)
range(db_full4new_stim_screen_pupil_select1_scr$BIO_TTP.AmpSum, na.rm = TRUE)
table(is.na(db_full4new_stim_screen_pupil_select1_scr$BIO_CDA.ISCR))

flag_non_resp <- table(db_full4new_stim_screen_pupil_select1_scr$ssid, db_full4new_stim_screen_pupil_select1_scr$BIO_TTP.AmpSum == 0)



# just NT

lmer_scr_intero_thesis$SCR_ar_TAS_NT <- lmer(log(BIO_CDA.SCR+.1) ~ arousal_c *
                                            TASc+
                                             (1|ssid) + 
                                            (1|stimIAPS),
                        REML = FALSE,
                        data = db_full4new_stim_screen_pupil_select1_scr%>%
     subset(arousal_outler == FALSE)%>%
       subset(Group == "NT")%>%
         # subset(BIO_CDA.SCR!= 0)%>%
       subset(BIO_CDA.SCR_outl  == FALSE))


summary(lmer_scr_intero_thesis$SCR_ar_TAS_NT )

# just ASD

lmer_scr_intero_thesis$SCR_ar_TAS_ASD <- lmer(log(BIO_CDA.SCR+.1) ~ arousal_c *
                                            TASc+
                                             (1|ssid) + 
                                            (1|stimIAPS),
                        REML = FALSE,
                        data = db_full4new_stim_screen_pupil_select1_scr%>%
     subset(arousal_outler == FALSE)%>%
       subset(Group == "ASD")%>%
         # subset(BIO_CDA.SCR!= 0)%>%
       subset(BIO_CDA.SCR_outl  == FALSE))


summary(lmer_scr_intero_thesis$SCR_ar_TAS_ASD)
# same trend non significant

# group instead of TAS

lmer_scr_intero_thesis$SCR_ar_TAS_gr <- lmer(log(BIO_CDA.SCR+.1) ~ arousal_c *
                                            Group_NT_pos+
                                             (1|ssid) + 
                                            (1|stimIAPS),
                        REML = FALSE,
                        data = db_full4new_stim_screen_pupil_select1_scr%>%
     subset(arousal_outler == FALSE)%>%
       # subset(Group == "ASD")%>%
         # subset(BIO_CDA.SCR!= 0)%>%
       subset(BIO_CDA.SCR_outl  == FALSE))

summary(lmer_scr_intero_thesis$SCR_ar_TAS_gr )

anova(lmer_scr_intero_thesis$SCR_ar_TAS_gr )


summary(lmer(log(BIO_CDA.SCR+.1) ~ arousal_c *
                                            AQc+
                                             (1|ssid) + 
                                            (1|stimIAPS),
                        REML = FALSE,
                        data = db_full4new_stim_screen_pupil_select1_scr%>%
     subset(arousal_outler == FALSE)%>%
       # subset(Group == "NT")%>%
         # subset(BIO_CDA.SCR!= 0)%>%
       subset(BIO_CDA.SCR_outl  == FALSE))) # does not preddict shit


```

PhasiMax


```{r}
lmer_scr_intero_thesis<- list()

db_full4new_stim_screen_pupil_select1_scr<- db_full4new_stim_screen_pupil_select1_scr%>%
  group_by(ssid)%>%
  mutate(BIO_CDA.PhasicMax_z = scale(BIO_CDA.PhasicMax))%>%
  # mutate(BIO_CDA.SCR_outl = if_else(log1p(BIO_CDA.SCR+.1)> (median(log1p(BIO_CDA.SCR+.1), na.rm = TRUE)+ 
  #                                     (20*(mad(log1p(BIO_CDA.SCR+.1), na.rm = TRUE)))), TRUE, FALSE))
  mutate(BIO_CDA.PhasicMax_z_outl = if_else(abs(BIO_CDA.PhasicMax_z)> 3, TRUE, FALSE))

table(db_full4new_stim_screen_pupil_select1_scr$ssid, db_full4new_stim_screen_pupil_select1_scr$BIO_CDA.PhasicMax_z_outl)


lmer_scr_intero_thesis$PhasMax_ar_TAS <- lmer(log(BIO_CDA.PhasicMax+.1) ~ arousal_c *
                                            TASc+
                                             (1|ssid) + 
                                            (1|stimIAPS),
                        REML = FALSE,
                        data = db_full4new_stim_screen_pupil_select1_scr%>%
     subset(arousal_outler == FALSE)%>%
       subset(BIO_CDA.PhasicMax_z_outl  == FALSE))
  # subset(BIO_CDA.SCR!= 0)) # exlude non responding trials

anova(lmer_scr_intero_thesis$PhasMax_ar_TAS)

summary(lmer_scr_intero_thesis$PhasMax_ar_TAS)


# TAS +aq
lmer_scr_intero_thesis$PhasMax_ar_TAS <- lmer(log(BIO_CDA.PhasicMax+.1) ~ arousal_c *
                                            (TASc+AQ)+
                                             (1|ssid) + 
                                            (1|stimIAPS),
                        REML = FALSE,
                        data = db_full4new_stim_screen_pupil_select1_scr%>%
     subset(arousal_outler == FALSE)%>%
       subset(BIO_CDA.PhasicMax_z_outl  == FALSE))
  # subset(BIO_CDA.SCR!= 0)) # exlude non responding trials

anova(lmer_scr_intero_thesis$PhasMax_ar_TAS)

summary(lmer_scr_intero_thesis$PhasMax_ar_TAS)





# just NT

lmer_scr_intero_thesis$phasmax_ar_TAS_NT <- lmer(log(BIO_CDA.PhasicMax+.1) ~ arousal_c *
                                            TASc+
                                             (1|ssid) + 
                                            (1|stimIAPS),
                        REML = FALSE,
                        data = db_full4new_stim_screen_pupil_select1_scr%>%
     subset(arousal_outler == FALSE)%>%
       subset(BIO_CDA.PhasicMax_z_outl  == FALSE)%>%
       subset(Group == "NT"))


summary(lmer_scr_intero_thesis$phasmax_ar_TAS_NT )

# just ASD

lmer_scr_intero_thesis$phasmax_ar_TAS_ASD <- lmer(log(BIO_CDA.PhasicMax+.1) ~ arousal_c *
                                            TASc+
                                             (1|ssid) + 
                                            (1|stimIAPS),
                        REML = FALSE,
                        data = db_full4new_stim_screen_pupil_select1_scr%>%
     subset(arousal_outler == FALSE)%>%
       subset(BIO_CDA.PhasicMax_z_outl  == FALSE)%>%
       subset(Group == "ASD"))


summary(lmer_scr_intero_thesis$phasmax_ar_TAS_ASD)

MuMIn::r.squaredGLMM(lmer_scr_intero_thesis$phasmax_ar_TAS_ASD)
# same trend non significant

# group instead of TAS

lmer_scr_intero_thesis$phasmax_ar_TAS_gr <- lmer(log(BIO_CDA.PhasicMax+.1) ~ arousal_c *
                                            Group_NT_pos+
                                             (1|ssid) + 
                                            (1|stimIAPS),
                        REML = FALSE,
                        data = db_full4new_stim_screen_pupil_select1_scr%>%
     subset(arousal_outler == FALSE)%>%
       subset(BIO_CDA.PhasicMax_z_outl  == FALSE))
       # subset(Group == "ASD"))

summary(lmer_scr_intero_thesis$SCR_ar_TAS_gr )
#  the effect is tas not group

anova(lmer_scr_intero_thesis$SCR_ar_TAS_gr )


summary(lmer(log(BIO_CDA.PhasicMax+.1) ~ arousal_c *
                                            AQc+
                                             (1|ssid) + 
                                            (1|stimIAPS),
                        REML = FALSE,
                        data = db_full4new_stim_screen_pupil_select1_scr%>%
     subset(arousal_outler == FALSE)%>%
       subset(Group == "ASD")%>%
       subset(BIO_CDA.PhasicMax_z_outl  == FALSE))) # does not preddict shit

unique(db_full4new_stim_screen_pupil_select1_scr$ssid)
```
heart rate




```{r}

# keep stim and and fixation
unique(db_356_357_611_616$ssid)
library(readr)
library(readr)
 # read_csv("tmp.df4_sum_full_bio_hr_self_parsed_345_356.csv")
View(tmp_df4_sum_full_bio_hr_self_parsed_345_356)
unique(db_356_357_611_616$screen_content)

# db_356_357_611_616  equivalent to db_HR_bio_final_346_355_withfix

db_356_357_611_616$screencontent
db_356_357_611_616$screen_content
db_356_357_611_616$screencontent_no
range(db_356_357_611_616$tNo)

# db_HR_bio_final_346_355_withfix$screencontent<- db_HR_bio_final_346_355_withfix$screen_content
# db_HR_bio_final_346_355_withfix<- subset(db_HR_bio_final_346_355_withfix, tNo > -7)

# db_HR_bio_final_346_355_withfix$screencontent_no<- if_else(db_HR_bio_final_346_355_withfix$screen_content == "fixation", 1,
#                                                            if_else(db_HR_bio_final_346_355_withfix$screen_content == "stim", 2,
#                                                                    if_else(db_HR_bio_final_346_355_withfix$screen_content == "valence", 3, 4)))

# db_HR_bio_final_346_355_withfix_stim <- subset(db_HR_bio_final_346_355_withfix, screencontent_no<3)
db_356_357_611_616_withfix_stim <- subset(db_356_357_611_616, screencontent_no<3)
unique(db_356_357_611_616$ssid)

colnames(db_HR_bio_final_346_355_withfix_stim)
colnames(db_356_357_611_616_withfix_stim)
db_356_357_611_616_withfix_stim$tNo2<-NULL
db_356_357_611_616_withfix_stim$tNo3<- NULL

unique(db_356_357_611_616_withfix_stim$screencontent)

unique(db_full6new_hr_fix_stim$screencontent)

colnames(db_full6new)

# 
db_full6new_hr_fix_stim <- subset(db_full6new, screencontent_no <3)

View(db_full6new_hr_fix_stim)


colnames(db_full6new_hr_fix_stim)

colnames(db_356_357_611_616_withfix_stim)


# create a similar heart rate column
db_356_357_611_616_withfix_stim$Bio_Mean_HR<- db_356_357_611_616_withfix_stim$Mean_HR

table(is.na(db_356_357_611_616_withfix_stim$Bio_Mean_HR))

db_356_357_611_616_withfix_stim$ssid_num<- as.numeric(db_356_357_611_616_withfix_stim$ssid)
unique(db_356_357_611_616_withfix_stim$ssid)
# keep controls
unique(db_full6new_hr_fix_stim$ssid)
db_full6new_hr_fix_stim$ssid_num <- as.numeric(as.character(db_full6new_hr_fix_stim$ssid))


table(is.na(db_full6new_hr_fix_stim))

db_full6new_hr_fix_stim$Group<- if_else(db_full6new_hr_fix_stim$ssid_num< 500, "NT",
                                        if_else(db_full6new_hr_fix_stim$ssid_num>700, "NT",
                                                "ASD"))

table(is.na(db_full6new_hr_fix_stim$Group))
unique(db_full6new_hr_fix_stim$Group)


# db_full6new_hr_fix_stim_nt<- subset(db_full6new_hr_fix_stim, Group == "NT")
unique(db_full6new_hr_fix_stim$ssid_num)

# attention - keep the oens that ahve bio data

db_full6new_hr_fix_stim_backup<- db_full6new_hr_fix_stim

db_full6new_hr_fix_stim<- subset(db_full6new_hr_fix_stim, ssid_num> 303)
unique(db_full6new_hr_fix_stim$ssid)
colnames(db_full6new_hr_fix_stim)

# HR differences
db_full6new_hr_fix_stim$Bio_Mean_HR_fix<- if_else(db_full6new_hr_fix_stim$screencontent_no ==1, db_full6new_hr_fix_stim$Bio_Mean_HR, NULL)



# 346_355
unique(db_HR_bio_final_346_355_withfix_stim$ssid)

db_HR_bio_final_346_355_withfix_stim$Bio_Mean_HR_fix<- if_else(db_HR_bio_final_346_355_withfix_stim$screencontent_no ==1, db_HR_bio_final_346_355_withfix_stim$Bio_Mean_HR, NULL)

View(db_full6new_hr_fix_stim)
View(db_HR_bio_final_346_355_withfix_stim)

db_HR_bio_final_346_355_withfix_stim$Mean_HR<- NULL

db_HR_bio_final_346_355_withfix_stim$ssid<- as.character(db_HR_bio_final_346_355_withfix_stim$ssid)


db_HR_bio_final_346_355_withfix_stim$tNo <- db_HR_bio_final_346_355_withfix_stim$tNo3.x
unique(db_HR_bio_final_346_355_withfix_stim$tNo)

db_HR_bio_final_346_355_withfix_stim$tNo <- as.character(db_HR_bio_final_346_355_withfix_stim$tNo)
db_HR_bio_final_346_355_withfix_stim$trigger <- as.character(db_HR_bio_final_346_355_withfix_stim$trigger)


# 356_611
db_356_357_611_616_withfix_stim

db_356_357_611_616_withfix_stim$Bio_Mean_HR_fix<- if_else(db_356_357_611_616_withfix_stim$screencontent_no ==1, db_356_357_611_616_withfix_stim$Bio_Mean_HR, NULL)

db_356_357_611_616_withfix_stim$Bio_Mean_HR

# View(db_full6new_hr_fix_stim)
# View(db_356_357_611_616_withfix_stim)

db_356_357_611_616_withfix_stim$Mean_HR<- NULL

db_356_357_611_616_withfix_stim$ssid<- as.character(db_356_357_611_616_withfix_stim$ssid)


db_356_357_611_616_withfix_stim$tNo <- db_356_357_611_616_withfix_stim$tNo3.x
unique(db_356_357_611_616_withfix_stim$tNo)

db_356_357_611_616_withfix_stim$tNo <- as.character(db_356_357_611_616_withfix_stim$tNo)
db_356_357_611_616_withfix_stim$trigger <- as.character(db_356_357_611_616_withfix_stim$trigger)


# current
db_full6new_hr_fix_stim$trigger<- as.character(db_full6new_hr_fix_stim$trigger)
db_full6new_hr_fix_stim$trigger.x<- NULL

# db_HR_bio_final_346_355_withfix_stim$trig <- as.character(db_HR_bio_final_346_355_withfix_stim$tNo)

# db_HR_bio_final_346_355_withfix_stim$triger<- NULL
db_HR_bio_final_346_355_withfix_stim$trigger.x<- NULL
db_HR_bio_final_346_355_withfix_stim$trigger.y<- NULL
db_HR_bio_final_346_355_withfix_stim$trigger2<- NULL
db_HR_bio_final_346_355_withfix_stim$trigger_200<- NULL
# 356_616
db_356_357_611_616_withfix_stim$trigger.x<- NULL
db_356_357_611_616_withfix_stim$trigger.y<- NULL
db_356_357_611_616_withfix_stim$trigger2<- NULL
db_356_357_611_616_withfix_stim$trigger_200<- NULL

nrow(db_full6new_hr_fix_stim)+ nrow(db_HR_bio_final_346_355_withfix_stim)
# 6895


# nrow(bind_rows(db_full6new_hr_fix_stim_nt, db_HR_bio_final_346_355_withfix_stim))
db_HR_bio_final_346_355_withfix_stim$Bio_Mean_HR_fix

colnames(db_HR_bio_final_346_355_withfix_stim)
colnames(db_356_357_611_616_withfix_stim)
db_356_357_611_616_withfix_stim

db_HR_bio_final_346_355_withfix_stim

as.factor(db_HR_bio_final_346_355_withfix_stim$stim.x)
as.factor(db_HR_bio_final_346_355_withfix_stim$stim.y)
db_HR_bio_final_346_355_withfix_stim$stim.y<- NULL
db_356_357_611_616_withfix_stim$stim.y<- NULL

# unique(db_HR_bio_final_346_355_withfix_stim$screencontent)
# unique(db_full6new_hr_fix_stim_nt$screencontent)
# unique(db_full6new_hr_fix_stim_nt$screencontent.y)

db_full6new_hr_fix_stim$screencontent.x<- NULL
db_full6new_hr_fix_stim$screencontent.y<- NULL

unique(db_full6new_hr_fix_stim$trialUnq.x)
unique(db_full6new_hr_fix_stim$trialUnq.y)

db_full6new_hr_fix_stim$trialUnq<- db_full6new_hr_fix_stim$trialUnq.x
db_full6new_hr_fix_stim$trialUnq.y<- NULL
db_full6new_hr_fix_stim$trialUnq.x<- NULL


db_HR_bio_final_346_355_withfix_stim$stim<- db_HR_bio_final_346_355_withfix_stim$stim.x
db_356_357_611_616_withfix_stim$stim<- db_356_357_611_616_withfix_stim$stim.x
# db_356_357_611_616_withfix_stim$stim<- db_356_357_611_616_withfix_stim$stim.x

# bind heartrate old and new
table(is.na(db_HR_bio_final_346_355_withfix_stim$Bio_Mean_HR))
table(is.na(db_356_357_611_616_withfix_stim$Bio_Mean_HR))
table(is.na(db_full6new_hr_fix_stim$Bio_Mean_HR))
test<- subset(db_full6new_hr_fix_stim, is.na(Bio_Mean_HR))
test1<- subset(db_HR_bio_final_346_355_withfix_stim, is.na(Bio_Mean_HR))


# select only needed columns
colnames(db_full6new_hr_fix_stim)
db_full6new_hr_fix_stim_select<- db_full6new_hr_fix_stim%>%
  select(ssid:gaze_valid_prop,stimDescription:arousal,TAS, AQ,DASSAnxiety:DASSTotal,
         BPQ, WASIM, screencontent_no,BIO_CDA.AmpSum:BIO_Global.Mean, fix_count:mean_fix_dur,
         sac_count:SacAmp, Bio_Mean_HR,Bio_Mean_HR_fix, ssid_num, trialUnq)

hr_select<- colnames(db_full6new_hr_fix_stim_select)

db_HR_bio_final_346_355_withfix_stim$hr

db_HR_bio_final_346_355_withfix_stim_select<- select(db_HR_bio_final_346_355_withfix_stim,
                                                     hr_select)

db_356_357_611_616_withfix_stim_select <- select(db_356_357_611_616_withfix_stim,
                                                     hr_select)


  

db_full6new_hr_fix_stim1<- bind_rows(db_full6new_hr_fix_stim,
                                        db_HR_bio_final_346_355_withfix_stim)


db_full6new_hr_fix_stim_select1 <- bind_rows(db_full6new_hr_fix_stim_select,
                                     db_HR_bio_final_346_355_withfix_stim_select,
                                        db_356_357_611_616_withfix_stim_select)

unique(db_356_357_611_616_withfix_stim_select$ssid)

unique(db_full6new_hr_fix_stim_select1$ssid)

db_full6new_hr_fix_stim_select1$Bio_Mean_HR_fix
db_full6new_hr_fix_stim_select1$Bio_Mean_HR

table(is.na(db_full6new_hr_fix_stim_select1$Bio_Mean_HR))
test<- subset(db_full6new_hr_fix_stim_select1, is.na(Bio_Mean_HR))
unique(test$ssid)

# create heart rare dif
# start by populating fixation heart rate next to stim heart rate
db_full6new_hr_fix_stim_select2<- db_full6new_hr_fix_stim_select1 %>%
  # mutate()
  group_by(as.numeric(ssid_num), as.numeric(tNo)) %>%
  arrange(ssid_num, as.numeric(tNo),as.numeric(screencontent_no))%>%
  # select(ssid, tNo,screencontent_no, Bio_Mean_HR,Bio_Mean_HR_fix)
  fill(Bio_Mean_HR_fix, .direction = "down")%>%
  subset(screencontent_no == 2)

# Now create the difference score
# stim - fix = positive stim> neg stim<
db_full6new_hr_fix_stim_select2<- db_full6new_hr_fix_stim_select2 %>%
  mutate(Bio_Mean_HR_dif = Bio_Mean_HR - Bio_Mean_HR_fix)

db_full6new_hr_fix_stim_select2%>%
  ggplot(aes(Bio_Mean_HR_dif))+
  geom_histogram()

# flag heart rate outliers
# b_full6new_hr_fix_stim_nt1.1$Bio_Mean_HR_dif_outl <- if_else(abs(db_full6new_hr_fix_stim_nt1.1$Bio_Mean_HR_dif)>                                                   (median(abs(db_full6new_hr_fix_stim_nt1.1$Bio_Mean_HR_dif),na.rm = TRUE) +                                                               (4*(sd(abs(db_full6new_hr_fix_stim_nt1.1$Bio_Mean_HR_dif), na.rm = TRUE))))

db_full6new_hr_fix_stim_select2<-
db_full6new_hr_fix_stim_select2%>%
  group_by(ssid)%>%
  mutate(Bio_Mean_HR_dif_outl = if_else(abs(Bio_Mean_HR_dif) > (median(abs(Bio_Mean_HR_dif), na.rm = TRUE) + (3*sd(abs(Bio_Mean_HR_dif), na.rm = TRUE))), "outlier", "not outlier"))


db_full6new_hr_fix_stim_select2%>%
  subset(Bio_Mean_HR_dif_outl == "outlier")%>%
  ggplot(aes(Bio_Mean_HR_dif))+
  geom_histogram()+
  facet_grid(~Bio_Mean_HR_dif_outl)


db_full6new_hr_fix_stim_select2%>%
  subset(ssid == 609)%>%
  # subset(Bio_Mean_HR_dif_outl == "outlier")%>%
  ggplot(aes(Bio_Mean_HR_dif, color =Bio_Mean_HR_dif_outl ))+
  geom_histogram()
  facet_grid(~Bio_Mean_HR_dif_outl)
  
  table(db_full6new_hr_fix_stim_select2$ssid, db_full6new_hr_fix_stim_select2$Bio_Mean_HR_dif_outl)

```


create the scaled variables needed
```{r}
db_full6new_hr_fix_stim_select2

db_full6new_hr_fix_stim_select2<- db_full6new_hr_fix_stim_select2%>%
       ungroup()%>%
  mutate(arousal_c = scale(arousal, center = TRUE, scale = TRUE)[,1],
         valence_c = scale(valence, center = TRUE, scale = TRUE)[,1],
         # Mean_gray_z = scale(Mean)[,1],
         TASc = scale(TAS)[,1],
         AQc = scale(AQ)[,1],
         BPQc = scale(BPQ)[,1],
         WASIM_c =scale(WASIM)[,1],
         DASSTotalc = scale(DASSTotal)[,1])

db_full6new_hr_fix_stim_select2$stim
db_full6new_hr_fix_stim_select2$stimIAPS2 <- substring(db_full6new_hr_fix_stim_select2$trialUnq)

db_full6new_hr_fix_stim_select2$Group <- if_else(db_full6new_hr_fix_stim_select2$ssid_num>500 & 
                                                   db_full6new_hr_fix_stim_select2$ssid_num< 700, "ASD", "NT")

unique(db_full6new_hr_fix_stim_select2$ssid)
db_full6new_hr_fix_stim_select2 %>%
    subset(Bio_Mean_HR_dif_outl == "not outlier")%>%
  subset(ssid_num < 800)%>%
    subset(ssid_num != 356)%>% # outlier
  # subset(ssid_num<500)%>%
  # group_by(ssid)%>%
  # mutate(Bio_Mean_HR_dif = abs(Bio_Mean_HR_dif))%>%
  ungroup()%>%
  mutate(Bio_Mean_HR_dif_stim_z = scale(Bio_Mean_HR_dif))%>%
  group_by(ssid, Group)%>%
  
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(TASc, Bio_Mean_HR_dif_stim_z))+
  # geom_point()+
  geom_text(aes(label = ssid))+
  # geom_smooth(aes(group = stimIAPS, y =Bio_Mean_HR_dif_stim), method=lm, se=FALSE, colour = "gray40", alpha = .01,linetype="dashed", size = .2 )+
  geom_smooth( method=lm, se=FALSE, linetype="dashed",
             color="darkred", size = 2)+
  # stat_summary(geom = 'pointrange', pch = 1)+
    ggpubr::stat_cor()+
  p$graphstyle+
  xlab("Alexithymia (Z)")+
  ylab("HR difference")+
  facet_grid(~Group)+
p$graphstyle

db336<- subset(db_full6new_hr_fix_stim_select2, ssid == 336)
db340<- subset(db_full6new_hr_fix_stim_select2, ssid == 340)

table(db336$Bio_Mean_HR_dif_outl)
table(db340$Bio_Mean_HR_dif_outl)

```


correlation heart rate arousal
```{r}
db_full6new_hr_fix_stim_select2 %>%
  subset(Bio_Mean_HR_dif_outl == "not outlier")%>%
  subset(ssid_num != 356)%>% # outlier
  group_by(ssid)%>%
  mutate(cor_hr_ar = cor(Bio_Mean_HR_dif, arousal))%>%
  group_by(ssid, Group)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(TAS,  cor_hr_ar))+
  # geom_point()+
  geom_text(aes(label=  ssid))+
  facet_grid(~Group)+
  geom_smooth(method = lm, se = F)+
  ggpubr::stat_cor()


# db_full6new_hr_fix_stim_select2 %>%
#   subset(Bio_Mean_HR_dif_outl == "not outlier")%>%
#   subset(ssid_num != 356)%>% # outlier
#   group_by(ssid)%>%
#   mutate(cor_hr_ar = cor(Bio_Mean_HR_dif, valence))%>%
#   group_by(ssid, Group)%>%
#   summarise_if(is.numeric, mean, na.rm = TRUE)%>%
#   ggplot(aes(TAS,  cor_hr_ar))+
#   # geom_point()+
#   geom_text(aes(label=  ssid))+
#   facet_grid(~Group)+
#   geom_smooth(method = lm, se = F)+
#   ggpubr::stat_cor()


db_full6new_hr_fix_stim_select2<- db_full6new_hr_fix_stim_select2%>%
  group_by(Group)%>%
  mutate(Alexithymia_mediansplit_withinGr = if_else(TAS > median(TAS, na.rm = TRUE), "High", 'Low'))

db_full6new_hr_fix_stim_select2 %>%
  subset(Bio_Mean_HR_dif_outl == "not outlier")%>%
  subset(ssid_num != 356)%>% # outlier
  group_by(ssid)%>%
  mutate(cor_hr_ar = cor(Bio_Mean_HR_dif, arousal))%>%
  group_by(ssid, Group)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(Group,  cor_hr_ar))+
 
  geom_jitter(width = .1, alpha = .1)+
   stat_summary(geom = 'pointrange')+
  
  # geom_point()+
  # geom_text(aes(label=  ssid))+
  # facet_grid(~Group)+
  geom_smooth(method = lm, se = F)+
  ggpubr::stat_compare_means()


# mediansplit b alexithymia
db_full6new_hr_fix_stim_select2 %>%
  subset(Bio_Mean_HR_dif_outl == "not outlier")%>%
  subset(ssid_num != 356)%>% # outlier
  subset(!is.na(TAS))%>%
  group_by(ssid)%>%
  mutate(cor_hr_ar = cor(Bio_Mean_HR_dif, arousal))%>%
  group_by(ssid,Group, Alexithymia_mediansplit_withinGr)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(Alexithymia_mediansplit_withinGr,  cor_hr_ar))+
 
  # geom_jitter(width = .1, alpha = .1)+
   stat_summary(geom = 'pointrange')+
  
  # geom_point()+
  geom_text(aes(label=  ssid))+
  facet_grid(~Group)+
  geom_smooth(method = lm, se = F)+
  ggpubr::stat_compare_means()
  

```

lmer models of hr

```{r}

lmer_hr_interoThesis<- list()
db_full4new_stim_screen_pupil_select1_scr


db_full6new_hr_fix_stim_select2$stim <- as.factor(db_full6new_hr_fix_stim_select2$stim)
db_full6new_hr_fix_stim_select2$ssid <- as.factor(db_full6new_hr_fix_stim_select2$ssid)

lmer_hr_interoThesis$biohr_tas_arous <- lmer(Bio_Mean_HR_dif ~ TASc * arousal_c + 
                 (1|ssid) + 
                 (1| stim),
     REML = FALSE,
     data = db_full6new_hr_fix_stim_select2 %>%
       subset(Bio_Mean_HR_dif_outl == "not outlier")%>%
       subset(ssid!= 356))
     # %>%
   # subset(ssid!= 351))

summary(lmer_hr_interoThesis$biohr_tas_arous )

# just NT

lmer_hr_interoThesis$biohr_tas_arous_NT <- lmer(Bio_Mean_HR_dif ~ TASc * arousal_c + 
                 (1|ssid) + 
                 (1| stim),
     REML = FALSE,
     data = db_full6new_hr_fix_stim_select2 %>%
       subset(Bio_Mean_HR_dif_outl == "not outlier")%>%
       subset(ssid!= 356)%>%
       subset(Group == "NT"))

summary(lmer_hr_interoThesis$biohr_tas_arous_NT)

?interactions::probe_interaction
interactions::probe_interaction(lmer_hr_interoThesis$biohr_tas_arous_NT, pred =arousal_c, modx = TASc )
interactions::interact_plot(lmer_hr_interoThesis$biohr_tas_arous_NT, pred =arousal_c, modx = TASc )

# Just ASC

lmer_hr_interoThesis$biohr_tas_arous_ASD <- lmer(Bio_Mean_HR_dif ~ TASc * arousal_c + 
                 (1|ssid) + 
                 (1| stim),
     REML = FALSE,
     data = db_full6new_hr_fix_stim_select2 %>%
       subset(Bio_Mean_HR_dif_outl == "not outlier")%>%
       subset(ssid!= 356)%>%
       subset(Group == "ASD"))

summary(lmer_hr_interoThesis$biohr_tas_arous_ASD)


# TAS and AQ

# just NT

lmer_hr_interoThesis$biohr_tas_aq_arous_NT <- lmer(Bio_Mean_HR_dif ~ TASc * AQc* arousal_c + 
                 (1|ssid) + 
                 (1| stim),
     REML = FALSE,
     data = db_full6new_hr_fix_stim_select2 %>%
       subset(Bio_Mean_HR_dif_outl == "not outlier")%>%
       subset(ssid!= 356)%>%
       subset(Group == "NT"))

summary(lmer_hr_interoThesis$biohr_tas_aq_arous_NT)

# just AQ
lmer_hr_interoThesis$biohr_aq_arous_NT <- lmer(Bio_Mean_HR_dif ~  AQc * arousal_c + 
                 (1|ssid) + 
                 (1| stim),
     REML = FALSE,
     data = db_full6new_hr_fix_stim_select2 %>%
       subset(Bio_Mean_HR_dif_outl == "not outlier")%>%
       subset(ssid!= 356)%>%
       subset(Group == "NT"))

summary(lmer_hr_interoThesis$biohr_aq_arous_NT)


```


Clustering responses and then compare them as a function of alexithymia
- try clustering
- barycentric discriminant analyses


```{r}
# subset NT only
db_full6new_hr_fix_stim_select2_NT<- subset(db_full6new_hr_fix_stim_select2,
                                            Group == "NT")

# flag the multiple outliers in pupil scr arousal and heart rate

db_full6new_hr_fix_stim_select2_NT$stimIAPS<- db_full6new_hr_fix_stim_select2_NT$stim

db_full6new_hr_fix_stim_select2_NT<- db_full6new_hr_fix_stim_select2_NT%>%
  group_by(stimIAPS) %>%
  mutate(arousal_outler = if_else(arousal > (median(arousal, na.rm = TRUE) + 
                                               (4*mad(arousal, na.rm = TRUE))), TRUE,
         if_else(arousal < (median(arousal, na.rm = TRUE) - 
                              (4*mad(arousal, na.rm = TRUE))), TRUE, FALSE)))%>%
   mutate(valence_outler = if_else(valence > (median(valence, na.rm = TRUE) + 
                                               (4*mad(valence, na.rm = TRUE))), TRUE,
         if_else(valence < (median(valence, na.rm = TRUE) - 
                              (4*mad(valence, na.rm = TRUE))), TRUE, FALSE)))%>%
  group_by(ssid)%>%
   mutate(pupil_outlier = if_else(pup_basCor > (median(pup_basCor, na.rm = TRUE) 
                                                + (3*mad(pup_basCor, na.rm = TRUE))), TRUE,
         if_else(pup_basCor < (median(pup_basCor, na.rm = TRUE) - 
                                 (3*mad(pup_basCor, na.rm = TRUE))), TRUE, FALSE)))%>%
    mutate(BIO_CDA.PhasicMax_z = scale(BIO_CDA.PhasicMax))%>%
  mutate(BIO_CDA.PhasicMax_z_outl = if_else(abs(BIO_CDA.PhasicMax_z)> 3, TRUE, FALSE))%>%
  ungroup()%>%
  mutate(arousal_c = scale(arousal, center = TRUE, scale = TRUE)[,1],
         valence_c = scale(valence, center = TRUE, scale = TRUE)[,1],
         # Mean_gray_z = scale(Mean)[,1],
         TASc = scale(TAS)[,1],
         AQc = scale(AQ)[,1],
         BPQc = scale(BPQ)[,1],
         WASIM_c =scale(WASIM)[,1],
         DASSTotalc = scale(DASSTotal)[,1])


# is there is at least one outlier in HR, SCR or pupil flag true
db_full6new_hr_fix_stim_select2_NT$pupil_outlier
db_full6new_hr_fix_stim_select2_NT$Bio_Mean_HR_dif_outl
db_full6new_hr_fix_stim_select2_NT$BIO_CDA.PhasicMax_z_outl

db_full6new_hr_fix_stim_select2_NT$Bio_Mean_HR_dif_outl2<- if_else(db_full6new_hr_fix_stim_select2_NT$Bio_Mean_HR_dif_outl == "outlier", TRUE, FALSE)


colnames(db_full6new_hr_fix_stim_select2_NT)


# apply(db_full6new_hr_fix_stim_select2_NT[,56,48,59], 3, function(r) any(r %in% c("TRUE")))


db_full6new_hr_fix_stim_select2_NT

unique(db_full6new_hr_fix_stim_select2_NT$ssid)

db_full6new_hr_fix_stim_select2_NT%>%
  group_by()

# try hierrquical clustering
write_csv(db_full6new_hr_fix_stim_select2_NT, "db_full6new_hr_fix_stim_select2_NT.csv")


db_full6new_hr_fix_stim_select2_NT

db_full6new_hr_fix_stim_select2_NT_no_outl<- subset(db_full6new_hr_fix_stim_select2_NT, db_full6new_hr_fix_stim_select2_NT$Bio_Mean_HR_dif_outl2 == FALSE)

colnames(db_full6new_hr_fix_stim_select2_NT)
db_full6new_hr_fix_stim_select2_NT_select<- db_full6new_hr_fix_stim_select2_NT_no_outl[,c(1,53,12,15,16,17,18,
                                                                                  42,8,28, 56,58,59,31:34)]


# export to explore hierarquical clustering
# db_full6new_hr_fix_stim_select2_NT_select, but first z score

db_full6new_hr_fix_stim_select2_NT_select_scaled<- db_full6new_hr_fix_stim_select2_NT_select %>%
  group_by(ssid)%>%
  mutate(BIO_CDA.PhasicMax_z = scale(BIO_CDA.PhasicMax))%>%
  ungroup()%>%
  mutate(BIO_CDA.PhasicMax_z_z = scale(BIO_CDA.PhasicMax_z),
         Bio_Mean_HR_dif_z = scale(Bio_Mean_HR_dif),
         pup_basCor_z = scale(pup_basCor))
  
write_csv(db_full6new_hr_fix_stim_select2_NT_select_scaled, "db_full6new_hr_fix_stim_select2_NT_select_scaled.csv")

# jasp test

library(readr)
db_full6new_hr_fix_stim_select2_NT_select_scaled_Hierclustest <- read_csv("db_full6new_hr_fix_stim_select2_NT_select_scaled_Hierclustest.csv")
View(db_full6new_hr_fix_stim_select2_NT_select_scaled_Hierclustest)

db_full6new_hr_fix_stim_select2_NT_select_scaled_Hierclustest %>%
  subset(!is.na(hierarquicaltest))%>%
  subset(!is.na(TAS))%>%
  group_by(ssid, alexmedian,hierarquicaltest)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(as.factor(hierarquicaltest), pup_basCor))+
  geom_jitter(width = .1, alpha = .1) +
  stat_summary(geom = 'pointrange')+
  # geom_text(aes(label = ssid))+
  facet_grid(~alexmedian)


db_full6new_hr_fix_stim_select2_NT_select_scaled_Hierclustest %>%
  subset(!is.na(hierarquicaltest))%>%
  subset(!is.na(TAS))%>%
  group_by(ssid, alexmedian,hierarquicaltest)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(as.factor(hierarquicaltest), pup_basCor_z))+
  geom_jitter(width = .1, alpha = .1) +
  stat_summary(geom = 'pointrange')+
  # geom_text(aes(label = ssid))+
  facet_grid(~alexmedian)




db_full6new_hr_fix_stim_select2_NT_select_scaled_Hierclustest %>%
  subset(!is.na(hierarquicaltest))%>%
  subset(!is.na(TAS))%>%
  group_by(ssid, alexmedian,hierarquicaltest)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(as.factor(hierarquicaltest), Bio_Mean_HR_dif))+
  geom_jitter(width = .1, alpha = .1) +
  stat_summary(geom = 'pointrange')+
  # geom_text(aes(label = ssid))+
  facet_grid(~alexmedian)



db_full6new_hr_fix_stim_select2_NT_select_scaled_Hierclustest %>%
  subset(!is.na(hierarquicaltest))%>%
  subset(!is.na(TAS))%>%
  group_by(ssid, alexmedian,hierarquicaltest)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(as.factor(hierarquicaltest), BIO_CDA.PhasicMax_z))+
  geom_jitter(width = .1, alpha = .1) +
  stat_summary(geom = 'pointrange')+
  # geom_text(aes(label = ssid))+
  facet_grid(~alexmedian)

# find the clusters on the aggregated data

db_full6new_hr_fix_stim_select2_NT_no_outl<- subset(db_full6new_hr_fix_stim_select2_NT, db_full6new_hr_fix_stim_select2_NT$Bio_Mean_HR_dif_outl2 == FALSE)


db_full6new_hr_fix_stim_select2_NT_select_agg<- db_full6new_hr_fix_stim_select2_NT_no_outl %>%
  group_by(stimIAPS, stimDescription)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)

  mutate(BIO_CDA.PhasicMax_z = scale(BIO_CDA.PhasicMax))%>%
  ungroup()%>%
  mutate(BIO_CDA.PhasicMax_z_z = scale(BIO_CDA.PhasicMax_z),
         Bio_Mean_HR_dif_z = scale(Bio_Mean_HR_dif),
         pup_basCor_z = scale(pup_basCor))
  
write_csv(db_full6new_hr_fix_stim_select2_NT_select_agg, "db_full6new_hr_fix_stim_select2_NT_select_agg.csv")

```
Jasp clusters are super weird so do the clustering here


```{r}
db_full6new_hr_fix_stim_select2_NT_select_agg




# K-Means Clustering

# Importing the dataset



colnames(db_full6new_hr_fix_stim_select2_NT_select_agg)

db_full6new_hr_fix_stim_select2_NT_select_agg_no_na<- subset(db_full6new_hr_fix_stim_select2_NT_select_agg,
                                                             !is.na(pup_basCor))

db_full6new_hr_fix_stim_select2_NT_select_agg_no_na<- subset(db_full6new_hr_fix_stim_select2_NT_select_agg_no_na, !is.na(db_full6new_hr_fix_stim_select2_NT_select_agg_no_na$stimDescription))

colnames(db_full6new_hr_fix_stim_select2_NT_select_agg_no_na)
clust_dataset = db_full6new_hr_fix_stim_select2_NT_select_agg_no_na[c(4,36,44)]

clust_dataset_scaled<- scale(clust_dataset)

clust_dataset_scaled
# Feature Scaling
# training_set = scale(training_set)
# test_set = scale(test_set)

# Using the elbow method to find the optimal number of clusters
set.seed(1)
wcss = vector()
for (i in 1:10) wcss[i] = sum(kmeans(clust_dataset_scaled, i)$withinss)
plot(1:10,
     wcss,
     type = 'b',
     main = paste('The Elbow Method'),
     xlab = 'Number of clusters',
     ylab = 'WCSS')

# 3

# Fitting K-Means to the dataset
set.seed(25)

kmeans = kmeans(x = clust_dataset_scaled, centers = 3)
y_kmeans = kmeans$cluster

# Visualising the clusters
# install.packages("cluster")
library(cluster)

# ?clusplot

clust_dataset_scaled
y_kmeans

clusplot(clust_dataset_scaled,
         y_kmeans,
         lines = 2,
         shade = TRUE,
         color = TRUE,
         labels = 1,
         plotchar = FALSE,
         span = TRUE
         # label = 
         # main = paste('Clusters of customers'),
         # xlab = 'Annual Income',
         # ylab = 'Spending Score'
         )


db_full6new_hr_fix_stim_select2_NT_select_agg_no_na$y_kmeans <- y_kmeans

db_full6new_hr_fix_stim_select2_NT_select_agg_no_na %>%
  ggplot(aes(factor(y_kmeans), arousal))+
  geom_point()+
  geom_text(aes(label = stimDescription))

kmean_select<- select(db_full6new_hr_fix_stim_select2_NT_select_agg_no_na,
                      c(stimIAPS,y_kmeans))





```

a few visualisations
```{r}

median(db_full6new_hr_fix_stim_select2_NT_no_outl$TAS, na.rm = TRUE)

summary(db_full6new_hr_fix_stim_select2_NT_no_outl$TAS)

db_full6new_hr_fix_stim_select2_NT_no_outl$alex_1st_vs_3rd_qrt<- if_else(db_full6new_hr_fix_stim_select2_NT_no_outl$TAS> 52, "3 qrt",
                                                                         if_else(db_full6new_hr_fix_stim_select2_NT_no_outl$TAS< 33, "1st qrt", NULL))

table(db_full6new_hr_fix_stim_select2_NT_no_outl$alex_1st_vs_3rd_qrt)

clustering_agg_noflood$y_kmeans<- y_kmeans

left_join(db_full6new_hr_fix_stim_select2_NT_no_outl, kmean_select)%>%
  subset(!is.na(TAS))%>%
  subset(!is.na(stimDescription))%>%
  group_by(ssid, alex_1st_vs_3rd_qrt, y_kmeans)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(alex_1st_vs_3rd_qrt, pup_basCor))+
  geom_jitter(width = .1, alpha = .1)+
  stat_summary(geom = 'pointrange')+
  facet_grid(~y_kmeans)+
    ggpubr::stat_compare_means()


left_join(db_full6new_hr_fix_stim_select2_NT_no_outl, kmean_select)%>%
  subset(!is.na(TAS))%>%
  subset(!is.na(stimDescription))%>%
  subset(!is.na(alex_1st_vs_3rd_qrt))%>%
  group_by(ssid, alex_1st_vs_3rd_qrt, y_kmeans)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(alex_1st_vs_3rd_qrt, Bio_Mean_HR_dif))+
  geom_jitter(width = .1, alpha = .1)+
  stat_summary(geom = 'pointrange')+
  facet_grid(~y_kmeans)+
    ggpubr::stat_compare_means()


left_join(db_full6new_hr_fix_stim_select2_NT_no_outl, kmean_select)%>%
  subset(!is.na(TAS))%>%
  subset(!is.na(stimDescription))%>%
   subset(!is.na(alex_1st_vs_3rd_qrt))%>%
  group_by(ssid, alex_1st_vs_3rd_qrt, y_kmeans)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(alex_1st_vs_3rd_qrt, BIO_CDA.PhasicMax_z))+
  geom_jitter(width = .1, alpha = .1)+
  stat_summary(geom = 'pointrange')+
  facet_grid(~y_kmeans)+
    ggpubr::stat_compare_means()


left_join(db_full6new_hr_fix_stim_select2_NT_no_outl, kmean_select)%>%
  subset(!is.na(TAS))%>%
  subset(!is.na(stimDescription))%>%
  subset(!is.na(alex_1st_vs_3rd_qrt))%>%
  group_by(ssid, alex_1st_vs_3rd_qrt, y_kmeans)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(alex_1st_vs_3rd_qrt, arousal))+
  geom_jitter(width = .1, alpha = .1)+
  stat_summary(geom = 'pointrange')+
  facet_grid(~y_kmeans)+
    ggpubr::stat_compare_means()


left_join(db_full6new_hr_fix_stim_select2_NT_no_outl, kmean_select)%>%
  subset(!is.na(TAS))%>%
  subset(!is.na(stimDescription))%>%
  subset(!is.na(alex_1st_vs_3rd_qrt))%>%
  group_by(ssid, alex_1st_vs_3rd_qrt, y_kmeans)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(alex_1st_vs_3rd_qrt, valence))+
  geom_jitter(width = .1, alpha = .1)+
  stat_summary(geom = 'pointrange')+
  facet_grid(~y_kmeans)+
    ggpubr::stat_compare_means()

```


BADIA

```{r}

db_full6new_hr_fix_stim_select2_NT_no_outl

summary(db_full6new_hr_fix_stim_select2_NT_select_agg_no_na$TAS)

db_full6new_hr_fix_stim_select2_NT_no_outl_agg_bysubj<- db_full6new_hr_fix_stim_select2_NT_no_outl%>%
  subset(!is.na(TAS))%>%
  group_by(ssid)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)

summary(db_full6new_hr_fix_stim_select2_NT_no_outl_agg_bysubj$TAS)

db_full6new_hr_fix_stim_select2_NT_no_outl_agg_bysubj$alex_quartil <- if_else(db_full6new_hr_fix_stim_select2_NT_no_outl_agg_bysubj$TAS< 33, "1st", 
if_else(db_full6new_hr_fix_stim_select2_NT_no_outl_agg_bysubj$TAS> 52, "3rd",                                                                              "Mean"))

table(db_full6new_hr_fix_stim_select2_NT_no_outl_agg_bysubj$alex_quartil)

# reformat
colnames(db_full6new_hr_fix_stim_select2_NT_no_outl)

db_full6new_hr_fix_stim_select2_NT_no_outl$log1p_BIO_CDA.PhasicMax<- log1p(db_full6new_hr_fix_stim_select2_NT_no_outl$BIO_CDA.PhasicMax+.1)

# select only necesssary columns
db_full6new_hr_fix_stim_select2_NT_no_outl

db_full6new_hr_fix_stim_select2_NT_no_outl$stimIAPS2<- substr(db_full6new_hr_fix_stim_select2_NT_no_outl$stimIAPS, 1,4)
db_full6new_hr_fix_stim_select2_NT_no_outl_3<- select(db_full6new_hr_fix_stim_select2_NT_no_outl,
                                                      c(ssid, stimIAPS, stimIAPS2, stimDescription, TAS, pup_basCor, Bio_Mean_HR_dif, log1p_BIO_CDA.PhasicMax))


db_full6new_hr_fix_stim_select2_NT_no_outl_3<- subset(db_full6new_hr_fix_stim_select2_NT_no_outl_3,!is.na(stimDescription))
unique(db_full6new_hr_fix_stim_select2_NT_no_outl_3$stimIAPS)

db_full6new_hr_fix_stim_select2_NT_no_outl_3$stimIAPS2<- substr(db_full6new_hr_fix_stim_select2_NT_no_outl_3$stimIAPS, 1,4)

factor(db_full6new_hr_fix_stim_select2_NT_no_outl_3$stimIAPS2)

# reshape
colnames(db_full6new_hr_fix_stim_select2_NT_no_outl_3)

table(is.na(db_full6new_hr_fix_stim_select2_NT_no_outl_3))

db_full6new_hr_fix_stim_select2_NT_no_outl_4<- subset(db_full6new_hr_fix_stim_select2_NT_no_outl_3, !is.na(TAS))

table(is.na(db_full6new_hr_fix_stim_select2_NT_no_outl_4$TAS))
# dcast()

colnames(db_full6new_hr_fix_stim_select2_NT_no_outl_4)

# fill in NA with average per individual
# - not working
# are things being recognised as something otehr than NA, eg NaN
table(is.nan(db_full6new_hr_fix_stim_select2_NT_no_outl_4))

db_full6new_hr_fix_stim_select2_NT_no_outl_4[db_full6new_hr_fix_stim_select2_NT_no_outl_4 == "NaN"] <- NA

# seems like it

db_full6new_hr_fix_stim_select2_NT_no_outl_5 <- db_full6new_hr_fix_stim_select2_NT_no_outl_4%>%
  group_by(ssid)%>%
  mutate(ssid_pup_basCor_mean = mean(pup_basCor, na.rm = TRUE), 
         ssid_Bio_Mean_HR_dif_mean = mean(Bio_Mean_HR_dif, na.rm = TRUE),
         ssid_log1p_BIO_CDA.PhasicMax_mean = mean(log1p_BIO_CDA.PhasicMax, na.rm = TRUE))%>%
  mutate(pup_basCor = if_else(is.na(pup_basCor) == TRUE, ssid_pup_basCor_mean, pup_basCor))%>%
  mutate(Bio_Mean_HR_dif = if_else(is.na(Bio_Mean_HR_dif) == TRUE, ssid_Bio_Mean_HR_dif_mean, Bio_Mean_HR_dif))%>%
  mutate(log1p_BIO_CDA.PhasicMax = if_else(is.na(log1p_BIO_CDA.PhasicMax) == TRUE, ssid_log1p_BIO_CDA.PhasicMax_mean, log1p_BIO_CDA.PhasicMax)) 


db_full6new_hr_fix_stim_select2_NT_no_outl_5
db_full6new_hr_fix_stim_select2_NT_no_outl_5

db_forBADA1<- data.table::dcast(setDT(db_full6new_hr_fix_stim_select2_NT_no_outl_5), 
                    ssid + TAS ~ stimIAPS2, value.var = c('pup_basCor',
                'Bio_Mean_HR_dif', 'log1p_BIO_CDA.PhasicMax'))



table(is.na(db_forBADA1))
View(db_forBADA1)
na.omit(db_forBADA1)


db_forBADA1 %>%
    select_if(~ any(is.na(.)))

table(is.na(db_forBADA1$log1p_BIO_CDA.PhasicMax_9472))

# try to fill means rowwise
colnames(db_forBADA1)

db_forBADA1_pupil<- db_forBADA1[,1:58]
table(is.na(db_forBADA1_pupil$TAS))

k <- which(is.na(db_forBADA1_pupil), arr.ind=TRUE)
k

db_forBADA1_pupil$ssid<- as.numeric(as.character(db_forBADA1_pupil$ssid))
db_forBADA1_pupil[k] <- rowMeans(db_forBADA1_pupil, na.rm=TRUE)[k[,1]]

# hr
db_forBADA1_hr<- db_forBADA1[,c(1:2,59:(59+55))]
# table(is.na(db_forBADA1_pupil$TAS))

k <- which(is.na(db_forBADA1_hr), arr.ind=TRUE)
k

db_forBADA1_hr$ssid<- as.numeric(as.character(db_forBADA1_hr$ssid))
db_forBADA1_hr[k] <- rowMeans(db_forBADA1_hr, na.rm=TRUE)[k[,1]]

db_forBADA1_hr

# scr
colnames(db_forBADA1)
db_forBADA1_scr<- db_forBADA1[,c(1:2,115:170)]
# table(is.na(db_forBADA1_pupil$TAS))

k <- which(is.na(db_forBADA1_scr), arr.ind=TRUE)
k

db_forBADA1_scr$ssid<- as.numeric(as.character(db_forBADA1_scr$ssid))
db_forBADA1_scr[k] <- rowMeans(db_forBADA1_scr, na.rm=TRUE)[k[,1]]

db_forBADA1_scr

table(is.na(bind_cols(db_forBADA1_pupil, db_forBADA1_hr[,3:58], db_forBADA1_scr[,3:58])))


# create quartiles for alexithymia
summary(db_forBADA1_pupil$TAS)
# Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#   22.00   33.00   42.00   42.82   52.00   71.00 

db_forBADA1_pupil$alex_quartil<- if_else(db_forBADA1_pupil$TAS<33, "1st",
                                         if_else(db_forBADA1_pupil$TAS>52, "2nd", "Mean"))
db_badia_nona <- bind_cols(db_forBADA1_pupil, db_forBADA1_hr[,3:58], db_forBADA1_scr[,3:58])

db_badia_nona1<- db_badia_nona[,c(1:2,59,3:58,60:171)]

table(is.na(db_badia_nona1))
```


```{r}
install.packages("TInPosition")
install.packages("ade4")
install.packages("TExPosition")
install.packages("MExPosition")
install.packages("ExPosition")
install.packages("prettyGraphs")

library(TInPosition)
library(MExPosition)

ExPosition::epPCA()

##PCA with Inference
# all.data <- read.csv("PCA_Dataset_2.csv",header=TRUE)
all.data<- db_badia_nona1

all.data$alex_quartil<- ifelse(all.data$TAS> median(all.data$TAS), "High", "Low")

colnames(all.data)

# rownames(all.data) <- all.data[,1]
# all.data_highlow<- subset(all.data, all.data$alex_quartil != "Mean")

table(is.na(all.data[,3]))
var.design <- as.factor(all.data$alex_quartil)
var.data <- all.data[,c(4:171)]

# Mexposition package missing
ade4

?TInPosition::tepDICA.inference.battery()

TInPosition::print.tepBADA.inference.battery()
TInPosition::pca
ExPosition::epPCA()

# oiginal
?epPCA.inference.battery
InPosition::
var.PCA.inf <-InPosition::epPCA.inference.battery(var.data, 
                                       scale = TRUE, 
                                       center = TRUE, 
                                       DESIGN = var.design, 
                                       make_design_nominal = FALSE, 
                                       graphs = TRUE, k = 0, 
                                       test.iters = 100, 
                                       constrained = FALSE, critical.value = 1.7)

?ExPosition::epPCA
?correlationPlotter
library(prettyGraphs)

var.PCA.inf <- ExPosition::epPCA(var.data1, scale = TRUE, center = TRUE, DESIGN = var.design, make_design_nominal = TRUE, graphs = TRUE, k = 0)


# let's try tinpositioinsta

install.packages('InPosition')

?epPCA.inference.battery

# var.PCA.inf <- InPosition::epPCA.inference.battery(var.data1, scale = TRUE, center = TRUE, DESIGN = var.design, make_design_nominal = TRUE, graphs = TRUE, k = 0, test.iters = 100, constrained = FALSE, critical.value = 2)


row.cols<- var.PCA.inf$Fixed.Data$Plotting.Data$fi.col
## Look at other dimensions
row.cols <- read.csv("row_cols.csv",header=TRUE)


# row.cols <- var.data[,2]

# row.cols<- all.data_highlow[,3]

x_axis <- 1
y_axis <- 2

var.PCA.inf$ExPosition.Data

tau <- var.PCA.inf$Fixed.Data$ExPosition.Data$t
p.val <- var.PCA.inf$Inference.Data$components$p.vals
xlab = paste("Component", x_axis, "Variance:",round(tau[x_axis],digits = 2),"%, ","p =",p.val[x_axis])
ylab = paste("Component", y_axis, "Variance:",round(tau[y_axis],digits = 2),"%, ","p =",p.val[y_axis])
main = "PCA with Inference"

pca.plot <- prettyPlot(var.PCA.inf$Fixed.Data$ExPosition.Data$fi,
x_axis=x_axis,
y_axis=y_axis,
col=row.cols,
pch=22,
cex=NULL,
text.cex=NULL,
pos=3,
xlab=xlab,ylab=ylab,main=main,display_names=FALSE,display_points=TRUE,
constraints=NULL,contributionCircles=TRUE,contributions=var.PCA.inf$Fixed.Data$ExPosition.Data$ci, axes=TRUE, fg.line.width=3,fg.type="l", fg.col="black",
bg.line.width=1.5, bg.lty=3, bg.col="black",flip=FALSE,asp=1, findBounds=TRUE,dev.new=TRUE,new.plot=TRUE)

## Barycentric Discriminant Analysis (BaDa)
# var.data <- all.data_highlow[,c(4:171)]

TInPosition::tepBADA.inference.battery()
# 
# table(is.na(var.data))
# na.omit(var.data)
# 
#  var.data$log1p_BIO_CDA.PhasicMax_9926
# 
#  
#  var.data %>%
#     select_if(~ any(is.infinite(.)))
#  
#  var.data1<- na.omit(var.data)
 
 
var.design<- as.factor(all.data_highlow$alex_quartil)


resBADA <- TExPosition::tepBADA(var.data, DESIGN = var.design, scale = TRUE,
                   graphs = FALSE)

colnames(var.data)
nrow(var.data)

?TInPosition::tepBADA.inference.battery

nrow(var.data_asd)
var.design
var.BADA.inf <- TInPosition::tepBADA.inference.battery(var.data_asd, 
                                                       scale = TRUE, 
                                                       center = TRUE, 
                                                       DESIGN = as.factor(var.design_asd), 
                                                       make_design_nominal = TRUE,
                                                       # force_bary = TRUE,
                                                       group.masses = NULL, 
                                                       weights = NULL, 
                                                       graphs = TRUE, 
                                                       k = 0, 
                                                       test.iters = 100, 
                                                       critical.value = 2)



# try tep bada
resBADA <-TExPosition::tepBADA(var.data, DESIGN = var.design, 
                               scale = FALSE,
                   graphs = TRUE)


resBADA.inf <- TInPosition::tepBADA.inference.battery(var.data, scale = FALSE,
                  DESIGN = var.design,
                  test.iters = 100,
                  graphs = FALSE)


resBADA$Plotting.Data

row.names(resBADA.inf$Inference.Data$loo.data$fixed.confuse) <- c("Low", "High")
colnames(resBADA.inf$Inference.Data$loo.data$fixed.confuse) <- c("Low", "High")
resBADA.inf$Inference.Data$loo.data$fixed.confuse

plot(resBADA.inf)


TInPosition::tinGraphs(resBADA.inf)
```


lets try including asd



```{r}
db_full6new_hr_fix_stim_select3<- db_full6new_hr_fix_stim_select2

# flag the multiple outliers in pupil scr arousal and heart rate

db_full6new_hr_fix_stim_select3$stimIAPS<- db_full6new_hr_fix_stim_select3$stim

db_full6new_hr_fix_stim_select3<- db_full6new_hr_fix_stim_select3%>%
  group_by(stimIAPS) %>%
  mutate(arousal_outler = if_else(arousal > (median(arousal, na.rm = TRUE) + 
                                               (4*mad(arousal, na.rm = TRUE))), TRUE,
         if_else(arousal < (median(arousal, na.rm = TRUE) - 
                              (4*mad(arousal, na.rm = TRUE))), TRUE, FALSE)))%>%
   mutate(valence_outler = if_else(valence > (median(valence, na.rm = TRUE) + 
                                               (4*mad(valence, na.rm = TRUE))), TRUE,
         if_else(valence < (median(valence, na.rm = TRUE) - 
                              (4*mad(valence, na.rm = TRUE))), TRUE, FALSE)))%>%
  group_by(ssid)%>%
   mutate(pupil_outlier = if_else(pup_basCor > (median(pup_basCor, na.rm = TRUE) 
                                                + (3*mad(pup_basCor, na.rm = TRUE))), TRUE,
         if_else(pup_basCor < (median(pup_basCor, na.rm = TRUE) - 
                                 (3*mad(pup_basCor, na.rm = TRUE))), TRUE, FALSE)))%>%
    mutate(BIO_CDA.PhasicMax_z = scale(BIO_CDA.PhasicMax))%>%
  mutate(BIO_CDA.PhasicMax_z_outl = if_else(abs(BIO_CDA.PhasicMax_z)> 3, TRUE, FALSE))%>%
  ungroup()%>%
  mutate(arousal_c = scale(arousal, center = TRUE, scale = TRUE)[,1],
         valence_c = scale(valence, center = TRUE, scale = TRUE)[,1],
         # Mean_gray_z = scale(Mean)[,1],
         TASc = scale(TAS)[,1],
         AQc = scale(AQ)[,1],
         BPQc = scale(BPQ)[,1],
         WASIM_c =scale(WASIM)[,1],
         DASSTotalc = scale(DASSTotal)[,1])


# is there is at least one outlier in HR, SCR or pupil flag true

db_full6new_hr_fix_stim_select3$Bio_Mean_HR_dif_outl2<- if_else(db_full6new_hr_fix_stim_select3$Bio_Mean_HR_dif_outl == "outlier", TRUE, FALSE)


colnames(db_full6new_hr_fix_stim_select3)




```
db_full6new_hr_fix_stim_select3

BADIA

```{r}

db_full6new_hr_fix_stim_select3
db_full6new_hr_fix_stim_select3

# reformat
colnames(db_full6new_hr_fix_stim_select3)

db_full6new_hr_fix_stim_select3$log1p_BIO_CDA.PhasicMax<- log1p(db_full6new_hr_fix_stim_select3$BIO_CDA.PhasicMax+.1)

# select only necessary columns


db_full6new_hr_fix_stim_select3$stimIAPS2<- substr(db_full6new_hr_fix_stim_select3$stimIAPS, 1,4)

db_full6new_hr_fix_stim_select4 <- select(db_full6new_hr_fix_stim_select3,
                                                      c(ssid, Group, stimIAPS, stimIAPS2, stimDescription, TAS, pup_basCor, Bio_Mean_HR_dif, log1p_BIO_CDA.PhasicMax))


db_full6new_hr_fix_stim_select4<- subset(db_full6new_hr_fix_stim_select4,!is.na(stimDescription))
unique(db_full6new_hr_fix_stim_select4$stimIAPS)

db_full6new_hr_fix_stim_select4$stimIAPS2<- substr(db_full6new_hr_fix_stim_select4$stimIAPS, 1,4)

factor(db_full6new_hr_fix_stim_select4$stimIAPS2)

# reshape
colnames(db_full6new_hr_fix_stim_select4)


db_full6new_hr_fix_stim_select4<- subset(db_full6new_hr_fix_stim_select4, !is.na(Group))

colnames(db_full6new_hr_fix_stim_select4)

# fill in NA with average per individual
# - not working
# are things being recognised as something otehr than NA, eg NaN
table(is.nan(db_full6new_hr_fix_stim_select4))

db_full6new_hr_fix_stim_select4[db_full6new_hr_fix_stim_select4 == "NaN"] <- NA

# seems like it

db_full6new_hr_fix_stim_select5 <- db_full6new_hr_fix_stim_select4 %>%
  group_by(ssid)%>%
  mutate(ssid_pup_basCor_mean = mean(pup_basCor, na.rm = TRUE), 
         ssid_Bio_Mean_HR_dif_mean = mean(Bio_Mean_HR_dif, na.rm = TRUE),
         ssid_log1p_BIO_CDA.PhasicMax_mean = mean(log1p_BIO_CDA.PhasicMax, na.rm = TRUE))%>%
  mutate(pup_basCor = if_else(is.na(pup_basCor) == TRUE, ssid_pup_basCor_mean, pup_basCor))%>%
  mutate(Bio_Mean_HR_dif = if_else(is.na(Bio_Mean_HR_dif) == TRUE, ssid_Bio_Mean_HR_dif_mean, Bio_Mean_HR_dif))%>%
  mutate(log1p_BIO_CDA.PhasicMax = if_else(is.na(log1p_BIO_CDA.PhasicMax) == TRUE, ssid_log1p_BIO_CDA.PhasicMax_mean, log1p_BIO_CDA.PhasicMax)) 


nrow(db_full6new_hr_fix_stim_select5)

library(data.table)
?dcast

db_forBADA2 <- data.table::dcast(setDT(db_full6new_hr_fix_stim_select5), 
                    ssid +TAS+ Group ~ stimIAPS2, value.var = c('pup_basCor',
                'Bio_Mean_HR_dif', 'log1p_BIO_CDA.PhasicMax'),fun.aggregate = mean)



table(is.na(db_forBADA2))
View(db_forBADA2)
na.omit(db_forBADA2)


db_forBADA2 %>%
    select_if(~ any(is.na(.)))

table(is.na(db_forBADA2$log1p_BIO_CDA.PhasicMax_9472))

# try to fill means rowwise
colnames(db_forBADA2)

db_forBADA2_pupil<- db_forBADA2[,3:58]
# table(is.na(db_forBADA1_pupil$TAS))

k <- which(is.na(db_forBADA2_pupil), arr.ind=TRUE)
k

# db_forBADA1_pupil$ssid<- as.numeric(as.character(db_forBADA1_pupil$ssid))
db_forBADA2_pupil[k] <- rowMeans(db_forBADA2_pupil, na.rm=TRUE)[k[,1]]

# hr
db_forBADA2_hr<- db_forBADA2[,c(59:114)]
# table(is.na(db_forBADA1_pupil$TAS))

k <- which(is.na(db_forBADA2_hr), arr.ind=TRUE)
k

db_forBADA2_hr[k] <- rowMeans(db_forBADA2_hr, na.rm=TRUE)[k[,1]]

db_forBADA2_hr

# scr
colnames(db_forBADA2)
db_forBADA2_scr<- db_forBADA2[,115:170]
# table(is.na(db_forBADA1_pupil$TAS))

k <- which(is.na(db_forBADA2_scr), arr.ind=TRUE)
k

db_forBADA2_scr[k] <- rowMeans(db_forBADA2_scr, na.rm=TRUE)[k[,1]]

db_forBADA2_scr



# bind
db_badia2_nona <- bind_cols(db_forBADA2[,1:2], db_forBADA2_pupil, db_forBADA2_hr, db_forBADA2_scr)


```



```{r}

install.packages("TInPosition")
install.packages("ade4")
install.packages("TExPosition")
install.packages("MExPosition")
install.packages("ExPosition")
install.packages("prettyGraphs")

library(TInPosition)
library(MExPosition)

ExPosition::epPCA()

##PCA with Inference
# all.data <- read.csv("PCA_Dataset_2.csv",header=TRUE)
all.data_asd<- db_badia2_nona

all.data_asd <- na.omit(all.data_asd)
# rownames(all.data) <- all.data[,1]
# all.data_highlow<- subset(all.data, all.data$alex_quartil != "Mean")

var.design_tas<- all.data_asd
# nrow(new.data)

nrow(db_forBADA2)
nrow(all.data_asd)
na.omit(var.design_tas)


var.design_tas<- if_else(db_forBADA2$TAS> median(db_forBADA2$TAS, na.rm = TRUE), "High", "Low")
var.design_asd <- as.factor(tasy_agg$Alex_median)
var.data_asd <- all.data_asd[,c(3:170)]


tasy_agg<- new.data3 %>%
group_by(ssid,Alex_median)%>%
  summarise_at(c("TAS.y"), mean, na.rm = TRUE)

na.omit(var.data_asd)
# Mexposition package missing
ade4

?TInPosition::tepDICA.inference.battery()

TInPosition::print.tepBADA.inference.battery()
TInPosition::pca
ExPosition::epPCA()

# oiginal
?InPosition::epPCA.inference.battery
?correlationPlotter
library(prettyGraphs)
?InPosition::epPCA.inference.battery
var.PCA.inf_asd <-InPosition::epPCA.inference.battery(var.data_asd, 
                                       scale = TRUE, 
                                       center = TRUE, 
                                       DESIGN = var.design_tas,
                                       make_design_nominal = TRUE, 
                                       graphs = TRUE, k = 0, 
                                       test.iters = 1000, 
                                       constrained = FALSE, critical.value = 2)

?ExPosition::epPCA

ExPosition::epGraphs(var.PCA.inf_asd$Fixed.Data$Plotting.Data)

var.PCA.inf_asd

var.PCA.inf_asd$Inference.Data$components$p.vals
var.PCA.inf_asd$Inference.Data$fj.boots$boots

sum(var.PCA.inf_asd$Fixed.Data$ExPosition.Data$t) #explained variuances
# 
# color<- bind_rows(as.data.frame(rep("#305ABF", 56)),as.data.frame(rep("#84BF30", 56)),as.data.frame(rep("#84BF30", 56)))
# 
# rep("#84BF30", 56)
# rep("red", 56)

row.cols <- read.csv("row_cols.csv",header=TRUE)
row.cols <- row.cols[,2]
x_axis <- 1
y_axis <- 2
tau <- var.PCA.inf_asd$Fixed.Data$ExPosition.Data$t # variance
p.val <- var.PCA.inf_asd$Inference.Data$components$p.vals
xlab = paste("Component", x_axis, "Variance:",round(tau[x_axis],digits = 2),"%, ","p =",p.val[x_axis])
ylab = paste("Component", y_axis, "Variance:",round(tau[y_axis],digits = 2),"%, ","p =",p.val[y_axis])
main = "PCA with Inference"

var.PCA.inf_asd$Inference.Data$components$eigs.perm
?prettyPlot

write_csv("var.PCA.inf_asd_forpca.csv", var.data_asd)
pca.plot <- prettyGraphs::prettyPlot(var.PCA.inf_asd$Fixed.Data$ExPosition.Data$fi,
                       x_axis=x_axis,
                       y_axis=y_axis,
                       col=var.design_tas,
                       pch=22,
                       cex=NULL,
                       text.cex=NULL,
                       pos=3,

                       xlab=xlab,
                       ylab=ylab,
                       main=main,
                       display_names=TRUE,
                       display_points=TRUE,
                       constraints=NULL,
                       contributionCircles=TRUE,
                       contributions=var.PCA.inf_asd$Fixed.Data$ExPosition.Data$ci, 
                       axes=TRUE, 
                       fg.line.width=3,
                       fg.type="l", 
                       fg.col="black",
                       bg.line.width=1.5, 
                       bg.lty=3, 
                       bg.col="black",
                       flip=FALSE,asp=1, 
                       findBounds=TRUE,
                       dev.new=TRUE,
                       new.plot=TRUE)
?prettyGraphs::correlationPlotter()


prettyGraphs::correlationPlotter(var.data_asd,
  var.PCA.inf_asd$Fixed.Data$ExPosition.Data$fi,
  col= var.design_asd,
                       pch=22,
                       # cex=NULL,
                       # text.cex=NULL,
                       # pos=3,

                       xlab=xlab,
                       ylab=ylab,
                       main=main
                       # display_names=TRUE,
                       # display_points=TRUE,
                       # constraints=NULL,
                       # contributionCircles=TRUE,
                       # contributions=var.PCA.inf_asd$Fixed.Data$ExPosition.Data$ci, 
                       # axes=TRUE, 
                       # fg.line.width=3,
                       # fg.type="l", 
                       # fg.col="black",
                       # bg.line.width=1.5, 
                       # bg.lty=3, 
                       # bg.col="black",
                       # flip=FALSE,asp=1, 
                       # findBounds=TRUE,
                       # dev.new=TRUE,
                       # new.plot=TRUE
                                 )



summary(var.PCA.inf_asd)

var.PCA.inf_asd$Inference.Data$components$eigs

plot(var.PCA.inf_asd$Inference.Data$components$eigs)

# return just componet 1
var.PCA.inf_asd[["Inference.Data"]][["fj.boots"]][["boots"]]
as.data.frame(var.PCA.inf_asd$Inference.Data$fj.boots$boots)
test<- var.PCA.inf_asd$Inference.Data$fj.boots$boots
is.matrix(test)
is.list(test)

boottest <- as.data.frame(var.PCA.inf_asd$Inference.Data$fj.boots$tests$boot.ratios[,1:2])
boottest$stimIAPS<- row.names(boottest)
boottest

boottest$stimIAPS2<- sub('.*\\_', '', boottest$stimIAPS)

# merge descriptiopns
nrow(boottest)
nrow(new.data3)

db_full6new_hr_fix_stim_select5.3

stimiapstomerge<- new.data3 %>%
  subset(!is.na(stimDescription))%>%
  group_by(stimIAPS2,stimDescription)%>%
  summarise_at(c("arousal", "valence", "ValenceMean", "ArousalMean",
                 "log1p_BIO_CDA.PhasicMax",
                 "pup_basCor",
                 "Bio_Mean_HR_dif"), mean, na.rm = TRUE)
new.data3$stimIAPS2

boottest1 <- left_join(boottest, stimiapstomerge)

boottest1$variable_stim<- boottest1$stimIAPS
boottest1$variable_stim2<- substr(boottest1$variable_stim,1,9)

# return the name of the column witha  maximum value above 2
apply(df[,-1],1,function(x) names(df[,-1])[which(x>0.33)])

boottest1$PC<- apply(boottest1[,1:2],1,function(x) names(boottest1[,1:2])[which(abs(x)>2)] 
      [which(abs(x) == max(abs(x)))])
# boottest1$PC<- if_else()

boottest1%>%
  subset(PC == "V1")%>%
  arrange(V1)%>%
  ggplot(aes(arousal))+
  geom_density(fill = "blue", alpha = .1)+
  geom_density(aes(x = valence), fill = "red", alpha = .4)+
  p$graphstyle


boottest1%>%
  subset(PC = "V2")%>%
  arrange(V2)%>%
  ggplot(aes(arousal))+
  geom_density(fill = "blue", alpha = .1)+
  geom_density(aes(x = 0-valence), fill = "red", alpha = .4)+
  p$graphstyle
  



unique(boottest1$PC)
# 
# unique(boottest$stimIAPS2)
# test[1:168,1,mean(1:1000)]

boottest1%>%
  subset(PC == "V1")%>%
  arrange(V1)


boottest1 %>%
  subset(!is.na(PC))%>%
  group_by(PC,stimIAPS2,stimDescription)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(PC, arousal))+
   geom_jitter(width = .1, alpha = .2)+
  geom_text(aes(label = stimDescription))+
  stat_summary(geom= "pointrange")+ggpubr::stat_compare_means()

boottest1%>%
  subset(!is.na(PC))%>%
   group_by(PC,stimIAPS2,stimDescription)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(PC, valence))+
  geom_jitter(width = .1, alpha = .2)+
  geom_text(aes(label = stimDescription))+
  stat_summary(geom= "pointrange")+
  ggpubr::stat_compare_means()


boottest1%>%
  subset(!is.na(PC))%>%
   group_by(PC,stimIAPS2,stimDescription)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(PC, log1p_BIO_CDA.PhasicMax))+
  geom_jitter(width = .1, alpha = .2)+
  # geom_text(aes(label = stimDescription))+
  stat_summary(geom= "pointrange")+
  ggpubr::stat_compare_means()


boottest1%>%
  subset(!is.na(PC))%>%
   group_by(PC,stimIAPS2,stimDescription)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(PC, pup_basCor))+
  geom_jitter(width = .1, alpha = .2)+
  # geom_text(aes(label = stimDescription))+
  stat_summary(geom= "pointrange")+
  ggpubr::stat_compare_means()


boottest1%>%
  subset(!is.na(PC))%>%
   group_by(PC,stimIAPS2,stimDescription)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(PC, Bio_Mean_HR_dif))+
  geom_jitter(width = .1, alpha = .2)+
  # geom_text(aes(label = stimDescription))+
  stat_summary(geom= "pointrange")+
  ggpubr::stat_compare_means()


boottest1%>%
  subset(!is.na(PC))%>%
   group_by(PC,stimIAPS2,stimDescription)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(PC, V2))+
  geom_jitter(width = .1, alpha = .2)+
  geom_text(aes(label = stimDescription))+
  stat_summary(geom= "pointrange")+
  ggpubr::stat_compare_means()


boottest1%>%
  subset(is.na(PC) == TRUE)%>%
  group_by(PC,stimIAPS2,stimDescription)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(PC, arousal))+
  # geom_jitter(width = .1, alpha = .2)+
  geom_text(aes(label = stimDescription))+
  stat_summary(geom= "pointrange")+
  ggpubr::stat_compare_means()
```

# store factor scores
```{r}
var.PCA.inf_asd[["Fixed.Data"]][["ExPosition.Data"]][["cj"]][,1:3]


```
score_test <-var.PCA.inf_asd[["Fixed.Data"]][["ExPosition.Data"]][["fi"]][,1:3]
var.PCA.inf_asd


```{r}
library(ggplot2)
library(tidyverse)
# I think this is storing the first 2
as.data.frame(score_test)%>%
  ggplot(aes(V1, V2))+
  geom_point(aes(color = var.design_asd))

# now bidn this to dataset
# all.data_a

# store pcs on the data
var.data_asd_with2pcs$PC1 <- score_test[,1]
var.data_asd_with2pcs$PC2 <- score_test[,2]
var.data_asd_with2pcs$PC2 <- score_test[,2]

all.data_asd$PC1 <- score_test[,1]
all.data_asd$PC2 <- score_test[,2]
all.data_asd$PC3 <- score_test[,3]

# now try kmeans on the components
all.data_asd2pcs<- all.data_asd

# var.data_asd_with2pcs

colnames(all.data_asd2pcs)
all.data_asd2pcs_forkmean<- all.data_asd2pcs[,c(1,2,171:173)]
# Feature Scaling
# training_set = scale(training_set)
# test_set = scale(test_set)

# Using the elbow method to find the optimal number of clusters
set.seed(1)
wcss = vector()
for (i in 1:10) wcss[i] = sum(kmeans(scaled_all.data_asd2pcs_forkmean, i)$withinss)
plot(1:10,
     wcss,
     type = 'b',
     main = paste('The Elbow Method'),
     xlab = 'Number of clusters',
     ylab = 'WCSS')

# 3 or 2

# Fitting K-Means to the dataset
set.seed(25)

?kmeans
kmeans_res = kmeans(x = scaled_all.data_asd2pcs_forkmean, centers = 2)
y_kmeans = kmeans_res$cluster
rm(kmeans)

install.packages("factoextra")

?factoextra::fviz_nbclust
factoextra::fviz_nbclust(scaled_all.data_asd2pcs_forkmean$PC2, 
                         kmeans, 
                         method='silhouette')

# Visualising the clusters
# install.packages("cluster")
library(cluster)

# ?clusplot

clust_dataset_scaled
y_kmeans

scaled_all.data_asd2pcs_forkmean$y_kmeans<- y_kmeans

# all.data_asd2pcs_forkmean$TAS<- all.data

mean(all.data_asd2pcs_forkmean$PC1)
sd(all.data_asd2pcs_forkmean$PC1)
mean(all.data_asd2pcs_forkmean$PC2)
sd(all.data_asd2pcs_forkmean$PC2)
scaled_all.data_asd2pcs_forkmean <- as.data.frame(scale(all.data_asd2pcs_forkmean[,3:4])[,1:2])

?cluster::clusplot()
clust_plotalkmean<- clusplot(scaled_all.data_asd2pcs_forkmean,
         scaled_all.data_asd2pcs_forkmean$y_kmeans,
         lines = 2,
         shade = TRUE,
         color = TRUE,
         labels = 1,
         plotchar = FALSE,
         span = TRUE
         # label = 
         # main = paste('Clusters of customers'),
         # xlab = 'Annual Income',
         # ylab = 'Spending Score'
         )


pca_res <- prcomp(clustering_agg[,c(25,24,20)], center = TRUE, scale. = TRUE)
pca_res <- prcomp(clustering_agg_JASPtest[,c(24,23,19)], center = TRUE, scale. = TRUE)
plot_data <- cbind(as.data.frame(pca_res$x[, 1:2]), labels = clustering_agg$y_kmeans)

plot_data_kmeanpca<- scaled_all.data_asd2pcs_forkmean$ssid
scaled_all.data_asd2pcs_forkmean


scaled_all.data_asd2pcs_forkmean

all.data_asd2.1$TAS
all.data_asd2.1$ssid
scaled_all.data_asd2pcs_forkmean$ssid

scaled_all.data_asd2pcs_forkmean$TAS<- all.data_asd2.1$TAS
# plot_data$

colnames(all.data_asd2.1)

# all.data_asd2pcs2.1_forkmean$
# left_join(scaled_all.data_asd2pcs_forkmean,all.data_asd2.1[,1:2], by = "ssid")%>%
  all.data_asd2pcs2.1_forkmean%>%
ggplot(aes(x = PC1, y = PC2, colour = as.factor(y_kmeans), fill = as.factor(y_kmeans))) +
  geom_point(size = 2, alpha = .4)+
  geom_text(aes(label= ssid))+
  stat_ellipse(show.legend = TRUE)+
  ylab("Componet 2")+
  xlab("Component 1")+
  scale_color_brewer(palette= "Dark2")+
  scale_fill_brewer(palette= "Dark2")+   
  # scale_color_manual(values = c("red", "green", "blue"))+
  p$graphstyle+
  theme()

```

```{r}
plot_datakmeans$tot.withinss/kmeans$totss

kmeans$tot.withinss/ kmeans$betweenss
(kmeans$tot.withinss + kmeans$betweenss)/kmeans$totss
db_full6new_hr_fix_stim_select5

# 
ssid_tasaq<- db_full6new_hr_fix_stim_select3%>%
  group_by(ssid, Group)%>%
  summarise_at(c('TAS', 'AQ'), mean, na.rm = TRUE)
# ssid_tas_aq<- select(db_full6new_hr_fix_stim_select3, c(ssid, TAS))

scaled_all.data_asd2pcs_forkmean$ssid<- all.data_asd2pcs_forkmean$ssid

left_join(scaled_all.data_asd2pcs_forkmean ,ssid_tasaq)%>%
  ggplot(aes(as.factor(y_kmeans), AQ))+
  stat_summary(geom = "pointrange")+
  geom_text(aes(label = ssid), alpha = .1)+
  ggpubr::stat_compare_means()

kmeans$ifault
left_join(scaled_all.data_asd2pcs_forkmean ,ssid_tasaq)%>%
  ggplot(aes(as.factor(y_kmeans), TAS))+
  stat_summary(geom = "pointrange")+
  geom_text(aes(label = ssid), alpha = .1)

?  ggpubr::stat_compare_means()

left_join(scaled_all.data_asd2pcs_forkmean ,ssid_tasaq)%>%
  # subset(Group == "NT")%>%
  ggplot(aes(as.factor(y_kmeans), TAS))+
  stat_summary(geom = "pointrange")+
  # geom_text(aes(label = ssid), alpha = .1)+
  ggpubr::stat_compare_means(method = "t.test")


```


scaled_all.data_asd2pcs_forkmean$PC3<- all.data_asd2pcs_forkmean$PC3

scaled_all.data_asd2pcs_forkmean2<- left_join(scaled_all.data_asd2pcs_forkmean ,ssid_tasaq)

table(scaled_all.data_asd2pcs_forkmean2$Group, scaled_all.data_asd2pcs_forkmean2$y_kmeans)

scaled_all.data_asd2pcs_forkmean2$alex_median<- if_else(scaled_all.data_asd2pcs_forkmean2$TAS> median(scaled_all.data_asd2pcs_forkmean2$TAS, na.rm = TRUE), "High", "Low")


table(scaled_all.data_asd2pcs_forkmean2$alex_median, scaled_all.data_asd2pcs_forkmean2$y_kmeans)


scaled_all.data_asd2pcs_forkmean2%>%
  ggplot(aes(as.factor(y_kmeans), TAS))+
  stat_summary(geom = "pointrange")+
  geom_text(aes(label = ssid), alpha = .1)+
  facet_grid(~alex_median)

scaled_all.data_asd2pcs_forkmean2$km_gr<- paste0(scaled_all.data_asd2pcs_forkmean2$y_kmeans, paste0(scaled_all.data_asd2pcs_forkmean2$Group))

scaled_all.data_asd2pcs_forkmean2%>%
  ggplot(aes(km_gr, TAS))+
  stat_summary(geom = "pointrange")+
  geom_text(aes(label = ssid), alpha = .1)
  facet_grid(~alex_median)
  
  
  # flag just the sigmificant variables
  # subset to keep the varioables that came sgnificant ut of the infernce PCA for either of the first 2 or 3 dimmensions
  signiftestpca_df<- as.data.frame(signiftestpca)
  signiftestpca1_2<- signiftestpca_df%>%
                            any(~(V1, V2) == TRUE)
  
  unique(signiftestpca1_2$V1)
  unique(signiftestpca1_2$V2)  
  
  new.data <- signiftestpca_df[ which( signiftestpca_df$V1 == TRUE | signiftestpca_df$V2 == TRUE) , ]
  
  
  unique(new.data$V1)
  unique(new.data$V2)
  
  View(new.data)
  
  new.data
  new.data$pca_v1_v2<- paste0(new.data$V1, paste0(new.data$V2))
  unique( new.data$pca_v1_v2)
  new.data1<- select(new.data, c(V1, V2, V3, pca_v1_v2))
  
  # store row name into a variable
  new.data1$variable<- rownames(new.data1)
  
  
  # extract pattern after the last underscore
     new.data1$stimIAPS2<- sub('.*\\_', '', new.data1$variable)
  new.data1$stimIAPS2
  
    new.data1$InPCA<- "YES"
    
    scaled_all.data_asd2pcs_forkmean2
    
    new.data1
     unique( new.data1$pca_v1_v2)


# merge this back with the full data
        db_full6new_hr_fix_stim_select5
        
        unique(scaled_all.data_asd2pcs_forkmean2$ssid)
  kmean_pca_longdata  <- left_join(scaled_all.data_asd2pcs_forkmean2, db_full6new_hr_fix_stim_select3, 
                                   by = c("ssid", "Group"))
  
  kmean_pca_longdata
  
 # new.data2 <- new.data1%>%
 #    arrange(stimIAPS2)%>%
 #    subset(!duplicated(stimIAPS2))
 
 new.data2<- new.data1
 
 unique( new.data2$pca_v1_v2)
 
 unique(new.data2)
 unique(kmean_pca_longdata$ssid)
 
 kmean_pca_longdata
new.data3<- left_join( new.data2,kmean_pca_longdata)
  # left_join( new.data2,kmean_pca_longdata) %>%

unique(new.data3$pca_v1_v2)


V3

all.data_asd2pcs_forkmean
new.data3$PC3<- all.data_asd2pcs_forkmean$PC3


# this is however takling all the data not only the data PCA deemed to be imorttant

new.data3$pca_v1_v2

unique(new.data3$stimIAPS2)
unique(new.data3$pca_v1_v2)

```{r}
new.data3 %>%
  # subset(Group == "NT")%>%
  subset(ssid!=336)%>%
    group_by(ssid, Group)%>%
    summarise_if(is.numeric, mean, na.rm = TRUE)%>%
    ggplot(aes( AQ.y, PC1))+
  geom_point()+
  geom_smooth(method = 'lm', se = F)+
  geom_text(aes(label = ssid))+
  ggpubr::stat_cor()+
    stat_ellipse()

?  ggpubr::stat_cor

new.data3 %>%
  # subset(Group == "NT")%>%
  subset(ssid!=336)%>%
    group_by(ssid, Group)%>%
    summarise_if(is.numeric, mean, na.rm = TRUE)%>%
    ggplot(aes( TAS.y, PC1))+
  geom_point()+
  geom_smooth(method = 'lm', se = F)+
  geom_text(aes(label = ssid))+
  ggpubr::stat_cor()+
    # stat_ellipse()+
  p$graphstyle

install.packages("ppcor")


new.data3.1<- new.data3 %>%
  # subset(Group == "NT")%>%
  subset(ssid!=336)

new.data3.2<- subset(new.data3.1, !is.na(TAS.x))

scaled_all.data_asd2pcs_forkmean_forcor<- left_join(scaled_all.data_asd2pcs_forkmean ,ssid_tasaq)

scaled_all.data_asd2pcs_forkmean_forcor_nona<- subset(scaled_all.data_asd2pcs_forkmean_forcor, !is.na(TAS))
ppcor::pcor.test(scaled_all.data_asd2pcs_forkmean_forcor_nona$TAS, scaled_all.data_asd2pcs_forkmean_forcor_nona$PC1, scaled_all.data_asd2pcs_forkmean_forcor_nona$AQ)

ppcor::pcor.test(scaled_all.data_asd2pcs_forkmean_forcor_nona$AQ, scaled_all.data_asd2pcs_forkmean_forcor_nona$PC1, scaled_all.data_asd2pcs_forkmean_forcor_nona$TAS) #not significanr

# exclude 336
scaled_all.data_asd2pcs_forkmean_forcor_nona1<- scaled_all.data_asd2pcs_forkmean_forcor_nona%>%
  subset(ssid!=336)


ppcor::pcor.test(scaled_all.data_asd2pcs_forkmean_forcor_nona1$TAS, scaled_all.data_asd2pcs_forkmean_forcor_nona1$PC1, scaled_all.data_asd2pcs_forkmean_forcor_nona1$AQ)

ppcor::pcor.test(scaled_all.data_asd2pcs_forkmean_forcor_nona1$AQ, scaled_all.data_asd2pcs_forkmean_forcor_nona1$PC1, scaled_all.data_asd2pcs_forkmean_forcor_nona1$TAS)
  


ppcor::pcor.test(AQ, PC1, TAS) 

pcor(test_teoPi,method="spearman")$estimate
      
```
      
      new.data3$Alex_median<- if_else(new.data3$TAS.x> median(new.data3$TAS.x, na.rm = TRUE), "High", "Low")
      
      new.data3 %>%
      
        subset(ssid!=336)%>%
        subset(!is.na(TAS.x))%>%
    group_by(ssid, Alex_median)%>%
    summarise_if(is.numeric, mean, na.rm = TRUE)%>%
    ggplot(aes( Alex_median, PC3))+
          stat_summary(geom = "pointrange")+
  # geom_point()+
  geom_smooth(method = 'lm', se = F)+
  geom_text(aes(label = ssid))+
        ylim(-1.6, 2.5)+
  ggpubr::stat_compare_means()
    # stat_ellipse()
  # stat_summary(geom = 'pointrange')+
      geom_jitter(alpha = .1, width = .1)+
  



```{r}
new.data3$PCAsolution<- paste0(new.data3$V1, paste0(new.data3$V2))

unique(new.data3$PCAsolution)
# show the average cluster profile

new.data3 %>%
    group_by(ssid, Group, km_gr, y_kmeans, V1, V2)%>%
    summarise_if(is.numeric, mean, na.rm = TRUE)%>%
    ggplot(aes(as.factor(y_kmeans), pup_basCor, color = V1))+
  stat_summary(geom = 'pointrange')+
    # geom_jitter(alpha = .1, width = .1)
    facet_grid(Group~V2)


new.data3 %>%
  # group_by(ssid)%>%
  # mutate()
    group_by(ssid, Group, km_gr, y_kmeans, V1, V2)%>%
    summarise_if(is.numeric, mean, na.rm = TRUE)%>%
    ggplot(aes(as.factor(y_kmeans), log1p_BIO_CDA.PhasicMax, color = V1))+
  stat_summary(geom = 'pointrange')+
    # geom_jitter(alpha = .1, width = .1)
    facet_grid(Group~V2)


new.data3 %>%
  # group_by(ssid)%>%
  # mutate()
    group_by(ssid, alex_median, y_kmeans, V1, V2)%>%
    summarise_if(is.numeric, mean, na.rm = TRUE)%>%
    ggplot(aes(as.factor(y_kmeans), Bio_Mean_HR_dif, color = V1))+
  stat_summary(geom = 'pointrange')+
    # geom_jitter(alpha = .1, width = .1)
    facet_grid(alex_median~V2)


new.data3%>%
  gather()

gather(new.data3, key = "measurement", value = "value",
       pup_basCor, Bio_Mean_HR_dif,log1p_BIO_CDA.PhasicMax, -ssid, - y_kmeans, -pca_v1_v2,-alex_median)%>%
  subset(!is.na(alex_median))%>%
  group_by(ssid)%>%
  mutate(value1 = scale(value))%>%
  ggplot(aes(measurement,value1, color = as.factor(pca_v1_v2)))+
  stat_summary(geom = "pointrange")+
  facet_grid(alex_median~y_kmeans)


gather(new.data3, key = "measurement", value = "value",
       pup_basCor, Bio_Mean_HR_dif,log1p_BIO_CDA.PhasicMax, -ssid, - y_kmeans, -pca_v1_v2)%>%
  group_by(ssid,measurement)%>%
  mutate(value1 = scale(value))%>%
  ggplot(aes(measurement,SacAmp, color = as.factor(pca_v1_v2)))+
  stat_summary(geom = "pointrange")+
  facet_grid(~y_kmeans)
unique(new.data3$ssid)


# compare them on the scores components
gather(new.data3, key = "measurement", value = "value",
       PC1, PC2, -ssid, - y_kmeans, -pca_v1_v2)%>%
  group_by(ssid,y_kmeans,measurement)%>%
  # mutate(value1 = scale(value))%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(as.factor(y_kmeans),value))+
  geom_jitter(width = .1, alpha = .2)+
  stat_summary(geom = "pointrange")+
  geom_boxplot(alpha = .1)+
  facet_grid(~measurement)+
  ggpubr::stat_compare_means()
unique(new.data3$ssid)

gather(new.data3, key = "measurement", value = "value",
       PC1, PC2, -ssid, - y_kmeans, -pca_v1_v2)%>%
  subset(Group == "NT")%>%
  group_by(ssid,y_kmeans,measurement)%>%
  # mutate(value1 = scale(value))%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  
  ggplot(aes(as.factor(y_kmeans),AQ.x))+
  geom_jitter(width = .1, alpha = .2)+
  stat_summary(geom = "pointrange")+
  geom_boxplot(alpha = .1)+
  facet_grid(~measurement)+
  ggpubr::stat_compare_means()


unique(new.data3$PC1)
new.data3%>%
  
```


try and aggregate trials so we have less variables than

also remove missing tas

```{r}

db_full6new_hr_fix_stim_select3

# create categories based on ground valence
db_full6new_hr_fix_stim_select3$ValenceGround_cut<- cut(db_full6new_hr_fix_stim_select3$ValenceMean,3)

# reformat
colnames(db_full6new_hr_fix_stim_select3)

# select only necessary columns

db_full6new_hr_fix_stim_select4.1 <- select(db_full6new_hr_fix_stim_select3,
                                                      c(ssid, Group, stimIAPS, stimIAPS2, stimDescription,ValenceGround_cut, TAS, pup_basCor, Bio_Mean_HR_dif, log1p_BIO_CDA.PhasicMax))

# subset out missing stim descrioption and tas
db_full6new_hr_fix_stim_select4.1<- db_full6new_hr_fix_stim_select4.1%>%
  subset(!is.na(stimDescription))%>%
  subset(!is.na(TAS))

unique(db_full6new_hr_fix_stim_select4.1$stimIAPS)

db_full6new_hr_fix_stim_select4.1$stimIAPS2<- substr(db_full6new_hr_fix_stim_select4.1$stimIAPS, 1,4)

factor(db_full6new_hr_fix_stim_select4$stimIAPS2)

# reshape
colnames(db_full6new_hr_fix_stim_select4.1)


db_full6new_hr_fix_stim_select4.1 <- subset(db_full6new_hr_fix_stim_select4.1, !is.na(Group))

colnames(db_full6new_hr_fix_stim_select4.1)

# fill in NA with average per individual
# - not working
# are things being recognised as something otehr than NA, eg NaN
db_full6new_hr_fix_stim_select4.1[db_full6new_hr_fix_stim_select4.1 == "NaN"] <- NA

# seems like it
# no need for this as well be computing averages
db_full6new_hr_fix_stim_select5.1 <- db_full6new_hr_fix_stim_select4.1 %>%
  group_by(ssid)%>%
  mutate(ssid_pup_basCor_mean = mean(pup_basCor, na.rm = TRUE), 
         ssid_Bio_Mean_HR_dif_mean = mean(Bio_Mean_HR_dif, na.rm = TRUE),
         ssid_log1p_BIO_CDA.PhasicMax_mean = mean(log1p_BIO_CDA.PhasicMax, na.rm = TRUE))%>%
  mutate(pup_basCor = if_else(is.na(pup_basCor) == TRUE, ssid_pup_basCor_mean, pup_basCor))%>%
  mutate(Bio_Mean_HR_dif = if_else(is.na(Bio_Mean_HR_dif) == TRUE, ssid_Bio_Mean_HR_dif_mean, Bio_Mean_HR_dif))%>%
  mutate(log1p_BIO_CDA.PhasicMax = if_else(is.na(log1p_BIO_CDA.PhasicMax) == TRUE, ssid_log1p_BIO_CDA.PhasicMax_mean, log1p_BIO_CDA.PhasicMax)) 

# compute averages
db_full6new_hr_fix_stim_select5.1 <- db_full6new_hr_fix_stim_select4.1 %>%
  group_by(ssid,ValenceGround_cut)%>%
  mutate(pup_basCor_avg = mean(pup_basCor, na.rm = TRUE),
         Bio_Mean_HR_dif_avg = mean(Bio_Mean_HR_dif, na.rm = TRUE),
         log1p_BIO_CDA.PhasicMax_avg = mean(log1p_BIO_CDA.PhasicMax, na.rm = TRUE))


nrow(db_full6new_hr_fix_stim_select5.1)

library(data.table)
?dcast
db_full6new_hr_fix_stim_select5.2<- select(db_full6new_hr_fix_stim_select5.1, 
                                           c(ssid, TAS, Group,ValenceGround_cut, stimIAPS2,
                                             pup_basCor_avg,
                                             Bio_Mean_HR_dif_avg,
                                             log1p_BIO_CDA.PhasicMax_avg))

db_full6new_hr_fix_stim_select5.3 <- db_full6new_hr_fix_stim_select5.2%>%
    group_by(ssid,Group, ValenceGround_cut)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)
  

db_full6new_hr_fix_stim_select5.3$

db_forBADA2.1 <- data.table::dcast(setDT(db_full6new_hr_fix_stim_select5.3), 
                    ssid +TAS+ Group ~ ValenceGround_cut, value.var = c('pup_basCor_avg',
                'Bio_Mean_HR_dif_avg', 'log1p_BIO_CDA.PhasicMax_avg'),fun.aggregate = mean)



table(is.na(db_forBADA2.1))
View(db_forBADA2.1)
db_forBADA2.2<- na.omit(db_forBADA2.1)



# try to fill means rowwise
colnames(db_forBADA2.2)

db_forBADA2.2_pupil<- db_forBADA2.2[,4:6]


# hr
db_forBADA2.2_hr<- db_forBADA2.2[,c(7:9)]
# table(is.na(db_forBADA1_pupil$TAS))


# scr
colnames(db_forBADA2)
db_forBADA2.2_scr<- db_forBADA2.2[,10:12]


# bind
db_badia2.1_nona <- bind_cols(db_forBADA2.2[,1:3], db_forBADA2.2_pupil, db_forBADA2.2_hr, 
                              db_forBADA2.2_scr)


```

```{r}

install.packages("TInPosition")
install.packages("ade4")
install.packages("TExPosition")
install.packages("MExPosition")
install.packages("ExPosition")
install.packages("prettyGraphs")

library(TInPosition)
library(MExPosition)

ExPosition::epPCA()

##PCA with Inference
# all.data <- read.csv("PCA_Dataset_2.csv",header=TRUE)
all.data_asd2.1 <- db_badia2.1_nona 


var.design_tas2.1<- if_else(all.data_asd2.1$TAS> median(all.data_asd2.1$TAS, na.rm = TRUE), "High", "Low")



var.design_tas2.1 <- as.factor(var.design_tas2.1)
var.data_asd2.2 <- all.data_asd2.1[,c(4:12)]


# original
?InPosition::epPCA.inference.battery
?correlationPlotter
library(prettyGraphs)
?InPosition::epPCA.inference.battery

var.PCA.inf_asd2.2 <-InPosition::epPCA.inference.battery(var.data_asd2.2, 
                                       scale = TRUE, 
                                       center = TRUE, 
                                       DESIGN = var.design_tas2.1,
                                       make_design_nominal = TRUE, 
                                       graphs = TRUE, k = 0, 
                                       test.iters = 1000, 
                                       constrained = FALSE, critical.value = 2)

# ?ExPosition::epPCA

var.PCA.inf_asd2.2$Fixed.Data$Plotting.Data$fi.col
# color<- bind_rows(as.data.frame(rep("#305ABF", 56)),as.data.frame(rep("#84BF30", 56)),as.data.frame(rep("#84BF30", 56)))
# 
# rep("#84BF30", 56)
# rep("red", 56)

row.cols <- read.csv("row_cols.csv",header=TRUE)
row.cols <- var.PCA.inf_asd2.2$Fixed.Data$Plotting.Data$fi.col
x_axis <- 1
y_axis <- 2
tau <- var.PCA.inf_asd2.2$Fixed.Data$ExPosition.Data$t # variance
p.val <- var.PCA.inf_asd2.2$Inference.Data$components$p.vals
xlab = paste("Component", x_axis, "Variance:",round(tau[x_axis],digits = 2),"%, ","p =",p.val[x_axis])
ylab = paste("Component", y_axis, "Variance:",round(tau[y_axis],digits = 2),"%, ","p =",p.val[y_axis])
main = "PCA with Inference"


?prettyPlot

write_csv("var.PCA.inf_asd_forpca.csv", var.data_asd)
pca.plot <- prettyGraphs::prettyPlot(var.PCA.inf_asd2.2$Fixed.Data$ExPosition.Data$fi,
                       x_axis=x_axis,
                       y_axis=y_axis,
                       col=row.cols,
                       pch=22,
                       cex=NULL,
                       text.cex=NULL,
                       pos=3,

                       xlab=xlab,
                       ylab=ylab,
                       main=main,
                       display_names=TRUE,
                       display_points=TRUE,
                       constraints=NULL,
                       contributionCircles=TRUE,
                       contributions=var.PCA.inf_asd2.2$Fixed.Data$ExPosition.Data$ci, 
                       axes=TRUE, 
                       fg.line.width=3,
                       fg.type="l", 
                       fg.col="black",
                       bg.line.width=1.5, 
                       bg.lty=3, 
                       bg.col="black",
                       flip=FALSE,asp=1, 
                       findBounds=TRUE,
                       dev.new=TRUE,
                       new.plot=TRUE)
?prettyGraphs::correlationPlotter()


prettyGraphs::correlationPlotter(var.data_asd2.2,
  var.PCA.inf_asd2.2$Fixed.Data$ExPosition.Data$fi,
  col= row.cols,
                       pch=22,
                       # cex=NULL,
                       # text.cex=NULL,
                       # pos=3,

                       xlab=xlab,
                       ylab=ylab,
                       main=main
                       # display_names=TRUE,
                       # display_points=TRUE,
                       # constraints=NULL,
                       # contributionCircles=TRUE,
                       # contributions=var.PCA.inf_asd$Fixed.Data$ExPosition.Data$ci, 
                       # axes=TRUE, 
                       # fg.line.width=3,
                       # fg.type="l", 
                       # fg.col="black",
                       # bg.line.width=1.5, 
                       # bg.lty=3, 
                       # bg.col="black",
                       # flip=FALSE,asp=1, 
                       # findBounds=TRUE,
                       # dev.new=TRUE,
                       # new.plot=TRUE
                                 )



summary(var.PCA.inf_asd2.2)

var.PCA.inf_asd2.2$Inference.Data$components$eigs

plot(var.PCA.inf_asd2.2$Inference.Data$components$eigs)

# BADIA

InPosition::epPCA.inference.battery(var.data_asd2.2, 
                                       scale = TRUE, 
                                       center = TRUE, 
                                       DESIGN = var.design_tas2.1,
                                       make_design_nominal = TRUE, 
                                       graphs = TRUE, k = 0, 
                                       test.iters = 1000, 
                                       constrained = FALSE, critical.value = 2)

?TInPosition::tepBADA.inference.battery

var.BADA.inf_asd2.2 <- TInPosition::tepBADA.inference.battery(var.data_asd2.2, 
                                                       scale = TRUE, 
                                                       center = TRUE, 
                                                       DESIGN = var.design_tas2.1,
                                                       make_design_nominal = TRUE, 
                                                       group.masses = NULL, 
                                                       weights = NULL, 
                                                       graphs = TRUE, 
                                                       k = 0, 
                                                       test.iters = 100, 
                                                       critical.value = 2)

var.BADA.inf_asd2.2$Fixed.Data$TExPosition.Data$ci

var.BADA.inf_asd2.2$Inference.Data$omni$p.val

var.BADA.inf_asd2.2$Fixed.Data$TExPosition.Data
?TInPosition::tepDICA.inference.battery
na.omit(var.data_asd)
na.action(var.data_asd)

write_csv(var.data_asd2.2, "var.data_asd2.2.csv")


# bada still won't work
```

kmean on PCS
# store factor scores
fi	
factor scores for the row items.

di	
square distances of the row items.

ci	
contributions (to the variance) of the row items.

ri	
cosines of the row items.

fj	
factor scores for the column items.

dj	
square distances of the column items.

cj	
contributions (to the variance) of the column items.

rj	
cosines of the column items.

t	
the percent of explained variance per component (tau).

eigs	
the eigenvalues from the decomposition.
```{r}
scorefactor2 <-var.PCA.inf_asd2.2[["Fixed.Data"]][["ExPosition.Data"]][["fi"]][,1:3]

var.PCA.inf_asd2.2$Fixed.Data$ExPosition.Data$cj
cj	
contributions (to the variance) of the column items.
var.PCA.inf_asd2.2
library(ggplot2)
library(tidyverse)


# now bidn this to dataset
# all.data_a

# store pcs on the data

colnames(all.data_asd2.1)
all.data_asd2.2
all.data_asd2.1$PC1 <- scorefactor2[,1]
all.data_asd2.1$PC2 <- scorefactor2[,2]
all.data_asd2.1$PC3 <- scorefactor2[,3]

# now try kmeans on the components
all.data_asd2pcs2.1<- all.data_asd2.1

# var.data_asd_with2pcs

colnames(all.data_asd2pcs2.1)
all.data_asd2pcs2.1_forkmean<- all.data_asd2pcs2.1[,c(1,2,13:15)]
# Feature Scaling
# training_set = scale(training_set)
# test_set = scale(test_set)
colnames(all.data_asd2pcs2.1_forkmean)

# Using the elbow method to find the optimal number of clusters
scaled_all.data_asd2pcs2.1_forkmean <-scale(all.data_asd2pcs2.1_forkmean[,3:4])
set.seed(1)
wcss = vector()
for (i in 1:10) wcss[i] = sum(kmeans(all.data_asd2pcs2.1_forkmean[,3:4], i)$withinss)
plot(1:10,
     wcss,
     type = 'b',
     main = paste('The Elbow Method'),
     xlab = 'Number of clusters',
     ylab = 'WCSS')

#  2 or 3

# Fitting K-Means to the dataset
set.seed(25)

?kmeans
kmeans_res = kmeans(x = all.data_asd2pcs2.1_forkmean[,3:4], centers = 2)
y_kmeans = kmeans_res$cluster
rm(kmeans)

# install.packages("factoextra")

?factoextra::fviz_nbclust
factoextra::fviz_nbclust(all.data_asd2pcs2.1_forkmean[,3:4], 
                         kmeans, 
                         method='silhouette')


# Visualising the clusters
# install.packages("cluster")
library(cluster)


scaled_all.data_asd2pcs2.1_forkmean <- as.data.frame(scale(all.data_asd2pcs2.1_forkmean[,3:4])[,1:2])
all.data_asd2pcs2.1_forkmean
  colnames(all.data_asd2pcs2.1_forkmean)
scaled_all.data_asd2pcs2.1_forkmean
?cluster::clusplot


range(scaled_all.data_asd2pcs2.1_forkmean)
range(all.data_asd2pcs2.1_forkmean$PC1)
cluster::clusplot(all.data_asd2pcs2.1_forkmean[,3:4],
         y_kmeans,
         lines = 2,
         shade = TRUE,
         color = TRUE,
         labels = 1,
         plotchar = FALSE,
         span = TRUE
         # label = 
         # main = paste('Clusters of customers'),
         # xlab = 'Annual Income',
         # ylab = 'Spending Score'
         )


```


```{r}

# 
ssid_tasaq<- db_full6new_hr_fix_stim_select3%>%
  group_by(ssid, Group)%>%
  summarise_at(c('TAS', 'AQ'), mean, na.rm = TRUE)
# ssid_tas_aq<- select(db_full6new_hr_fix_stim_select3, c(ssid, TAS))

scaled_all.data_asd2pcs2.1_forkmean
as.factor(all.data_asd2pcs_forkmean2$ssid)
scaled_all.data_asd2pcs2.1_forkmean$ssid<- all.data_asd2pcs2.1$ssid

scaled_all.data_asd2pcs2.1_forkmean$TAS<- all.data_asd2pcs2.1$TAS

# left_join(scaled_all.data_asd2pcs_forkmean ,ssid_tasaq)%>%

all.data_asd2pcs2.1_forkmean$y_kmeans<- y_kmeans
all.data_asd2pcs2.1_forkmean%>%
  ggplot(aes(as.factor(y_kmeans), TAS))+
  stat_summary(geom = "pointrange")+
  geom_text(aes(label = ssid), alpha = .1)

cor.test(all.data_asd2pcs2.1_forkmean$PC1, all.data_asd2pcs2.1_forkmean$TAS)
cor.test(all.data_asd2pcs2.1_forkmean$PC2, all.data_asd2pcs2.1_forkmean$TAS)
cor.test(all.data_asd2pcs2.1_forkmean$PC3 , all.data_asd2pcs2.1_forkmean$TAS)




# scaled_all.data_asd2pcs_forkmean$PC3<- all.data_asd2pcs_forkmean$PC3

scaled_all.data_asd2pcs_forkmean2<- left_join(scaled_all.data_asd2pcs_forkmean ,ssid_tasaq)


all.data_asd2pcs2.1_forkmean$alex_median<- if_else(all.data_asd2pcs2.1_forkmean$TAS> median(all.data_asd2pcs2.1_forkmean$TAS, na.rm = TRUE), "High", "Low")

table(all.data_asd2pcs2.1_forkmean$alex_median, all.data_asd2pcs2.1_forkmean$y_kmeans)


table(scaled_all.data_asd2pcs2.1_forkmean$alex_median, 
      
      scaled_all.data_asd2pcs2.1_forkmean$y_kmeans)


all.data_asd2pcs2.1_forkmean%>%
  ggplot(aes(as.factor(y_kmeans), TAS))+
  stat_summary(geom = "pointrange")+
  geom_text(aes(label = ssid), alpha = .1)+
  facet_grid(~alex_median)


  
  # flag just the sigmificant variables
  # subset to keep the varioables that came sgnificant ut of the infernce PCA for either of the first 2 or 3 dimmensions
  signiftestpca_df<- as.data.frame(signiftestpca)
  signiftestpca1_2<- signiftestpca_df%>%
                            any(~(V1, V2) == TRUE)
  
  unique(signiftestpca1_2$V1)
  unique(signiftestpca1_2$V2)  
  
  new.data <- signiftestpca_df[ which( signiftestpca_df$V1 == TRUE | signiftestpca_df$V2 == TRUE) , ]
  
  
  unique(new.data$V1)
  unique(new.data$V2)
  
  View(new.data)
  
  new.data
  new.data$pca_v1_v2<- paste0(new.data$V1, paste0(new.data$V2))
  unique( new.data$pca_v1_v2)
  new.data1<- select(new.data, c(V1, V2, V3, pca_v1_v2))
  
  # store row name into a variable
  new.data1$variable<- rownames(new.data1)
  
  
  # extract pattern after the last underscore
     new.data1$stimIAPS2<- sub('.*\\_', '', new.data1$variable)
  new.data1$stimIAPS2
  
    new.data1$InPCA<- "YES"
    
    scaled_all.data_asd2pcs_forkmean2
    
    new.data1
     unique( new.data1$pca_v1_v2)


# merge this back with the full data
        db_full6new_hr_fix_stim_select5
        
        unique(scaled_all.data_asd2pcs_forkmean2$ssid)
  kmean_pca_longdata  <- left_join(scaled_all.data_asd2pcs_forkmean2, db_full6new_hr_fix_stim_select3, 
                                   by = c("ssid", "Group"))
  
  kmean_pca_longdata
  
 # new.data2 <- new.data1%>%
 #    arrange(stimIAPS2)%>%
 #    subset(!duplicated(stimIAPS2))
 
 new.data2<- new.data1
 
 unique( new.data2$pca_v1_v2)
 
 unique(new.data2)
 unique(kmean_pca_longdata$ssid)
 
 kmean_pca_longdata
new.data3<- left_join( new.data2,kmean_pca_longdata)
  # left_join( new.data2,kmean_pca_longdata) %>%

unique(new.data3$pca_v1_v2)


V3

all.data_asd2pcs_forkmean
new.data3$PC3<- all.data_asd2pcs_forkmean$PC3


# this is however takling all the data not only the data PCA deemed to be imorttant

new.data3$pca_v1_v2

unique(new.data3$stimIAPS2)
unique(new.data3$pca_v1_v2)
new.data3 %>%
  # subset(Group == "NT")%>%
  subset(ssid!=336)%>%
    group_by(ssid, Group)%>%
    summarise_if(is.numeric, mean, na.rm = TRUE)%>%
    ggplot(aes( AQ.y, PC3))+
  geom_point()+
  geom_smooth(method = 'lm', se = F)+
  geom_text(aes(label = ssid))+
  ggpubr::stat_cor(method = 'spearman')+
    stat_ellipse()
  # stat_summary(geom = 'pointrange')+
      geom_jitter(alpha = .1, width = .1)+
  
        
        
      # facet_grid(~Group)+
  ggpubr::stat_compare_means()
      
      new.data3$Alex_median<- if_else(new.data3$TAS.x> median(new.data3$TAS.x, na.rm = TRUE), "High", "Low")
      
      new.data3 %>%
      
        subset(ssid!=336)%>%
        subset(!is.na(TAS.x))%>%
    group_by(ssid, Alex_median)%>%
    summarise_if(is.numeric, mean, na.rm = TRUE)%>%
    ggplot(aes( Alex_median, PC3))+
          stat_summary(geom = "pointrange")+
  # geom_point()+
  geom_smooth(method = 'lm', se = F)+
  geom_text(aes(label = ssid))+
        ylim(-1.6, 2.5)+
  ggpubr::stat_compare_means()
    # stat_ellipse()
  # stat_summary(geom = 'pointrange')+
      geom_jitter(alpha = .1, width = .1)+
  


```




# score_test


?correlationPlotter
library(prettyGraphs)

var.PCA.inf_asd$Fixed.Data



# let's try tinpositioinsta

install.packages('InPosition')

?epPCA.inference.battery

# var.PCA.inf <- InPosition::epPCA.inference.battery(var.data1, scale = TRUE, center = TRUE, DESIGN = var.design, make_design_nominal = TRUE, graphs = TRUE, k = 0, test.iters = 100, constrained = FALSE, critical.value = 2)


row.cols<- var.data_asd
  
  var.PCA.inf_asd$Fixed.Data$Plotting.Data$fi.col
## Look at other dimensions
row.cols <- read.csv("row_cols.csv",header=TRUE)


# row.cols <- var.data[,2]

# row.cols<- all.data_highlow[,3]

x_axis <- 1
y_axis <- 2

var.PCA.inf$ExPosition.Data

tau <- var.PCA.inf_asd$Fixed.Data$ExPosition.Data$t
p.val <- var.PCA.inf_asd$Inference.Data$components$p.vals
xlab = paste("Component", x_axis, "Variance:",round(tau[x_axis],digits = 2),"%, ","p =",p.val[x_axis])
ylab = paste("Component", y_axis, "Variance:",round(tau[y_axis],digits = 2),"%, ","p =",p.val[y_axis])
main = "PCA with Inference"

pca.plot <- prettyPlot(var.PCA.inf_asd$Fixed.Data$ExPosition.Data$fi,
x_axis=x_axis,
y_axis=y_axis,
col= var.PCA.inf_asd$Fixed.Data$Plotting.Data$fi.col,
pch=22,
cex=NULL,
text.cex=NULL,
pos=3,
xlab=xlab,ylab=ylab,main=main,display_names=FALSE,display_points=TRUE,
constraints=NULL,contributionCircles=TRUE,contributions=var.PCA.inf$Fixed.Data$ExPosition.Data$ci, axes=TRUE, fg.line.width=3,fg.type="l", fg.col="black",
bg.line.width=1.5, bg.lty=3, bg.col="black",flip=FALSE,asp=1, findBounds=TRUE,dev.new=TRUE,new.plot=TRUE)

var.PCA.inf_asd$Inference.Data$components$
```

## Barycentric Discriminant Analysis (BaDa)
```{r}
# var.data <- all.data_highlow[,c(4:171)]

TInPosition::tepBADA.inference.battery()
# 
# table(is.na(var.data))
# na.omit(var.data)
# 
#  var.data$log1p_BIO_CDA.PhasicMax_9926
# 
#  
#  var.data %>%
#     select_if(~ any(is.infinite(.)))
#  
#  var.data1<- na.omit(var.data)
 
 
var.design<- as.factor(all.data_highlow$alex_quartil)


resBADA <- TExPosition::tepBADA(var.data, DESIGN = var.design, scale = TRUE,
                   graphs = FALSE)

colnames(var.data)

?TInPosition::tepBADA.inference.battery

?TExPosition::tepBADA


test <- TExPosition::tepBADA(var.data_asd, 
                                                       scale = TRUE, 
                                                       center = TRUE, 
                                                       DESIGN = var.design_asd, 
                                                       make_design_nominal = TRUE, 
                                                       group.masses = NULL, 
                                                       # weights = NULL, 
                                                       graphs = TRUE, 
                                                       k = 0
                                                       # test.iters = 100, 
                                                       # critical.value = 2
                     )


test$Plotting.Data

TExPosition::tepDICA()
?TInPosition::print.tepDICA.inference.battery()
var.BADA.inf_asd <- TInPosition::tepBADA.inference.battery(var.data_asd, 
                                                       scale = TRUE, 
                                                       center = TRUE, 
                                                       DESIGN = all.data_asd$Group, 
                                                       make_design_nominal = TRUE, 
                                                       group.masses = NULL, 
                                                       weights = NULL, 
                                                       graphs = TRUE, 
                                                       k = 0, 
                                                       test.iters = 100, 
                                                       critical.value = 2)


?TInPosition::tepDICA.inference.battery
na.omit(var.data_asd)
na.action(var.data_asd)
```
