---
title: "ThesisIAPS2021"
author: "Helio"
date: "13/09/2021"
output: html_document
---


Related scripts
- Paper_analyses_subj_Obje_arousal

Related datasets
db_full4new_stim_screen_pupil_nopract

#######################################
PUPIL
######################################

db_full4new will have other screens I think

db_345_355
db_356_357_611_616

try and get a fixation bit for tonic analyses

```{r}

unique(db_full4new$ssid)

db_345_355
unique(db_345_355$ssid)
unique(db_356_357_611_616$ssid)

unique(db_full6new$ssid)

db_full6new$Bio_Mean_HR
unique(db_full6new$screencontent)

colnames(db_full6new)
db_full6new_select_forpca<- db_full6new %>%
  select(c(ssid, Group, TAS, AQ,stimIAPS,tNo, Bio_Mean_HR,Mean_HR,BIO_CDA.PhasicMax, pup_basCor, arousal, valence, screencontent))

db_full6new_select_forpca$Mean_HR
db_full6new_select_forpca$Bio_Mean_HR

# new datasets select

db_345_355$Bio_Mean_HR<- db_345_355$Mean_HR

db_345_355_select_forpca<- db_345_355%>%
    select(c(ssid,  TAS, AQ,stimIAPS,tNo, Bio_Mean_HR,Mean_HR,BIO_CDA.PhasicMax, pup_basCor, arousal, valence, screencontent))

# remeber to remake group
db_356_357_611_616$Bio_Mean_HR <-db_356_357_611_616$Mean_HR

db_356_357_611_616_select_forpca<- db_356_357_611_616%>%
    select(c(ssid,  TAS, AQ, stimIAPS,tNo, Bio_Mean_HR,Mean_HR,BIO_CDA.PhasicMax, pup_basCor, arousal, valence, screencontent, ))
db_full6new_select_forpca$Group<- NULL
  

# bind all

db_345_355_select_forpca$ssid<- as.character(db_345_355_select_forpca$ssid)

db_356_357_611_616_select_forpca$ssid<- as.character(db_356_357_611_616_select_forpca$ssid)


db_345_355_select_forpca$tNo<- as.character(db_345_355_select_forpca$tNo)

db_356_357_611_616_select_forpca$tNo<- as.character(db_356_357_611_616_select_forpca$tNo)

db_fixation_pcaSep22<- bind_rows(db_full6new_select_forpca,
          db_345_355_select_forpca,
          db_356_357_611_616_select_forpca)
  subset(screencontent == "fixation")
  
  
  unique(db_fixation_pcaSep22$screencontent)
  
  
  test_pupipil_fix<- subset(db_fixation_pcaSep22,
                            screencontent == "fixation"|screencontent == "stim")

  unique(test_pupipil_fix$screencontent)
  
unique(db_fixation_pcaSep22$tNo)
db_fixation_pcaSep22$stimIAPS2<- substr(db_fixation_pcaSep22$stimIAPS, 1,4)

unique(db_fixation_pcaSep22$ssid)
db_fixation_pcaSep22$Group<- if_else(as.numeric(db_fixation_pcaSep22$ssid)> 400 & as.numeric(db_fixation_pcaSep22$ssid)< 800, "ASD", "NT")

db_fixation_pcaSep22_304_up<- subset(db_fixation_pcaSep22,
                                     as.numeric(ssid)> 303)



```


```{r}



db_full6new_hr_fix_stim_select$scr
db_full6new_hr_fix_stim_select$screencontent_no






colnames(db_full4new)
unique(db_full4new$screencontent)
unique(db_full4new$ssid)
unique(db_full4new_stim_screen_pupil_nopract$ssid)
# missing data

356
# 357 = 312_2021 (missing pratice behavioural data)
611-617

312 = 357

311/357 = 611

# Pupil

```


Importing new datasets

```{r}
library(readr)
library(tidyverse)
# currendatasets::
db_full4new_stim_screen_pupil_nopract

# importinng subjects 356, 357 and 611 to 616, note that gaze data for 616 is invalid
# participant 615 is obese so the physio data might be compromised due to heavy breathing during the session
db_356_357_611_616 <- read_csv("tmp.df4_sum_full_bio_hr_self_parsed_356_357_611_616.csv")


# rename a few columns to match current dataset

db_356_357_611_616<- db_356_357_611_616 %>%
  rename(Gender = gender)%>%
  rename(menalHealth = `mental_health-text`)

# subset stim to match current dataset

db_356_357_611_616_stim<- subset(db_356_357_611_616, db_356_357_611_616$screencontent == "stim")

# a few more columns need renaming

# db_356_357_611_616_stim<- db_356_357_611_616_stim %>% 
#   rename(Age = Age)%>%
#   rename(Gender = gender_response)


# NOW bind rows
db_full4new_stim_screen_pupil_nopract_backup_befoe356_611_616<- db_full4new_stim_screen_pupil_nopract
db_full4new_stim_screen_pupil_nopract<- db_full4new_stim_screen_pupil_nopract_backup_befoe356_611_616

colnames(db_356_357_611_616_stim)
colnames(db_full4new_stim_screen_pupil_nopract)





db_full4new_stim_screen_pupil_select <- db_full4new_stim_screen_pupil_nopract %>%
  select(c(ssid,subject, Condition,screencontent, screencontent_no, text, tNo,trialUnq,
           stimIAPS,stimDescription, arousal, valence,
           ArousalMean, ValenceMean, pup_basCor, gaze_loss_prop,gaze_valid_prop,
           completion_code, Gender:BVAQ, WASIM, BIO_CDA.AmpSum:BIO_Global.Mean,
           fix_count:RMS, POGsd:SacAmp))

pupil_select_cols<- names(db_full4new_stim_screen_pupil_select)

colnames(db_full4new_stim_screen_pupil_select)

# select similar columns in the new data and make them if they don't exist

db_356_357_611_616_stim$correction <- db_356_357_611_616_stim$`EyesightResponse-text`
db_356_357_611_616_stim$mentalHealth<- db_356_357_611_616_stim$menalHealth
db_356_357_611_616_stim$eyeColor<- db_356_357_611_616_stim$`eye_colour-text`
db_356_357_611_616_stim$FirstLanguage<- NA

db_356_357_611_616_stim$IAS<- NA
db_356_357_611_616_stim$STAIIT<- NA
db_356_357_611_616_stim$STAIIS<- NA
db_356_357_611_616_stim$sdevgaze_parsed<- NULL

db_356_357_611_616_stim$Group <- if_else(db_356_357_611_616_stim$ssid> 400, "ASD", "NT")

# select
db_356_357_611_616_stim_select<- select(db_356_357_611_616_stim, 
                                        c(pupil_select_cols))



# now merge current and new
db_full4new_stim_screen_pupil_select_priortomerge<- db_full4new_stim_screen_pupil_select
db_356_357_611_616_stim_select$ssid<- as.character(db_356_357_611_616_stim_select$ssid)
db_full4new_stim_screen_pupil_select$ssid<- as.character(db_full4new_stim_screen_pupil_select$ssid)
db_356_357_611_616_stim_select$tNo<- as.character(db_356_357_611_616_stim_select$tNo)
db_full4new_stim_screen_pupil_select$tNo <- as.character(db_full4new_stim_screen_pupil_select$tNo)

db_full4new_stim_screen_pupil_select<- 
  bind_rows(db_full4new_stim_screen_pupil_select, db_356_357_611_616_stim_select)


save(db_356_357_611_616,db_356_357_611_616_stim, db_full4new_stim_screen_pupil_nopract, db_full4new_stim_screen_pupil_select, "InteroStudy21Thesis.Rdata")


```
demographics

```{r}
db_full4new_stim_screen_pupil_select$Group<- if_else(as.numeric(db_full4new_stim_screen_pupil_select$ssid)>
                                                       500 & as.numeric(db_full4new_stim_screen_pupil_select$ssid) < 700, "ASD", "NT")

unique(db_full4new_stim_screen_pupil_select$Gender)
table(is.na(db_full4new_stim_screen_pupil_select$Gender))

demog_summ<- db_full4new_stim_screen_pupil_select%>%
  group_by(ssid, Group, Gender)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)

write_csv(demog_summ, "demog_summ.csv")

save(db_356_357_611_616,db_356_357_611_616_stim, db_full4new_stim_screen_pupil_nopract, db_full4new_stim_screen_pupil_select,demog_summ, "InteroStudy21Thesis.Rdata")
                                                     

```


Merge brightness data

```{r}
db_full4new_stim_screen_pupil_select$stimIAPS[db_full4new_stim_screen_pupil_select$stimIAPS== "2900.1.jpg"]<- "2900.jpg1.jpg"

db_full4new_stim_screen_pupil_select$stimIAPS[db_full4new_stim_screen_pupil_select$stimIAPS== "2345.1.jpg"]<- "2345.jpg1.jpg"

db_full4new_stim_screen_pupil_select$Label<- substr(db_full4new_stim_screen_pupil_select$stimIAPS, 1,8)

db_full4new_stim_screen_pupil_select$stimIAPS2<- substr(db_full4new_stim_screen_pupil_select$stimIAPS, 1,4)
imageJ_IAPS
imageJ_IAPS$stimIAPS2<- imageJ_IAPS$Label2

imageJ_IAPS$Label2<- NULL

db_full4new_stim_screen_pupil_select1 <- dplyr::left_join(db_full4new_stim_screen_pupil_select, imageJ_IAPS, by = "stimIAPS2")


save(db_356_357_611_616,db_356_357_611_616_stim, 
     db_full4new_stim_screen_pupil_nopract, db_full4new_stim_screen_pupil_select,
     demog_summ,db_full4new_stim_screen_pupil_select1,
     imageJ_IAPS, file = "test.Rdata")
```


Pupil models

```{r}

# flag outliers
# pupil  - flad outliers based on range of responses of each participant
# for arousal - and valence flag it based on average responses across participants

db_full4new_stim_screen_pupil_select1


 db_full4new_stim_screen_pupil_select1<- db_full4new_stim_screen_pupil_select1 %>%
  group_by(stimIAPS) %>%
  mutate(arousal_outler = if_else(arousal > (median(arousal, na.rm = TRUE) + 
                                               (4*mad(arousal, na.rm = TRUE))), TRUE,
         if_else(arousal < (median(arousal, na.rm = TRUE) - 
                              (4*mad(arousal, na.rm = TRUE))), TRUE, FALSE)))%>%
   mutate(valence_outler = if_else(valence > (median(valence, na.rm = TRUE) + 
                                               (4*mad(valence, na.rm = TRUE))), TRUE,
         if_else(valence < (median(valence, na.rm = TRUE) - 
                              (4*mad(valence, na.rm = TRUE))), TRUE, FALSE)))%>%
  group_by(ssid)%>%
   mutate(pupil_outlier = if_else(pup_basCor > (median(pup_basCor, na.rm = TRUE) 
                                                + (3*mad(pup_basCor, na.rm = TRUE))), TRUE,
         if_else(pup_basCor < (median(pup_basCor, na.rm = TRUE) - 
                                 (3*mad(pup_basCor, na.rm = TRUE))), TRUE, FALSE)))
 
 
 # quick check
 db_full4new_stim_screen_pupil_select1%>%
   subset(ssid == 339)%>%
   # subset(pupil_outlier == FALSE)%>%
   
   ggplot(aes(pup_basCor))+
   geom_histogram()+
   facet_grid(~pupil_outlier)

 db_full4new_stim_screen_pupil_select1%>%
   subset(ssid == 339)%>%
   # subset(pupil_outlier == FALSE)%>%
   
   ggplot(aes(arousal))+
   geom_histogram()+
   facet_grid(~arousal_outler)



```

center and scale predictors
```{r}
table(is.na(db_full4new_stim_screen_pupil_select1$Group))
db_full4new_stim_screen_pupil_select1<- db_full4new_stim_screen_pupil_select1 %>%
    ungroup()%>%
  mutate(arousal_c = scale(arousal, center = TRUE, scale = TRUE)[,1],
         valence_c = scale(valence, center = TRUE, scale = TRUE)[,1],
         Mean_gray_z = scale(Mean)[,1],
         TASc = scale(TAS)[,1],
         AQc = scale(AQ)[,1],
         BPQc = scale(BPQ)[,1],
         WASIM_c =scale(WASIM)[,1],
         DASSTotalc = scale(DASSTotal)[,1])


db_full4new_stim_screen_pupil_select1$Group_NT_pos<- if_else(db_full4new_stim_screen_pupil_select1$Group == "NT", +.5, -.5)

```

Formal models

```{r}
options(contrasts = c("contr.sum","contr.poly"))
options(scipen = 999)

# first concordance

# across all participants

pupil_plots<- list()
pupil_plots$tas_pupil <- db_full4new_stim_screen_pupil_select1%>%
  subset( Age < 50)%>%
  subset(pupil_outlier == FALSE)%>%
   # subset(valence_outler == FALSE)%>%
  # subset(arousal_outler == FALSE)%>%
  subset(ssid!= 356)%>% #clear pupil outlier
  subset(ssid!= 351)%>%
  subset(ssid!= 344)%>% #anthony
  group_by(ssid, Group)%>%
  mutate(cor_ar_pup = cor(arousal_c, pup_basCor, use = "complete"))%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(TASc,cor_ar_pup))+
  geom_point(aes(color = Group), size = 2)+
  # geom_text(aes(label = ssid))+
    geom_smooth(method = lm, se = F)+
    # ylim(-0.1, 0.5)+
    ggpubr::stat_cor()+
  xlab("Alexithymia (z)")+
  ylab(expression("Pupil vs subjective arousal ("*rho * ")")) +
  scale_y_continuous(breaks = c(-.1,0,.1,.2, .3,.4,.5), limits = c(-.1, .5))+
  scale_x_continuous(breaks = c(-2, -1, 0, 1, 2), limits = c(-2, 2.5))+
  p$graphstyle+
  scale_color_brewer(palette = "Dark2")

pupil_plots$tas_pupil

```


```{r}



db_full4new_stim_screen_pupil_select1%>%
  subset(!is.na(TAS))%>%
  subset(pupil_outlier == FALSE)%>%
   # subset(valence_outler == FALSE)%>%
  # subset(arousal_outler == FALSE)%>%
  subset(ssid!= 356)%>% #clear pupil outlier
  subset(ssid!= 351)%>%
  subset(ssid!= 344)%>% #anthony
  group_by(ssid, Group)%>%
  mutate(cor_ar_pup = cor(arousal_c, pup_basCor, use = "complete"))%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(AQ,cor_ar_pup))+
  geom_point(aes(color = Group))+
  # geom_text(aes(label = ssid))+
    geom_smooth(method = lm, se = F)+
    ggpubr::stat_cor()+
  p$graphstyle


pupil_plots$aq_pupil <- db_full4new_stim_screen_pupil_select1%>%
  subset(Age <45)%>%
  subset(pupil_outlier == FALSE)%>%
   # subset(valence_outler == FALSE)%>%
  # subset(arousal_outler == FALSE)%>%
  subset(ssid!= 356)%>% #clear pupil outlier
  subset(ssid!= 351)%>%
  subset(ssid!= 344)%>% #anthony
  group_by(ssid, Group)%>%
  mutate(cor_ar_pup = cor(arousal_c, pup_basCor, use = "complete"))%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(AQc,cor_ar_pup))+
  geom_point(aes(color = Group), size = 2)+
  # geom_text(aes(label = ssid))+
    geom_smooth(method = lm, se = F)+
    # ylim(-0.1, 0.5)+
    ggpubr::stat_cor()+
  xlab("Autism (z)")+
  ylab(expression("Pupil vs subjective arousal ("*rho * ")")) +
  scale_y_continuous(breaks = c(-.1,0,.1,.2, .3,.4,.5), limits = c(-.1, .5))+
  scale_x_continuous(breaks = c(-2, -1, 0, 1, 2), limits = c(-2, 2.5))+
  p$graphstyle+
  scale_color_brewer(palette = "Dark2")

pupil_plots$aq_pupil


```


db_full4new_stim_screen_pupil_select %>%
  subset(!is.na(TAS))%>%
  subset(pupil_outlier == FALSE)%>%
   # subset(valence_outler == FALSE)%>%
  # subset(arousal_outler == FALSE)%>%
  subset(ssid!= 356)%>% #clear pupil outlier
  subset(ssid!= 351)%>%
  subset(ssid!= 344)%>% #anthony
  group_by(ssid, Group)%>%
  mutate(cor_ar_pup = cor(arousal_c, pup_basCor, use = "complete"))%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(Age,cor_ar_pup))+
  geom_point(aes(color = Group))+
  # geom_text(aes(label = ssid))+
    geom_smooth(method = lm, se = F)+
    ggpubr::stat_cor()+
  p$graphstyle



# aq
```{r}
db_full4new_stim_screen_pupil_select1%>%
  subset(Group == "ASD")%>%
  subset(pupil_outlier == FALSE)%>%
   subset(gaze_valid_tresh == "include")%>%
  subset(arousal_outler == FALSE)%>%
  subset(ssid!= 356)%>% #clear pupil outlier
  subset(ssid!= 351)%>%
  subset(ssid!= 344)%>% #anthony
  group_by(ssid, Group)%>%
  mutate(cor_ar_pup = cor(arousal_c, pup_basCor, use = "complete"))%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(TAS,cor_ar_pup, color = Group))+
  geom_point()+
  geom_text(aes(label = ssid))+
    geom_smooth(method = lm, se = F)+
    ggpubr::stat_cor()

```
```{r}
table(is.na(db_full4new_stim_screen_pupil_select1$TAS))

test<- subset(db_full4new_stim_screen_pupil_select1, is.na(TAS))
test$ssid

unique(test$ssid)
 # 344 601 352 355 614

db_full4new_stim_screen_pupil_select1$TAS[db_full4new_stim_screen_pupil_select1$ssid == 355]<- 67
db_full4new_stim_screen_pupil_select1$AQ[db_full4new_stim_screen_pupil_select1$ssid == 355]<- 19
# db_full4new_stim_screen_pupil_select1$AQ[db_full4new_stim_screen_pupil_select1$ssid == 355]<- 19

db_full4new_stim_screen_pupil_select1$TAS[db_full4new_stim_screen_pupil_select1$ssid == 352]<- 46
db_full4new_stim_screen_pupil_select1$AQ[db_full4new_stim_screen_pupil_select1$ssid == 352]<- 19

# 601
db_full4new_stim_screen_pupil_select1$TAS[db_full4new_stim_screen_pupil_select1$ssid == 601]
db_full4new_stim_screen_pupil_select1$AQ[db_full4new_stim_screen_pupil_select1$ssid == 601]


# 614
db_full4new_stim_screen_pupil_select1$TAS[db_full4new_stim_screen_pupil_select1$ssid == 601]
db_full4new_stim_screen_pupil_select1$AQ[db_full4new_stim_screen_pupil_select1$ssid == 601]

db_full4new_stim_screen_pupil_select1$Alexithymia_cutoff<- if_else(db_full4new_stim_screen_pupil_select1$TAS>60, "High", "Low")

db_full4new_stim_screen_pupil_select1%>%
  subset(!is.na(TAS))%>%
  subset(pupil_outlier == FALSE)%>%
   subset(gaze_valid_tresh == "include")%>%
  subset(arousal_outler == FALSE)%>%
  subset(ssid!= 356)%>% #clear pupil outlier
  subset(ssid!= 351)%>%
  subset(ssid!= 344)%>% #anthony
  group_by(ssid, Group,Alexithymia_cutoff)%>%
  mutate(cor_ar_pup = cor(arousal_c, pup_basCor, use = "complete"))%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(Group,cor_ar_pup, color = Alexithymia_cutoff))+
  geom_point()+
  stat_summary(geom = 'pointrange')+
  # geom_text(aes(label = ssid))+
    geom_smooth(method = lm, se = F)+
    ggpubr::stat_compare_means()

```

mixed models

```{r}
options(contrasts = c("contr.sum","contr.poly"))
options(scipen = 999)
library(lmerTest)

# compute average pupil validity
db_full4new_stim_screen_pupil_select1<- db_full4new_stim_screen_pupil_select1 %>%
  group_by(ssid)%>%
  mutate(avg_gaze_valid = mean(gaze_valid_prop, na.rm = TRUE))%>%
  ungroup()%>%
  mutate(gaze_valid_tresh = if_else(avg_gaze_valid> .8, "include", "exclude"))

db_full4new_stim_screen_pupil_select1%>%
  ggplot(aes(avg_gaze_valid))+
  geom_histogram()+
  facet_grid(~gaze_valid_tresh)

db_full4new_stim_screen_pupil_select1%>%
  subset(gaze_valid_tresh == "exclude")


```

```{r}


# demographocs

db_full4new_stim_screen_pupil_select1 %>%
  # subset(Age< 55)%>%
  group_by(ssid, Group,Gender)%>%
  summarise_at(c('Age', 'TAS', 'DASSTotal', 'BPQ', 'AQ','WASIM'), mean, na.rm = TRUE)%>%
  ungroup()%>%
  
  group_by(Group,Gender)%>%
  mutate(n = n())%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)

db_full4new_stim_screen_pupil_select1 %>%
  # subset(Age< 55)%>%
  group_by(ssid, Group,Gender)%>%
  summarise_at(c('Age', 'TAS', 'DASSTotal', 'BPQ', 'AQ','WASIM'), mean, na.rm = TRUE)%>%
  ungroup()%>%
  
  group_by(Group,Gender)%>%
  mutate(n = n())%>%
  summarise_if(is.numeric, sd, na.rm = TRUE)
  

# sd feamlas_data_frame()
(16.165808+12.735955)/2

# asd mean age
(41.00000+35.25000)/2
```


```{r}
lmer_intero_pupil<- list()

# factor random effects

unique(db_full4new_stim_screen_pupil_select1$ssid)

db_full4new_stim_screen_pupil_select1<- db_full4new_stim_screen_pupil_select1%>%
  mutate(stimIAPS2 = factor(stimIAPS2),
         ssid = factor(ssid))

# pupil against subjective ratings and alexithymia
pupil_arousal_findings$pup_self_tas <- lmer(pup_basCor ~ (arousal_c)* 
                                                    TASc  *Group_NT_pos+
  Mean_gray_z +
                                                      (1|stimIAPS2)+
                                                    (1  | ssid),
                                                  REML = FALSE,
                      data = db_full4new_stim_screen_pupil_select1%>%
    subset(ssid!= 356)%>%
         subset(gaze_valid_tresh == "include")%>%
   subset(ssid!= 351))


summary(pupil_arousal_findings$pup_self_tas )
print(pupil_arousal_findings$pup_self_tas, correlation =TRUE)  

# db_full4new_stim_screen_pupil_select1%>%
#   group_by(stimIAPS2)%>%
#   summarise_if(is.numeric, mean, na.rm = TRUE)%>%
#   ggplot(aes(Mean_gray_z, valence))+
#   geom_point()+
#   geom_smooth(method = 'lm')+
#   ggpubr::stat_cor()


# same as above but no outliers
pupil_arousal_findings$pup_self_tas_no_outl <- lmer(pup_basCor ~ (arousal_c)* 
                                                    TASc  +
                                                    # *Group_NT_pos+
  Mean_gray_z +
                                                      (1|stimIAPS2)+
                                                    (1  | ssid),
                                                  REML = FALSE,
                      data = db_full4new_stim_screen_pupil_select1%>%
    subset(pupil_outlier == FALSE)%>%
     subset(arousal_outler == FALSE)%>%
    subset(ssid!= 356)%>%
      subset(gaze_valid_tresh == "include")%>%
         # subset(as.numeric(ssid) < 500))
   subset(ssid!= 351))

summary(pupil_arousal_findings$pup_self_tas_no_outl)

sjPlot::tab_model(pupil_arousal_findings$pup_self_tas_no_outl)

pupil_plots$tas_pupil_int<- interactions::probe_interaction(pupil_arousal_findings$pup_self_tas_no_outl,
                                pred= arousal_c, modx = TASc)pupil_plots$tas_pupil_int
pupil_plots$tas_pupil_int<- interactions::interact_plot(pupil_arousal_findings$pup_self_tas_no_outl,
                                pred= arousal_c, modx = TASc)




pupil_plots$tas_pupil_int<- pupil_plots$tas_pupil_int +   
  scale_x_continuous(breaks = c(-2,-1, 0,1, 2), limits = c(-2,2.4))+
  scale_y_continuous(breaks = c(-1, -.8, -.6, -.4), limits = c(-1.2, -.4))


pupil_plots$tas_pupil_int


pupil_plots$tas_pupil_int<- pupil_plots$tas_pupil_int +
# plots_paper$interaction_ar_vl +
  theme_classic()+
  p$graphstyle_int+
  xlab("Subjective arousal (z)")+
  ylab("Pupil (au)")
  
```


```{r}

# AQ

pupil_arousal_findings$pup_self_tasaq_no_outl <- lmer(pup_basCor ~ (arousal_c)* 
                                                    (AQc*TASc)+
                                                    # *Group_NT_pos+
  Mean_gray_z +
                                                      (1|stimIAPS2)+
                                                    (1  | ssid),
                                                  REML = FALSE,
                      data = db_full4new_stim_screen_pupil_select1%>%
    subset(pupil_outlier == FALSE)%>%
     # subset(arousal_outler == FALSE)%>%
    subset(ssid!= 356)%>%
      subset(gaze_valid_tresh == "include")%>%
                 subset(Age < 51)%>%
   subset(ssid!= 351))


pupil_arousal_findings$pup_self_aq_no_outl <- lmer(pup_basCor ~ (arousal_c)* 
                                                    (AQc)+
                                                    # *Group_NT_pos+
  Mean_gray_z +
                                                      (1|stimIAPS2)+
                                                    (1  | ssid),
                                                  REML = FALSE,
                      data = db_full4new_stim_screen_pupil_select1%>%
    subset(pupil_outlier == FALSE)%>%
     # subset(arousal_outler == FALSE)%>%
    subset(ssid!= 356)%>%
      subset(gaze_valid_tresh == "include")%>%
         subset(Age < 50)%>%
   subset(ssid!= 351))

db_full4new_stim_screen_pupil_select1$Age

summary(pupil_arousal_findings$pup_self_tasaq_no_outl)
summary(pupil_arousal_findings$pup_self_aq_no_outl)

anova(pupil_arousal_findings$pup_self_tasaq_no_outl, pupil_arousal_findings$pup_self_tas_no_outl,
      pupil_arousal_findings$pup_self_aq_no_outl)

car::vif(pupil_arousal_findings$pup_self_tasaq_no_outl)

interactions::probe_interaction(pupil_arousal_findings$pup_self_tasaq_no_outl,
                                pred= arousal_c, modx = AQc)
pupil_plots$aq_pupil_int <- interactions::interact_plot(pupil_arousal_findings$pup_self_tasaq_no_outl,
                                pred= arousal_c, modx = AQc)



pupil_plots$aq_pupil_int<- pupil_plots$aq_pupil_int +   
  scale_x_continuous(breaks = c(-2,-1, 0,1, 2), limits = c(-2,2.4))+
  scale_y_continuous(breaks = c(-1, -.8, -.6, -.4), limits = c(-1.2, -.4))


pupil_plots$aq_pupil_int


pupil_plots$aq_pupil_int<- pupil_plots$aq_pupil_int +
# plots_paper$interaction_ar_vl +
  theme_classic()+
  p$graphstyle_int+
  xlab("Subjective arousal (z)")+
  ylab("Pupil (au)")

pupil_plots$aq_pupil_int




library(patchwork)
pupil_plots$PatchworkPupillmer <- pupil_plots$tas_pupil + pupil_plots$aq_pupil+
pupil_plots$tas_pupil_int+ pupil_plots$aq_pupil_int+
  plot_layout(ncol = 2)+
  plot_annotation(tag_levels = "A")

pupil_plots$PatchworkPupillmer

ggsave("PatchworkPupillmer.tiff", pupil_plots$PatchworkPupillmer, 
       device = "tiff", width = 14, height = 10, dpi = 800)

```

```{r}
# just NT

pupil_arousal_findings$pup_self_tas_no_outl_NT <- lmer(pup_basCor ~ (arousal_c)* 
                                                    (TASc  )+
                                                    # *Group_NT_pos+
  Mean_gray_z +
                                                      (1|stimIAPS2)+
                                                    (1  | ssid),
                                                  REML = FALSE,
                      data = db_full4new_stim_screen_pupil_select1%>%
    subset(pupil_outlier == FALSE)%>%
     subset(arousal_outler == FALSE)%>%
    subset(Group ==  "NT")%>%
    subset(ssid!= 356)%>%
      # subset(ssid!= 357)%>%
      subset(gaze_valid_tresh == "include")%>%
         # subset(as.numeric(ssid) < 500))
   subset(ssid!= 351))


  # subset(ssid!= 356)%>% #clear pupil outlier
  # subset(ssid!= 351)%>%
  # subset(ssid!= 344)%>%
summary(pupil_arousal_findings$pup_self_tas_no_outl_NT)


pupil_arousal_findings$pup_self_tasaq_no_outl_NT <- lmer(pup_basCor ~ (arousal_c)* 
                                                    (TASc+AQc  )+
                                                    # *Group_NT_pos+
  Mean_gray_z +
                                                      (1|stimIAPS2)+
                                                    (1  | ssid),
                                                  REML = FALSE,
                      data = db_full4new_stim_screen_pupil_select1%>%
    subset(pupil_outlier == FALSE)%>%
     # subset(arousal_outler == FALSE)%>%
    subset(Group ==  "NT")%>%
    subset(ssid!= 356)%>%
      # subset(ssid!= 357)%>%
      subset(gaze_valid_tresh == "include")%>%
         # subset(as.numeric(ssid) < 500))
   subset(ssid!= 351))

summary(pupil_arousal_findings$pup_self_tasaq_no_outl_NT)

```


```{r}

# just ASD

pupil_arousal_findings$pup_self_tas_no_outl_ASD <- lmer(pup_basCor ~ (arousal)* 
                                                    TASc  +
                                                    # *Group_NT_pos+
  Mean_gray_z +
                                                      (1|stimIAPS2)+
                                                    (1  | ssid),
                                                  REML = FALSE,
                      data = db_full4new_stim_screen_pupil_select1%>%
    subset(pupil_outlier == FALSE)%>%
     subset(arousal_outler == FALSE)%>%
    subset(Group ==  "ASD")%>%
      subset(gaze_valid_tresh == "include"))


  # subset(ssid!= 356)%>% #clear pupil outlier
  # subset(ssid!= 351)%>%
  # subset(ssid!= 344)%>%
summary(pupil_arousal_findings$pup_self_tas_no_outl_ASD)


summary(pupil_arousal_findings$pup_self_tas_no_outl_NT)


interactions::interact_plot(pupil_arousal_findings$pup_self_tas_no_outl_NT, 
                            pred = arousal_c, modx = TASc)

```

#predict arousal now

```{r}
db_full4new_stim_screen_pupil_select1

pupil_arousal_findings$pupil_from_brightness_lm <- lm(pup_basCor ~ 
                                                    Mean,
                                                    
                      data = db_full4new_stim_screen_pupil_select1, na.action=na.exclude) 


summary(pupil_arousal_findings$pupil_from_brightness)

plot(pupil_arousal_findings$pupil_from_brightness)

# store residuals

db_full4new_stim_screen_pupil_select1$pup_resid_lm <- resid(pupil_arousal_findings$pupil_from_brightness_lm,
                                                            na.action=na.exclude)



pupil_arousal_findings$arous_pup_tas_no_outl_NT <- lmer(arousal ~ pup_basCor* 
                                                    TASc  +
                                                    # *Group_NT_pos+
  Mean_gray_z +
                                                      (1|stimIAPS2)+
                                                    (1  | ssid),
                                                  REML = FALSE,
                      data = db_full4new_stim_screen_pupil_select1%>%
    subset(pupil_outlier == FALSE)%>%
     subset(arousal_outler == FALSE)%>%
    subset(Group ==  "NT")%>%
    subset(ssid!= 356)%>%
      # subset(ssid!= 357)%>%
      subset(gaze_valid_tresh == "include")%>%
         # subset(as.numeric(ssid) < 500))
   subset(ssid!= 351))



summary(pupil_arousal_findings$arous_pup_tas_no_outl_NT)

```



Group, ignoring TAS

```{r}
pupil_arousal_findings$arous_pup_GR_no_outl <- lmer(pup_basCor ~ arousal_c* 
                                                    Group_NT_pos  +
  Mean_gray_z +
                                                      (1|stimIAPS2)+
                                                    (1  | ssid),
                                                  REML = FALSE,
                      data = db_full4new_stim_screen_pupil_select1%>%
    subset(pupil_outlier == FALSE)%>%
     subset(arousal_outler == FALSE)%>%
    # subset(Group ==  "NT")%>%
    subset(ssid!= 356)%>%
      # subset(ssid!= 357)%>%
      subset(gaze_valid_tresh == "include")%>%
         # subset(as.numeric(ssid) < 500))
   subset(ssid!= 351))

anova(pupil_arousal_findings$arous_pup_GR_no_outl)

summary(pupil_arousal_findings$arous_pup_GR_no_outl)

MuMIn::r.squaredGLMM(pupil_arousal_findings$arous_pup_GR_no_outl)

MuMIn::r.squaredGLMM(pupil_arousal_findings$pup_self_tas_no_outl_NT)

interactions::interact_plot(pupil_arousal_findings$arous_pup_GR_no_outl,
                            pred = arousal_c, modx = Group_NT_pos)

```

SCR

```{r}

db_full4new_stim_screen_pupil_select1

db_full4new_stim_screen_pupil_select1_scr<- db_full4new_stim_screen_pupil_select1

db_full4new_stim_screen_pupil_select1_scr<- 
  subset(db_full4new_stim_screen_pupil_select1_scr, as.numeric(as.character(ssid))>303)

unique(db_full4new_stim_screen_pupil_select1_scr$ssid)

db_full4new_stim_screen_pupil_select1_scr$ssid<- as.character(db_full4new_stim_screen_pupil_select1_scr$ssid)

db_full4new_stim_screen_pupil_select1_scr$ssid
 

db_full4new_stim_screen_pupil_select1_scr<- db_full4new_stim_screen_pupil_select1_scr%>%
       ungroup()%>%
  mutate(arousal_c = scale(arousal, center = TRUE, scale = TRUE)[,1],
         valence_c = scale(valence, center = TRUE, scale = TRUE)[,1],
         Mean_gray_z = scale(Mean)[,1],
         TASc = scale(TAS)[,1],
         AQc = scale(AQ)[,1],
         BPQc = scale(BPQ)[,1],
         WASIM_c =scale(WASIM)[,1],
         DASSTotalc = scale(DASSTotal)[,1])
 
  # ungroup%>%
  # mutate(valence_c = scale(valence, center = TRUE, scale = TRUE)[,1])%>%
  # mutate(arousal_c = scale(arousal, center = TRUE, scale = TRUE)[,1])%>%
  # mutate(TASc = scale(TAS, center = TRUE, scale = TRUE)[,1])
 
 # flag non responders
 
 
# db_full4new_stim_screen_pupil_select1_scr$bio
 
 # flag outliers

```

model

PHASI MAX
TTP

AMp SUm
SCR

```{r}
unique(db_full4new_stim_screen_pupil_select1_scr$ssid)

db_full4new_stim_screen_pupil_select1_scr %>%
 subset(arousal_outler == FALSE)%>%
       subset(BIO_CDA.SCR_outl  == FALSE)%>%
  subset(BIO_CDA.PhasicMax!= 0)%>%
  group_by(ssid)%>%
  mutate(BIO_CDA.PhasicMax_log = log1p(BIO_CDA.PhasicMax+.1))%>%
  mutate(BIO_CDA.PhasicMax_log_z = scale(BIO_CDA.PhasicMax_log))%>% 
  mutate(cor_scr_ar = cor(BIO_CDA.PhasicMax_z, arousal))%>%
  mutate(cor_scr_ar2 = cor(BIO_CDA.PhasicMax_log_z, arousal))%>%
  mutate(cor_scr_ar3 = cor(BIO_CDA.PhasicMax_log, arousal))%>%
  group_by(ssid, Group)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(TAS, cor_scr_ar))+
  geom_point()+
  geom_smooth(method = lm, se = F)+
  facet_grid(~Group)+
  ggpubr::stat_cor()

```


```{r}
lmer_scr_intero_thesis<- list()

db_full4new_stim_screen_pupil_select1_scr<- db_full4new_stim_screen_pupil_select1_scr%>%
  group_by(ssid)%>%
  mutate(BIO_CDA.SCR_z = scale(BIO_CDA.SCR))%>%
  # mutate(BIO_CDA.SCR_outl = if_else(log1p(BIO_CDA.SCR+.1)> (median(log1p(BIO_CDA.SCR+.1), na.rm = TRUE)+ 
  #                                     (20*(mad(log1p(BIO_CDA.SCR+.1), na.rm = TRUE)))), TRUE, FALSE))
  mutate(BIO_CDA.SCR_outl = if_else(abs(BIO_CDA.SCR_z)> 3, TRUE, FALSE))

table(db_full4new_stim_screen_pupil_select1_scr$ssid, db_full4new_stim_screen_pupil_select1_scr$BIO_CDA.SCR_outl)


lmer_scr_intero_thesis$SCR_ar_TAS <- lmer(log(BIO_CDA.SCR+.1) ~ arousal_c *
                                            TASc+
                                             (1|ssid) + 
                                            (1|stimIAPS),
                        REML = FALSE,
                        data = db_full4new_stim_screen_pupil_select1_scr%>%
     subset(arousal_outler == FALSE)%>%
       subset(BIO_CDA.SCR_outl  == FALSE)%>%
  subset(BIO_CDA.SCR!= 0)) # exlude non responding trials

anova(lmer_scr_intero_thesis$SCR_ar_TAS)

summary(lmer_scr_intero_thesis$SCR_ar_TAS)

range(db_full4new_stim_screen_pupil_select1_scr$BIO_CDA.ISCR, na.rm = TRUE)
range(db_full4new_stim_screen_pupil_select1_scr$BIO_CDA.SCR, na.rm = TRUE)
range(db_full4new_stim_screen_pupil_select1_scr$BIO_CDA.PhasicMax, na.rm = TRUE)
range(db_full4new_stim_screen_pupil_select1_scr$BIO_TTP.AmpSum, na.rm = TRUE)
table(is.na(db_full4new_stim_screen_pupil_select1_scr$BIO_CDA.ISCR))

flag_non_resp <- table(db_full4new_stim_screen_pupil_select1_scr$ssid, db_full4new_stim_screen_pupil_select1_scr$BIO_TTP.AmpSum == 0)



# just NT

lmer_scr_intero_thesis$SCR_ar_TAS_NT <- lmer(log(BIO_CDA.SCR+.1) ~ arousal_c *
                                            TASc+
                                             (1|ssid) + 
                                            (1|stimIAPS),
                        REML = FALSE,
                        data = db_full4new_stim_screen_pupil_select1_scr%>%
     subset(arousal_outler == FALSE)%>%
       subset(Group == "NT")%>%
         # subset(BIO_CDA.SCR!= 0)%>%
       subset(BIO_CDA.SCR_outl  == FALSE))


summary(lmer_scr_intero_thesis$SCR_ar_TAS_NT )

# just ASD

lmer_scr_intero_thesis$SCR_ar_TAS_ASD <- lmer(log(BIO_CDA.SCR+.1) ~ arousal_c *
                                            TASc+
                                             (1|ssid) + 
                                            (1|stimIAPS),
                        REML = FALSE,
                        data = db_full4new_stim_screen_pupil_select1_scr%>%
     subset(arousal_outler == FALSE)%>%
       subset(Group == "ASD")%>%
         # subset(BIO_CDA.SCR!= 0)%>%
       subset(BIO_CDA.SCR_outl  == FALSE))


summary(lmer_scr_intero_thesis$SCR_ar_TAS_ASD)
# same trend non significant

# group instead of TAS

lmer_scr_intero_thesis$SCR_ar_TAS_gr <- lmer(log(BIO_CDA.SCR+.1) ~ arousal_c *
                                            Group_NT_pos+
                                             (1|ssid) + 
                                            (1|stimIAPS),
                        REML = FALSE,
                        data = db_full4new_stim_screen_pupil_select1_scr%>%
     subset(arousal_outler == FALSE)%>%
       # subset(Group == "ASD")%>%
         # subset(BIO_CDA.SCR!= 0)%>%
       subset(BIO_CDA.SCR_outl  == FALSE))

summary(lmer_scr_intero_thesis$SCR_ar_TAS_gr )

anova(lmer_scr_intero_thesis$SCR_ar_TAS_gr )


summary(lmer(log(BIO_CDA.SCR+.1) ~ arousal_c *
                                            AQc+
                                             (1|ssid) + 
                                            (1|stimIAPS),
                        REML = FALSE,
                        data = db_full4new_stim_screen_pupil_select1_scr%>%
     subset(arousal_outler == FALSE)%>%
       # subset(Group == "NT")%>%
         # subset(BIO_CDA.SCR!= 0)%>%
       subset(BIO_CDA.SCR_outl  == FALSE))) # does not preddict shit


```

PhasiMax


```{r}
lmer_scr_intero_thesis<- list()

db_full4new_stim_screen_pupil_select1_scr<- db_full4new_stim_screen_pupil_select1_scr%>%
  group_by(ssid)%>%
  mutate(BIO_CDA.PhasicMax_z = scale(BIO_CDA.PhasicMax))%>%
  # mutate(BIO_CDA.SCR_outl = if_else(log1p(BIO_CDA.SCR+.1)> (median(log1p(BIO_CDA.SCR+.1), na.rm = TRUE)+ 
  #                                     (20*(mad(log1p(BIO_CDA.SCR+.1), na.rm = TRUE)))), TRUE, FALSE))
  mutate(BIO_CDA.PhasicMax_z_outl = if_else(abs(BIO_CDA.PhasicMax_z)> 3, TRUE, FALSE))

table(db_full4new_stim_screen_pupil_select1_scr$ssid, db_full4new_stim_screen_pupil_select1_scr$BIO_CDA.PhasicMax_z_outl)


lmer_scr_intero_thesis$PhasMax_ar_TAS <- lmer(log(BIO_CDA.PhasicMax+.1) ~ arousal_c *
                                            TASc+
                                             (1|ssid) + 
                                            (1|stimIAPS),
                        REML = FALSE,
                        data = db_full4new_stim_screen_pupil_select1_scr%>%
     subset(arousal_outler == FALSE)%>%
       # subset(as.numeric(ssid)<600)%>%
       subset(BIO_CDA.PhasicMax_z_outl  == FALSE))
  # subset(BIO_CDA.SCR!= 0)) # exlude non responding trials



anova(lmer_scr_intero_thesis$PhasMax_ar_TAS)

summary(lmer_scr_intero_thesis$PhasMax_ar_TAS)

# alexithymia main effect

scr_plots<-list()


scr_plots$TAS_scrME<-


db_full4new_stim_screen_pupil_select1_scr%>%
     subset(arousal_outler == FALSE)%>%
       # subset(as.numeric(ssid)<600)%>%
       subset(BIO_CDA.PhasicMax_z_outl  == FALSE)%>%
  subset(!is.na(TAS))%>%
  mutate(logBIO_CDA.PhasicMax = log1p(BIO_CDA.PhasicMax+.1))%>%
  group_by(ssid,TAS, Group)%>%
  # mutate(logBIO_CDA.PhasicMax_mean = mean(logBIO_CDA.PhasicMax, na.rm = TRUE))%>%
  group_by(ssid,stimIAPS2)%>%
  mutate(logBIO_CDA.PhasicMax_mean_stim = mean(logBIO_CDA.PhasicMax, na.rm = TRUE))%>%
  ggplot(aes(TASc,logBIO_CDA.PhasicMax))+
  geom_smooth(aes(group = stimIAPS2, y =logBIO_CDA.PhasicMax_mean_stim), 
              method=lm, se=FALSE, colour = "gray40", alpha = .01,linetype="dashed", size = .2 )+
  geom_smooth( method=lm, se=FALSE, linetype="dashed",
             color="darkred", size = 2)+
  stat_summary(aes(color = Group), geom = 'pointrange', pch = 1)+
   # geom_ysidedensity(aes(x=stat(density), alpha = .4))+
   # geom_xsidedensity(aes(y=stat(density), alpha = .4))+
    # geom_point(aes(color = ssid),size =2, pch  = 1)+
  xlab("Alexithymia (Z)")+
  ylab("SCR (log)")+
p$graphstyle

scr_plots$TAS_scrME
  
scr_plots$TAS_scrME<- scr_plots$TAS_scrME+
  scale_y_continuous(breaks = c(0, .5, 1, 1.5))+
  scale_x_continuous(breaks = c(-2, -1, 0, 1, 2), limits = c(-2, 2.5))+
  scale_color_brewer(palette = "Dark2")

scr_plots$TAS_scrME

scr_plots$TAS_scr_int_ns<- interactions::interact_plot(lmer_scr_intero_thesis$PhasMax_ar_TAS, pred = arousal_c, modx = TASc) +
  scale_x_continuous(breaks = c(-2,-1, 0,1, 2), limits = c(-2,2.4))+
  scale_y_continuous(limits = c(-1.5, -.7))+
# plots_paper$interaction_ar_vl +
  theme_classic()+
  p$graphstyle_int+
  xlab("Subjective arousal (z)")+
  ylab("SCR (log)")
  

scr_plots$TAS_scrME
scr_plots$TAS_scr_int_ns
```


aq plot

```{r}
scr_plots$AQ_scrME<-
db_full4new_stim_screen_pupil_select1_scr%>%
     subset(arousal_outler == FALSE)%>%
       # subset(Group == "NT")%>%
       subset(BIO_CDA.PhasicMax_z_outl  == FALSE)%>%
  subset(!is.na(TAS))%>%
  mutate(logBIO_CDA.PhasicMax = log1p(BIO_CDA.PhasicMax+.1))%>%
  group_by(ssid,TAS, Group)%>%
  mutate(logBIO_CDA.PhasicMax_mean = mean(logBIO_CDA.PhasicMax, na.rm = TRUE))%>%
  group_by(ssid,stimIAPS2)%>%
  mutate(logBIO_CDA.PhasicMax_mean_stim = mean(logBIO_CDA.PhasicMax, na.rm = TRUE))%>%
  # summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(AQc,logBIO_CDA.PhasicMax))+
  # stat_summary(geom = 'pointrange')+
  
  geom_smooth(aes(group = stimIAPS2, y =logBIO_CDA.PhasicMax_mean_stim), method=lm, se=FALSE, colour = "gray40", alpha = .01,linetype="dashed", size = .2 )+
  geom_smooth( method=lm, se=FALSE, linetype="dashed",
             color="darkred", size = 2)+
  stat_summary(aes(color = Group), geom = 'pointrange', pch = 1)+
   # geom_ysidedensity(aes(x=stat(density), alpha = .4))+
   # geom_xsidedensity(aes(y=stat(density), alpha = .4))+
    # geom_point(aes(color = ssid),size =2, pch  = 1)+
  
  
  # ggpubr::stat_cor()+
  xlab("Autism (Z)")+
  ylab("SCR")+
p$graphstyle


scr_plots$AQ_scrME
  
scr_plots$AQ_scrME<- scr_plots$AQ_scrME+
  scale_y_continuous(breaks = c(0, .5, 1, 1.5))+
  scale_x_continuous(breaks = c(-2, -1, 0, 1, 2), limits = c(-2, 2.5))+
  scale_color_brewer(palette = "Dark2")

scr_plots$AQ_scrME

scr_plots$AQ_scr_int_ns <- interactions::interact_plot(lmer_scr_intero_thesis$PhasMax_ar_, pred = arousal_c, modx = TASc) +
  scale_x_continuous(breaks = c(-2,-1, 0,1, 2), limits = c(-2,2.4))+
  scale_y_continuous(limits = c(-1.5, -.7))+
# plots_paper$interaction_ar_vl +
  theme_classic()+
  p$graphstyle_int+
  xlab("Subjective arousal (z)")+
  ylab("SCR (log)")
  

scr_plots$patchwork_SCRME<- (scr_plots$TAS_scrME+ scr_plots$AQ_scrME)+
    plot_layout(ncol = 2)+plot_annotation(tag_levels = "A")

ggsave("patchwork_SCRME.tiff", scr_plots$patchwork_SCRME, 
       device = "tiff", width = 10, height = 4, dpi = 800)



```


```{r}


# TAS +aq
lmer_scr_intero_thesis$PhasMax_ar_TAS_aq <- lmer(log(BIO_CDA.PhasicMax+.1) ~ arousal_c *
                                            (TASc+AQc)+
                                             (1|ssid) + 
                                            (1|stimIAPS),
                        REML = FALSE,
                        data = db_full4new_stim_screen_pupil_select1_scr%>%
     subset(arousal_outler == FALSE)%>%
       subset(BIO_CDA.PhasicMax_z_outl  == FALSE)%>%
       subset(Group == "NT"))
  # subset(BIO_CDA.SCR!= 0)) # exlude non responding trials

anova(lmer_scr_intero_thesis$PhasMax_ar_TAS_aq)

summary(lmer_scr_intero_thesis$PhasMax_ar_TAS_aq)





# just NT

lmer_scr_intero_thesis$phasmax_ar_TAS_NT <- lmer(log(BIO_CDA.PhasicMax+.1) ~ arousal_c *
                                            TASc+
                                             (1|ssid) + 
                                            (1|stimIAPS),
                        REML = FALSE,
                        data = db_full4new_stim_screen_pupil_select1_scr%>%
     subset(arousal_outler == FALSE)%>%
       subset(BIO_CDA.PhasicMax_z_outl  == FALSE)%>%
       subset(Group == "NT"))


summary(lmer_scr_intero_thesis$phasmax_ar_TAS_NT )

# just ASD

lmer_scr_intero_thesis$phasmax_ar_TAS_ASD <- lmer(log(BIO_CDA.PhasicMax+.1) ~ arousal_c *
                                            TASc+
                                             (1|ssid) + 
                                            (1|stimIAPS),
                        REML = FALSE,
                        data = db_full4new_stim_screen_pupil_select1_scr%>%
     subset(arousal_outler == FALSE)%>%
       subset(BIO_CDA.PhasicMax_z_outl  == FALSE)%>%
       subset(Group == "ASD"))


summary(lmer_scr_intero_thesis$phasmax_ar_TAS_ASD)

MuMIn::r.squaredGLMM(lmer_scr_intero_thesis$phasmax_ar_TAS_ASD)
# same trend non significant

# group instead of TAS

lmer_scr_intero_thesis$phasmax_ar_TAS_gr <- lmer(log(BIO_CDA.PhasicMax+.1) ~ arousal_c *
                                            Group_NT_pos+
                                             (1|ssid) + 
                                            (1|stimIAPS),
                        REML = FALSE,
                        data = db_full4new_stim_screen_pupil_select1_scr%>%
     subset(arousal_outler == FALSE)%>%
       subset(BIO_CDA.PhasicMax_z_outl  == FALSE))
       # subset(Group == "ASD"))

summary(lmer_scr_intero_thesis$SCR_ar_TAS_gr )
#  the effect is tas not group

anova(lmer_scr_intero_thesis$SCR_ar_TAS_gr )


summary(lmer(log(BIO_CDA.PhasicMax+.1) ~ arousal_c *
                                            AQc+
                                             (1|ssid) + 
                                            (1|stimIAPS),
                        REML = FALSE,
                        data = db_full4new_stim_screen_pupil_select1_scr%>%
     subset(arousal_outler == FALSE)%>%
       subset(Group == "ASD")%>%
       subset(BIO_CDA.PhasicMax_z_outl  == FALSE))) # does not preddict shit

unique(db_full4new_stim_screen_pupil_select1_scr$ssid)
```
heart rate




```{r}

# keep stim and and fixation
unique(db_356_357_611_616$ssid)
library(readr)
library(readr)
 # read_csv("tmp.df4_sum_full_bio_hr_self_parsed_345_356.csv")
View(tmp_df4_sum_full_bio_hr_self_parsed_345_356)
unique(db_356_357_611_616$screen_content)

# db_356_357_611_616  equivalent to db_HR_bio_final_346_355_withfix

db_356_357_611_616$screencontent
db_356_357_611_616$screen_content
db_356_357_611_616$screencontent_no
range(db_356_357_611_616$tNo)

# db_HR_bio_final_346_355_withfix$screencontent<- db_HR_bio_final_346_355_withfix$screen_content
# db_HR_bio_final_346_355_withfix<- subset(db_HR_bio_final_346_355_withfix, tNo > -7)

# db_HR_bio_final_346_355_withfix$screencontent_no<- if_else(db_HR_bio_final_346_355_withfix$screen_content == "fixation", 1,
#                                                            if_else(db_HR_bio_final_346_355_withfix$screen_content == "stim", 2,
#                                                                    if_else(db_HR_bio_final_346_355_withfix$screen_content == "valence", 3, 4)))

# db_HR_bio_final_346_355_withfix_stim <- subset(db_HR_bio_final_346_355_withfix, screencontent_no<3)
db_356_357_611_616_withfix_stim <- subset(db_356_357_611_616, screencontent_no<3)
unique(db_356_357_611_616$ssid)

colnames(db_HR_bio_final_346_355_withfix_stim)
colnames(db_356_357_611_616_withfix_stim)
db_356_357_611_616_withfix_stim$tNo2<-NULL
db_356_357_611_616_withfix_stim$tNo3<- NULL

unique(db_356_357_611_616_withfix_stim$screencontent)

unique(db_full6new_hr_fix_stim$screencontent)

colnames(db_full6new)

# 
db_full6new_hr_fix_stim <- subset(db_full6new, screencontent_no <3)

View(db_full6new_hr_fix_stim)


colnames(db_full6new_hr_fix_stim)

colnames(db_356_357_611_616_withfix_stim)


# create a similar heart rate column
db_356_357_611_616_withfix_stim$Bio_Mean_HR<- db_356_357_611_616_withfix_stim$Mean_HR

table(is.na(db_356_357_611_616_withfix_stim$Bio_Mean_HR))

db_356_357_611_616_withfix_stim$ssid_num<- as.numeric(db_356_357_611_616_withfix_stim$ssid)
unique(db_356_357_611_616_withfix_stim$ssid)
# keep controls
unique(db_full6new_hr_fix_stim$ssid)
db_full6new_hr_fix_stim$ssid_num <- as.numeric(as.character(db_full6new_hr_fix_stim$ssid))


table(is.na(db_full6new_hr_fix_stim))

db_full6new_hr_fix_stim$Group<- if_else(db_full6new_hr_fix_stim$ssid_num< 500, "NT",
                                        if_else(db_full6new_hr_fix_stim$ssid_num>700, "NT",
                                                "ASD"))

table(is.na(db_full6new_hr_fix_stim$Group))
unique(db_full6new_hr_fix_stim$Group)


# db_full6new_hr_fix_stim_nt<- subset(db_full6new_hr_fix_stim, Group == "NT")
unique(db_full6new_hr_fix_stim$ssid_num)

# attention - keep the oens that ahve bio data

db_full6new_hr_fix_stim_backup<- db_full6new_hr_fix_stim

db_full6new_hr_fix_stim<- subset(db_full6new_hr_fix_stim, ssid_num> 303)
unique(db_full6new_hr_fix_stim$ssid)
colnames(db_full6new_hr_fix_stim)

# HR differences
db_full6new_hr_fix_stim$Bio_Mean_HR_fix<- if_else(db_full6new_hr_fix_stim$screencontent_no ==1, db_full6new_hr_fix_stim$Bio_Mean_HR, NULL)



# 346_355
unique(db_HR_bio_final_346_355_withfix_stim$ssid)

db_HR_bio_final_346_355_withfix_stim$Bio_Mean_HR_fix<- if_else(db_HR_bio_final_346_355_withfix_stim$screencontent_no ==1, db_HR_bio_final_346_355_withfix_stim$Bio_Mean_HR, NULL)

View(db_full6new_hr_fix_stim)
View(db_HR_bio_final_346_355_withfix_stim)

db_HR_bio_final_346_355_withfix_stim$Mean_HR<- NULL

db_HR_bio_final_346_355_withfix_stim$ssid<- as.character(db_HR_bio_final_346_355_withfix_stim$ssid)


db_HR_bio_final_346_355_withfix_stim$tNo <- db_HR_bio_final_346_355_withfix_stim$tNo3.x
unique(db_HR_bio_final_346_355_withfix_stim$tNo)

db_HR_bio_final_346_355_withfix_stim$tNo <- as.character(db_HR_bio_final_346_355_withfix_stim$tNo)
db_HR_bio_final_346_355_withfix_stim$trigger <- as.character(db_HR_bio_final_346_355_withfix_stim$trigger)


# 356_611
db_356_357_611_616_withfix_stim

db_356_357_611_616_withfix_stim$Bio_Mean_HR_fix<- if_else(db_356_357_611_616_withfix_stim$screencontent_no ==1, db_356_357_611_616_withfix_stim$Bio_Mean_HR, NULL)

db_356_357_611_616_withfix_stim$Bio_Mean_HR

# View(db_full6new_hr_fix_stim)
# View(db_356_357_611_616_withfix_stim)

db_356_357_611_616_withfix_stim$Mean_HR<- NULL

db_356_357_611_616_withfix_stim$ssid<- as.character(db_356_357_611_616_withfix_stim$ssid)


db_356_357_611_616_withfix_stim$tNo <- db_356_357_611_616_withfix_stim$tNo3.x
unique(db_356_357_611_616_withfix_stim$tNo)

db_356_357_611_616_withfix_stim$tNo <- as.character(db_356_357_611_616_withfix_stim$tNo)
db_356_357_611_616_withfix_stim$trigger <- as.character(db_356_357_611_616_withfix_stim$trigger)


# current
db_full6new_hr_fix_stim$trigger<- as.character(db_full6new_hr_fix_stim$trigger)
db_full6new_hr_fix_stim$trigger.x<- NULL

# db_HR_bio_final_346_355_withfix_stim$trig <- as.character(db_HR_bio_final_346_355_withfix_stim$tNo)

# db_HR_bio_final_346_355_withfix_stim$triger<- NULL
db_HR_bio_final_346_355_withfix_stim$trigger.x<- NULL
db_HR_bio_final_346_355_withfix_stim$trigger.y<- NULL
db_HR_bio_final_346_355_withfix_stim$trigger2<- NULL
db_HR_bio_final_346_355_withfix_stim$trigger_200<- NULL
# 356_616
db_356_357_611_616_withfix_stim$trigger.x<- NULL
db_356_357_611_616_withfix_stim$trigger.y<- NULL
db_356_357_611_616_withfix_stim$trigger2<- NULL
db_356_357_611_616_withfix_stim$trigger_200<- NULL

nrow(db_full6new_hr_fix_stim)+ nrow(db_HR_bio_final_346_355_withfix_stim)
# 6895


# nrow(bind_rows(db_full6new_hr_fix_stim_nt, db_HR_bio_final_346_355_withfix_stim))
db_HR_bio_final_346_355_withfix_stim$Bio_Mean_HR_fix

colnames(db_HR_bio_final_346_355_withfix_stim)
colnames(db_356_357_611_616_withfix_stim)
db_356_357_611_616_withfix_stim

db_HR_bio_final_346_355_withfix_stim

as.factor(db_HR_bio_final_346_355_withfix_stim$stim.x)
as.factor(db_HR_bio_final_346_355_withfix_stim$stim.y)
db_HR_bio_final_346_355_withfix_stim$stim.y<- NULL
db_356_357_611_616_withfix_stim$stim.y<- NULL

# unique(db_HR_bio_final_346_355_withfix_stim$screencontent)
# unique(db_full6new_hr_fix_stim_nt$screencontent)
# unique(db_full6new_hr_fix_stim_nt$screencontent.y)

db_full6new_hr_fix_stim$screencontent.x<- NULL
db_full6new_hr_fix_stim$screencontent.y<- NULL

unique(db_full6new_hr_fix_stim$trialUnq.x)
unique(db_full6new_hr_fix_stim$trialUnq.y)

db_full6new_hr_fix_stim$trialUnq<- db_full6new_hr_fix_stim$trialUnq.x
db_full6new_hr_fix_stim$trialUnq.y<- NULL
db_full6new_hr_fix_stim$trialUnq.x<- NULL


db_HR_bio_final_346_355_withfix_stim$stim<- db_HR_bio_final_346_355_withfix_stim$stim.x
db_356_357_611_616_withfix_stim$stim<- db_356_357_611_616_withfix_stim$stim.x
# db_356_357_611_616_withfix_stim$stim<- db_356_357_611_616_withfix_stim$stim.x

# bind heartrate old and new
table(is.na(db_HR_bio_final_346_355_withfix_stim$Bio_Mean_HR))
table(is.na(db_356_357_611_616_withfix_stim$Bio_Mean_HR))
table(is.na(db_full6new_hr_fix_stim$Bio_Mean_HR))
test<- subset(db_full6new_hr_fix_stim, is.na(Bio_Mean_HR))
test1<- subset(db_HR_bio_final_346_355_withfix_stim, is.na(Bio_Mean_HR))


# select only needed columns
colnames(db_full6new_hr_fix_stim)
db_full6new_hr_fix_stim_select<- db_full6new_hr_fix_stim%>%
  select(ssid:gaze_valid_prop,stimDescription:arousal,TAS, AQ,DASSAnxiety:DASSTotal,
         BPQ, WASIM, screencontent_no,BIO_CDA.AmpSum:BIO_Global.Mean, fix_count:mean_fix_dur,
         sac_count:SacAmp, Bio_Mean_HR,Bio_Mean_HR_fix, ssid_num, trialUnq)

hr_select<- colnames(db_full6new_hr_fix_stim_select)

db_HR_bio_final_346_355_withfix_stim$hr

db_HR_bio_final_346_355_withfix_stim_select<- select(db_HR_bio_final_346_355_withfix_stim,
                                                     hr_select)

db_356_357_611_616_withfix_stim_select <- select(db_356_357_611_616_withfix_stim,
                                                     hr_select)


  

db_full6new_hr_fix_stim1<- bind_rows(db_full6new_hr_fix_stim,
                                        db_HR_bio_final_346_355_withfix_stim)


db_full6new_hr_fix_stim_select1 <- bind_rows(db_full6new_hr_fix_stim_select,
                                     db_HR_bio_final_346_355_withfix_stim_select,
                                        db_356_357_611_616_withfix_stim_select)

unique(db_356_357_611_616_withfix_stim_select$ssid)

unique(db_full6new_hr_fix_stim_select1$ssid)

db_full6new_hr_fix_stim_select1$Bio_Mean_HR_fix
db_full6new_hr_fix_stim_select1$Bio_Mean_HR

table(is.na(db_full6new_hr_fix_stim_select1$Bio_Mean_HR))
test<- subset(db_full6new_hr_fix_stim_select1, is.na(Bio_Mean_HR))
unique(test$ssid)

# create heart rare dif
# start by populating fixation heart rate next to stim heart rate
db_full6new_hr_fix_stim_select2<- db_full6new_hr_fix_stim_select1 %>%
  # mutate()
  group_by(as.numeric(ssid_num), as.numeric(tNo)) %>%
  arrange(ssid_num, as.numeric(tNo),as.numeric(screencontent_no))%>%
  # select(ssid, tNo,screencontent_no, Bio_Mean_HR,Bio_Mean_HR_fix)
  fill(Bio_Mean_HR_fix, .direction = "down")%>%
  subset(screencontent_no == 2)

# Now create the difference score
# stim - fix = positive stim> neg stim<
db_full6new_hr_fix_stim_select2<- db_full6new_hr_fix_stim_select2 %>%
  mutate(Bio_Mean_HR_dif = Bio_Mean_HR - Bio_Mean_HR_fix)

db_full6new_hr_fix_stim_select2%>%
  ggplot(aes(Bio_Mean_HR_dif))+
  geom_histogram()

# flag heart rate outliers
# b_full6new_hr_fix_stim_nt1.1$Bio_Mean_HR_dif_outl <- if_else(abs(db_full6new_hr_fix_stim_nt1.1$Bio_Mean_HR_dif)>                                                   (median(abs(db_full6new_hr_fix_stim_nt1.1$Bio_Mean_HR_dif),na.rm = TRUE) +                                                               (4*(sd(abs(db_full6new_hr_fix_stim_nt1.1$Bio_Mean_HR_dif), na.rm = TRUE))))

db_full6new_hr_fix_stim_select2<-
db_full6new_hr_fix_stim_select2%>%
  group_by(ssid)%>%
  mutate(Bio_Mean_HR_dif_outl = if_else(abs(Bio_Mean_HR_dif) > (median(abs(Bio_Mean_HR_dif), na.rm = TRUE) + (3*sd(abs(Bio_Mean_HR_dif), na.rm = TRUE))), "outlier", "not outlier"))


db_full6new_hr_fix_stim_select2%>%
  subset(Bio_Mean_HR_dif_outl == "outlier")%>%
  ggplot(aes(Bio_Mean_HR_dif))+
  geom_histogram()+
  facet_grid(~Bio_Mean_HR_dif_outl)


db_full6new_hr_fix_stim_select2%>%
  subset(ssid == 609)%>%
  # subset(Bio_Mean_HR_dif_outl == "outlier")%>%
  ggplot(aes(Bio_Mean_HR_dif, color =Bio_Mean_HR_dif_outl ))+
  geom_histogram()
  facet_grid(~Bio_Mean_HR_dif_outl)
  
  table(db_full6new_hr_fix_stim_select2$ssid, db_full6new_hr_fix_stim_select2$Bio_Mean_HR_dif_outl)

```


create the scaled variables needed
```{r}
db_full6new_hr_fix_stim_select2

db_full6new_hr_fix_stim_select2<- db_full6new_hr_fix_stim_select2%>%
       ungroup()%>%
  mutate(arousal_c = scale(arousal, center = TRUE, scale = TRUE)[,1],
         valence_c = scale(valence, center = TRUE, scale = TRUE)[,1],
         # Mean_gray_z = scale(Mean)[,1],
         TASc = scale(TAS)[,1],
         AQc = scale(AQ)[,1],
         BPQc = scale(BPQ)[,1],
         WASIM_c =scale(WASIM)[,1],
         DASSTotalc = scale(DASSTotal)[,1])

db_full6new_hr_fix_stim_select2$stim
db_full6new_hr_fix_stim_select2$stimIAPS2 <- substring(db_full6new_hr_fix_stim_select2$trialUnq)

db_full6new_hr_fix_stim_select2$Group <- if_else(db_full6new_hr_fix_stim_select2$ssid_num>500 & 
                                                   db_full6new_hr_fix_stim_select2$ssid_num< 700, "ASD", "NT")

unique(db_full6new_hr_fix_stim_select2$ssid)
db_full6new_hr_fix_stim_select2 %>%
    subset(Bio_Mean_HR_dif_outl == "not outlier")%>%
  subset(ssid_num < 800)%>%
    subset(ssid_num != 356)%>% # outlier
  # subset(ssid_num<500)%>%
  # group_by(ssid)%>%
  # mutate(Bio_Mean_HR_dif = abs(Bio_Mean_HR_dif))%>%
  ungroup()%>%
  mutate(Bio_Mean_HR_dif_stim_z = scale(Bio_Mean_HR_dif))%>%
  group_by(ssid, Group)%>%
  
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(TASc, Bio_Mean_HR_dif_stim_z))+
  # geom_point()+
  geom_text(aes(label = ssid))+
  # geom_smooth(aes(group = stimIAPS, y =Bio_Mean_HR_dif_stim), method=lm, se=FALSE, colour = "gray40", alpha = .01,linetype="dashed", size = .2 )+
  geom_smooth( method=lm, se=FALSE, linetype="dashed",
             color="darkred", size = 2)+
  # stat_summary(geom = 'pointrange', pch = 1)+
    ggpubr::stat_cor()+
  p$graphstyle+
  xlab("Alexithymia (Z)")+
  ylab("HR difference")+
  facet_grid(~Group)+
p$graphstyle

db336<- subset(db_full6new_hr_fix_stim_select2, ssid == 336)
db340<- subset(db_full6new_hr_fix_stim_select2, ssid == 340)

table(db336$Bio_Mean_HR_dif_outl)
table(db340$Bio_Mean_HR_dif_outl)

```


correlation heart rate arousal
```{r}
db_full6new_hr_fix_stim_select2 %>%
  subset(Bio_Mean_HR_dif_outl == "not outlier")%>%
  subset(ssid_num != 356)%>% # outlier
  group_by(ssid)%>%
  mutate(cor_hr_ar = cor(Bio_Mean_HR_dif, arousal))%>%
  group_by(ssid, Group)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(TAS,  cor_hr_ar))+
  # geom_point()+
  geom_text(aes(label=  ssid))+
  facet_grid(~Group)+
  geom_smooth(method = lm, se = F)+
  ggpubr::stat_cor()


```

```{r}
# db_full6new_hr_fix_stim_select2 %>%
#   subset(Bio_Mean_HR_dif_outl == "not outlier")%>%
#   subset(ssid_num != 356)%>% # outlier
#   group_by(ssid)%>%
#   mutate(cor_hr_ar = cor(Bio_Mean_HR_dif, valence))%>%
#   group_by(ssid, Group)%>%
#   summarise_if(is.numeric, mean, na.rm = TRUE)%>%
#   ggplot(aes(TAS,  cor_hr_ar))+
#   # geom_point()+
#   geom_text(aes(label=  ssid))+
#   facet_grid(~Group)+
#   geom_smooth(method = lm, se = F)+
#   ggpubr::stat_cor()


db_full6new_hr_fix_stim_select2<- db_full6new_hr_fix_stim_select2%>%
  group_by(Group)%>%
  mutate(Alexithymia_mediansplit_withinGr = if_else(TAS > median(TAS, na.rm = TRUE), "High", 'Low'))

db_full6new_hr_fix_stim_select2 %>%
  subset(Bio_Mean_HR_dif_outl == "not outlier")%>%
  subset(ssid_num != 356)%>% # outlier
  group_by(ssid)%>%
  mutate(cor_hr_ar = cor(Bio_Mean_HR_dif, arousal))%>%
  group_by(ssid, Group)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(Group,  cor_hr_ar))+
 
  geom_jitter(width = .1, alpha = .1)+
   stat_summary(geom = 'pointrange')+
  
  # geom_point()+
  # geom_text(aes(label=  ssid))+
  # facet_grid(~Group)+
  geom_smooth(method = lm, se = F)+
  ggpubr::stat_compare_means()


# mediansplit b alexithymia
db_full6new_hr_fix_stim_select2 %>%
  subset(Bio_Mean_HR_dif_outl == "not outlier")%>%
  subset(ssid_num != 356)%>% # outlier
  subset(!is.na(TAS))%>%
  group_by(ssid)%>%
  mutate(cor_hr_ar = cor(Bio_Mean_HR_dif, arousal))%>%
  group_by(ssid,Group, Alexithymia_mediansplit_withinGr)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(Alexithymia_mediansplit_withinGr,  cor_hr_ar))+
 
  # geom_jitter(width = .1, alpha = .1)+
   stat_summary(geom = 'pointrange')+
  
  # geom_point()+
  geom_text(aes(label=  ssid))+
  facet_grid(~Group)+
  geom_smooth(method = lm, se = F)+
  ggpubr::stat_compare_means()
  

```

lmer models of hr

```{r}

lmer_hr_interoThesis<- list()
db_full4new_stim_screen_pupil_select1_scr


db_full6new_hr_fix_stim_select2$stim <- as.factor(db_full6new_hr_fix_stim_select2$stim)
db_full6new_hr_fix_stim_select2$ssid <- as.factor(db_full6new_hr_fix_stim_select2$ssid)

lmer_hr_interoThesis$biohr_tas_arous <- lmer(Bio_Mean_HR_dif ~ TASc * arousal_c + 
                 (1|ssid) + 
                   # (1|Group)+
                 (1| stim),
     REML = FALSE,
     data = db_full6new_hr_fix_stim_select2 %>%
       subset(Bio_Mean_HR_dif_outl == "not outlier")%>%
       subset(ssid!= 336)%>%
       subset(ssid!= 356))
     # %>%
   # subset(ssid!= 351))

summary(lmer_hr_interoThesis$biohr_tas_arous )

# just NT

lmer_hr_interoThesis$biohr_tas_arous_NT <- lmer(Bio_Mean_HR_dif ~ TASc * arousal_c + 
                 (1|ssid) + 
                 (1| stim),
     REML = FALSE,
     data = db_full6new_hr_fix_stim_select2 %>%
       subset(Bio_Mean_HR_dif_outl == "not outlier")%>%
       subset(ssid!= 356)%>%
        subset(ssid!= 336)%>%
       
       subset(Group == "NT"))

summary(lmer_hr_interoThesis$biohr_tas_arous_NT)

?interactions::probe_interaction
interactions::probe_interaction(lmer_hr_interoThesis$biohr_tas_arous_NT, pred =arousal_c, modx = TASc )
interactions::interact_plot(lmer_hr_interoThesis$biohr_tas_arous, pred =arousal_c, modx = TASc )







```


```{r}
# aq

lmer_hr_interoThesis$biohr_aq_arous_NT <- lmer(Bio_Mean_HR_dif ~ AQc * arousal_c + 
                 (1|ssid) + 
                 (1| stim),
     REML = FALSE,
     data = db_full6new_hr_fix_stim_select2 %>%
       subset(Bio_Mean_HR_dif_outl == "not outlier")%>%
       subset(ssid!= 356)%>%
        subset(ssid!= 336)%>%
       
       subset(Group == "NT"))

summary(lmer_hr_interoThesis$biohr_aq_arous_NT)

interactions::interact_plot(lmer_hr_interoThesis$biohr_aq_arous_NT, pred =arousal_c, modx = AQc )
```

# tas and aq

```{r}

lmer_hr_interoThesis$biohr_tasaq_arous_NT <- lmer(Bio_Mean_HR_dif ~ (TASc+AQc) * arousal_c + 
                 (1|ssid) + 
                 (1| stim),
     REML = FALSE,
     data = db_full6new_hr_fix_stim_select2 %>%
       subset(Bio_Mean_HR_dif_outl == "not outlier")%>%
       subset(ssid!= 356)%>%
        subset(ssid!= 336)%>%
       
       subset(Group == "NT"))

summary(lmer_hr_interoThesis$biohr_tasaq_arous_NT)


```

HR plots
```{r}

hr_plots<- list()
hr_plots$tas_hrdif<- db_full6new_hr_fix_stim_select2 %>%
       subset(Bio_Mean_HR_dif_outl == "not outlier")%>%

  # subset(ssid!= 900)
       subset(ssid!= 356)%>%
   subset(ssid!= 336)%>%
  subset(ssid!= 340)%>%
   # subset(ssid!= 332)%>%
  subset(Group == "NT")%>%
  ungroup()%>%
  # group_by(ssid)%>%
  # mutate(Bio_Mean_HR_dif = Bio_Mean_HR_dif/(mean(Bio_Mean_HR_dif, na.rm = TRUE)))%>%
  group_by(ssid, Group)%>%
  
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(TASc, Bio_Mean_HR_dif))+
  # geom_point(size = 2, pch = 1)+
  
  # geom_text(aes(label = ssid))+
  
  # geom_smooth(aes(group = stim, y =Bio_Mean_HR_dif), method=lm, se=FALSE, colour = "gray40", alpha = .01,linetype="dashed", size = .2 )+
  geom_smooth( method=lm, se=FALSE, linetype="dashed",
             color="darkred", size = 2)+
  stat_summary(aes(label = ssid),geom = 'pointrange', pch = 1)+
  # stat_ellipse()+
  # ggpubr::stat_cor()+
  p$graphstyle+
  xlab("Alexithymia (Z)")+
  ylab("HR difference (Z)")+
p$graphstyle


hr_plots$tas_hrdif

hr_plots$tas_hrdif
  # scale_y_continuous(limits = c(-10,-2))+
  # scale_x_continuous(breaks = c(-2, -1, 0, 1, 2), limits = c(-2, 2.5))
  # scale_color_brewer(palette = "Dark2")


# hr interaction

interactions::interact_plot(lmer_hr_interoThesis$biohr_tas_arous, pred =arousal_c, modx = TASc )

hr_plots$int_tas_hr<-
interactions::interact_plot(lmer_hr_interoThesis$biohr_tas_arous_NT, pred =arousal_c, modx = TASc ) +
  scale_x_continuous(breaks = c(-2,-1, 0,1, 2), limits = c(-2,2.4))+
  scale_y_continuous(limits = c(-4, -1.5))+
# plots_paper$interaction_ar_vl +
  theme_classic()+
  p$graphstyle_int+
  xlab("Subjective arousal (z)")+
  ylab(expression(Delta*" heart rate (bpm)"))
  
hr_plots$int_tas_hr


# AQ


hr_plots$AQ_hrdif<- db_full6new_hr_fix_stim_select2 %>%
       subset(Bio_Mean_HR_dif_outl == "not outlier")%>%

  # subset(ssid!= 900)
       subset(ssid!= 356)%>%
   subset(ssid!= 336)%>%
  subset(ssid!= 340)%>%
   # subset(ssid!= 332)%>%
  subset(Group == "NT")%>%
  ungroup()%>%
  # group_by(ssid)%>%
  # mutate(Bio_Mean_HR_dif = Bio_Mean_HR_dif/(mean(Bio_Mean_HR_dif, na.rm = TRUE)))%>%
  group_by(ssid, Group)%>%
  
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(AQc, Bio_Mean_HR_dif))+
  
  # geom_text(aes(label = ssid))+
  
  # geom_smooth(aes(group = stim, y =Bio_Mean_HR_dif), method=lm, se=FALSE, colour = "gray40", alpha = .01,linetype="dashed", size = .2 )+
  geom_smooth( method=lm, se=FALSE, linetype="dashed",
             color="darkred", size = 2)+
  stat_summary(aes(label = ssid),geom = 'pointrange', pch = 1)+
  # stat_ellipse()+
  # ggpubr::stat_cor()+
  p$graphstyle+
  xlab("Autism (Z)")+
  ylab("HR difference (Z)")+
p$graphstyle



# hr interaction with AQ

interactions::interact_plot(lmer_hr_interoThesis$biohr_aq_arous_NT, pred =arousal_c, modx = AQc )

hr_plots$int_aq_hr<-
interactions::interact_plot(lmer_hr_interoThesis$biohr_aq_arous_NT, pred =arousal_c, modx = AQc ) +
  scale_x_continuous(breaks = c(-2,-1, 0,1, 2), limits = c(-2,2.4))+
  scale_y_continuous(limits = c(-4, -1.5))+
# plots_paper$interaction_ar_vl +
  theme_classic()+
  p$graphstyle_int+
  xlab("Subjective arousal (z)")+
  ylab(expression(Delta*" heart rate (bpm)"))
  
hr_plots$int_aq_hr



# hr patchwork
hr_plots$patchwork_hr <- (hr_plots$tas_hrdif + hr_plots$AQ_hrdif + hr_plots$int_tas_hr + hr_plots$int_aq_hr)+
  plot_layout(ncol = 2)+plot_annotation(tag_levels = "A")



ggsave("patchwork_hr.tiff", hr_plots$patchwork_hr, 
       device = "tiff", width = 14, height = 10, dpi = 800)

```



```{r}


db_full6new_hr_fix_stim_select2 %>%
       subset(Bio_Mean_HR_dif_outl == "not outlier")%>%
  
       subset(ssid!= 356)%>%
   subset(ssid!= 336)%>%
  subset(ssid!= 340)%>%
   # subset(ssid!= 332)%>%
  subset(Group == "NT")%>%
  # ungroup()%>%
  # group_by(ssid)%>%
  mutate(Bio_Mean_HR_dif = scale(Bio_Mean_HR_dif))%>%
  group_by(ssid, stim, Group)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(TASc, Bio_Mean_HR_dif))+
  
  # geom_text(aes(label = ssid))+
  
  # geom_smooth(aes(group = stim, y =Bio_Mean_HR_dif), method=lm, se=FALSE, colour = "gray40", alpha = .01,linetype="dashed", size = .2 )+
  geom_smooth( method=lm, se=FALSE, linetype="dashed",
             color="darkred", size = 2)+
  stat_summary(aes(label = ssid),geom = 'pointrange', pch = 1)+
  # stat_ellipse()+
  # ggpubr::stat_cor()+
  p$graphstyle+
  xlab("Alexithymia (Z)")+
  ylab("HR difference")+
p$graphstyle

```



```{r}

# Just ASC

lmer_hr_interoThesis$biohr_tas_arous_ASD <- lmer(Bio_Mean_HR_dif ~ TASc * arousal_c + 
                 (1|ssid) + 
                 (1| stim),
     REML = FALSE,
     data = db_full6new_hr_fix_stim_select2 %>%
       subset(Bio_Mean_HR_dif_outl == "not outlier")%>%
       subset(ssid!= 356)%>%
       subset(Group == "ASD"))

summary(lmer_hr_interoThesis$biohr_tas_arous_ASD)


# TAS and AQ

# just NT

lmer_hr_interoThesis$biohr_tas_aq_arous_NT <- lmer(Bio_Mean_HR_dif ~ TASc * AQc* arousal_c + 
                 (1|ssid) + 
                 (1| stim),
     REML = FALSE,
     data = db_full6new_hr_fix_stim_select2 %>%
       subset(Bio_Mean_HR_dif_outl == "not outlier")%>%
       subset(ssid!= 356)%>%
       subset(Group == "NT"))

summary(lmer_hr_interoThesis$biohr_tas_aq_arous_NT)

# just AQ
lmer_hr_interoThesis$biohr_aq_arous_NT <- lmer(Bio_Mean_HR_dif ~  AQc * arousal_c + 
                 (1|ssid) + 
                 (1| stim),
     REML = FALSE,
     data = db_full6new_hr_fix_stim_select2 %>%
       subset(Bio_Mean_HR_dif_outl == "not outlier")%>%
       subset(ssid!= 356)%>%
       subset(Group == "NT"))

summary(lmer_hr_interoThesis$biohr_aq_arous_NT)


```


Clustering responses and then compare them as a function of alexithymia
- try clustering
- barycentric discriminant analyses


```{r}
# subset NT only
db_full6new_hr_fix_stim_select2_NT<- subset(db_full6new_hr_fix_stim_select2,
                                            Group == "NT")

# flag the multiple outliers in pupil scr arousal and heart rate

db_full6new_hr_fix_stim_select2_NT$stimIAPS<- db_full6new_hr_fix_stim_select2_NT$stim

db_full6new_hr_fix_stim_select2_NT<- db_full6new_hr_fix_stim_select2_NT%>%
  group_by(stimIAPS) %>%
  mutate(arousal_outler = if_else(arousal > (median(arousal, na.rm = TRUE) + 
                                               (4*mad(arousal, na.rm = TRUE))), TRUE,
         if_else(arousal < (median(arousal, na.rm = TRUE) - 
                              (4*mad(arousal, na.rm = TRUE))), TRUE, FALSE)))%>%
   mutate(valence_outler = if_else(valence > (median(valence, na.rm = TRUE) + 
                                               (4*mad(valence, na.rm = TRUE))), TRUE,
         if_else(valence < (median(valence, na.rm = TRUE) - 
                              (4*mad(valence, na.rm = TRUE))), TRUE, FALSE)))%>%
  group_by(ssid)%>%
   mutate(pupil_outlier = if_else(pup_basCor > (median(pup_basCor, na.rm = TRUE) 
                                                + (3*mad(pup_basCor, na.rm = TRUE))), TRUE,
         if_else(pup_basCor < (median(pup_basCor, na.rm = TRUE) - 
                                 (3*mad(pup_basCor, na.rm = TRUE))), TRUE, FALSE)))%>%
    mutate(BIO_CDA.PhasicMax_z = scale(BIO_CDA.PhasicMax))%>%
  mutate(BIO_CDA.PhasicMax_z_outl = if_else(abs(BIO_CDA.PhasicMax_z)> 3, TRUE, FALSE))%>%
  ungroup()%>%
  mutate(arousal_c = scale(arousal, center = TRUE, scale = TRUE)[,1],
         valence_c = scale(valence, center = TRUE, scale = TRUE)[,1],
         # Mean_gray_z = scale(Mean)[,1],
         TASc = scale(TAS)[,1],
         AQc = scale(AQ)[,1],
         BPQc = scale(BPQ)[,1],
         WASIM_c =scale(WASIM)[,1],
         DASSTotalc = scale(DASSTotal)[,1])


# is there is at least one outlier in HR, SCR or pupil flag true
db_full6new_hr_fix_stim_select2_NT$pupil_outlier
db_full6new_hr_fix_stim_select2_NT$Bio_Mean_HR_dif_outl
db_full6new_hr_fix_stim_select2_NT$BIO_CDA.PhasicMax_z_outl

db_full6new_hr_fix_stim_select2_NT$Bio_Mean_HR_dif_outl2<- if_else(db_full6new_hr_fix_stim_select2_NT$Bio_Mean_HR_dif_outl == "outlier", TRUE, FALSE)


colnames(db_full6new_hr_fix_stim_select2_NT)


# apply(db_full6new_hr_fix_stim_select2_NT[,56,48,59], 3, function(r) any(r %in% c("TRUE")))


db_full6new_hr_fix_stim_select2_NT

unique(db_full6new_hr_fix_stim_select2_NT$ssid)

db_full6new_hr_fix_stim_select2_NT%>%
  group_by()

# try hierrquical clustering
write_csv(db_full6new_hr_fix_stim_select2_NT, "db_full6new_hr_fix_stim_select2_NT.csv")


db_full6new_hr_fix_stim_select2_NT

db_full6new_hr_fix_stim_select2_NT_no_outl<- subset(db_full6new_hr_fix_stim_select2_NT, db_full6new_hr_fix_stim_select2_NT$Bio_Mean_HR_dif_outl2 == FALSE)

colnames(db_full6new_hr_fix_stim_select2_NT_no_outl)
db_full6new_hr_fix_stim_select2_NT_select<- db_full6new_hr_fix_stim_select2_NT_no_outl[,c(1,53,12,15,16,17,18,
                                                                                  42,8,28, 56,58,59,31:34)]


# export to explore hierarquical clustering
# db_full6new_hr_fix_stim_select2_NT_select, but first z score

db_full6new_hr_fix_stim_select2_NT_select_scaled<- db_full6new_hr_fix_stim_select2_NT_select %>%
  group_by(ssid)%>%
  mutate(BIO_CDA.PhasicMax_z = scale(BIO_CDA.PhasicMax))%>%
  ungroup()%>%
  mutate(BIO_CDA.PhasicMax_z_z = scale(BIO_CDA.PhasicMax_z),
         Bio_Mean_HR_dif_z = scale(Bio_Mean_HR_dif),
         pup_basCor_z = scale(pup_basCor))
  
write_csv(db_full6new_hr_fix_stim_select2_NT_select_scaled, "db_full6new_hr_fix_stim_select2_NT_select_scaled.csv")

# jasp test

library(readr)
db_full6new_hr_fix_stim_select2_NT_select_scaled_Hierclustest <- read_csv("db_full6new_hr_fix_stim_select2_NT_select_scaled_Hierclustest.csv")
View(db_full6new_hr_fix_stim_select2_NT_select_scaled_Hierclustest)

db_full6new_hr_fix_stim_select2_NT_select_scaled_Hierclustest %>%
  subset(!is.na(hierarquicaltest))%>%
  subset(!is.na(TAS))%>%
  group_by(ssid, alexmedian,hierarquicaltest)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(as.factor(hierarquicaltest), pup_basCor))+
  geom_jitter(width = .1, alpha = .1) +
  stat_summary(geom = 'pointrange')+
  # geom_text(aes(label = ssid))+
  facet_grid(~alexmedian)


db_full6new_hr_fix_stim_select2_NT_select_scaled_Hierclustest %>%
  subset(!is.na(hierarquicaltest))%>%
  subset(!is.na(TAS))%>%
  group_by(ssid, alexmedian,hierarquicaltest)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(as.factor(hierarquicaltest), pup_basCor_z))+
  geom_jitter(width = .1, alpha = .1) +
  stat_summary(geom = 'pointrange')+
  # geom_text(aes(label = ssid))+
  facet_grid(~alexmedian)




db_full6new_hr_fix_stim_select2_NT_select_scaled_Hierclustest %>%
  subset(!is.na(hierarquicaltest))%>%
  subset(!is.na(TAS))%>%
  group_by(ssid, alexmedian,hierarquicaltest)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(as.factor(hierarquicaltest), Bio_Mean_HR_dif))+
  geom_jitter(width = .1, alpha = .1) +
  stat_summary(geom = 'pointrange')+
  # geom_text(aes(label = ssid))+
  facet_grid(~alexmedian)



db_full6new_hr_fix_stim_select2_NT_select_scaled_Hierclustest %>%
  subset(!is.na(hierarquicaltest))%>%
  subset(!is.na(TAS))%>%
  group_by(ssid, alexmedian,hierarquicaltest)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(as.factor(hierarquicaltest), BIO_CDA.PhasicMax_z))+
  geom_jitter(width = .1, alpha = .1) +
  stat_summary(geom = 'pointrange')+
  # geom_text(aes(label = ssid))+
  facet_grid(~alexmedian)

# find the clusters on the aggregated data

db_full6new_hr_fix_stim_select2_NT_no_outl<- subset(db_full6new_hr_fix_stim_select2_NT, db_full6new_hr_fix_stim_select2_NT$Bio_Mean_HR_dif_outl2 == FALSE)


db_full6new_hr_fix_stim_select2_NT_select_agg<- db_full6new_hr_fix_stim_select2_NT_no_outl %>%
  group_by(stimIAPS, stimDescription)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)

  mutate(BIO_CDA.PhasicMax_z = scale(BIO_CDA.PhasicMax))%>%
  ungroup()%>%
  mutate(BIO_CDA.PhasicMax_z_z = scale(BIO_CDA.PhasicMax_z),
         Bio_Mean_HR_dif_z = scale(Bio_Mean_HR_dif),
         pup_basCor_z = scale(pup_basCor))
  
write_csv(db_full6new_hr_fix_stim_select2_NT_select_agg, "db_full6new_hr_fix_stim_select2_NT_select_agg.csv")

```



Jasp clusters are super weird so do the clustering here


```{r}
db_full6new_hr_fix_stim_select2_NT_select_agg

# K-Means Clustering

# Importing the dataset



colnames(db_full6new_hr_fix_stim_select2_NT_select_agg)

db_full6new_hr_fix_stim_select2_NT_select_agg_no_na<- subset(db_full6new_hr_fix_stim_select2_NT_select_agg,
                                                             !is.na(pup_basCor))

db_full6new_hr_fix_stim_select2_NT_select_agg_no_na<- subset(db_full6new_hr_fix_stim_select2_NT_select_agg_no_na, !is.na(db_full6new_hr_fix_stim_select2_NT_select_agg_no_na$stimDescription))

colnames(db_full6new_hr_fix_stim_select2_NT_select_agg_no_na)
clust_dataset = db_full6new_hr_fix_stim_select2_NT_select_agg_no_na[c(4,36,44)]

clust_dataset_scaled<- scale(clust_dataset)

clust_dataset_scaled
# Feature Scaling
# training_set = scale(training_set)
# test_set = scale(test_set)

# Using the elbow method to find the optimal number of clusters
set.seed(1)
wcss = vector()
for (i in 1:10) wcss[i] = sum(kmeans(clust_dataset_scaled, i)$withinss)
plot(1:10,
     wcss,
     type = 'b',
     main = paste('The Elbow Method'),
     xlab = 'Number of clusters',
     ylab = 'WCSS')

# 3

# Fitting K-Means to the dataset
set.seed(25)

kmeans = kmeans(x = clust_dataset_scaled, centers = 3)
y_kmeans = kmeans$cluster

# Visualising the clusters
# install.packages("cluster")
library(cluster)

# ?clusplot

clust_dataset_scaled
y_kmeans

clusplot(clust_dataset_scaled,
         y_kmeans,
         lines = 2,
         shade = TRUE,
         color = TRUE,
         labels = 1,
         plotchar = FALSE,
         span = TRUE
         # label = 
         # main = paste('Clusters of customers'),
         # xlab = 'Annual Income',
         # ylab = 'Spending Score'
         )


db_full6new_hr_fix_stim_select2_NT_select_agg_no_na$y_kmeans <- y_kmeans

db_full6new_hr_fix_stim_select2_NT_select_agg_no_na %>%
  ggplot(aes(factor(y_kmeans), arousal))+
  geom_point()+
  geom_text(aes(label = stimDescription))

kmean_select<- select(db_full6new_hr_fix_stim_select2_NT_select_agg_no_na,
                      c(stimIAPS,y_kmeans))





```

a few visualisations
```{r}

median(db_full6new_hr_fix_stim_select2_NT_no_outl$TAS, na.rm = TRUE)

summary(db_full6new_hr_fix_stim_select2_NT_no_outl$TAS)

db_full6new_hr_fix_stim_select2_NT_no_outl$alex_1st_vs_3rd_qrt<- if_else(db_full6new_hr_fix_stim_select2_NT_no_outl$TAS> 52, "3 qrt",
                                                                         if_else(db_full6new_hr_fix_stim_select2_NT_no_outl$TAS< 33, "1st qrt", NULL))

table(db_full6new_hr_fix_stim_select2_NT_no_outl$alex_1st_vs_3rd_qrt)

clustering_agg_noflood$y_kmeans<- y_kmeans

left_join(db_full6new_hr_fix_stim_select2_NT_no_outl, kmean_select)%>%
  subset(!is.na(TAS))%>%
  subset(!is.na(stimDescription))%>%
  group_by(ssid, alex_1st_vs_3rd_qrt, y_kmeans)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(alex_1st_vs_3rd_qrt, pup_basCor))+
  geom_jitter(width = .1, alpha = .1)+
  stat_summary(geom = 'pointrange')+
  facet_grid(~y_kmeans)+
    ggpubr::stat_compare_means()


left_join(db_full6new_hr_fix_stim_select2_NT_no_outl, kmean_select)%>%
  subset(!is.na(TAS))%>%
  subset(!is.na(stimDescription))%>%
  subset(!is.na(alex_1st_vs_3rd_qrt))%>%
  group_by(ssid, alex_1st_vs_3rd_qrt, y_kmeans)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(alex_1st_vs_3rd_qrt, Bio_Mean_HR_dif))+
  geom_jitter(width = .1, alpha = .1)+
  stat_summary(geom = 'pointrange')+
  facet_grid(~y_kmeans)+
    ggpubr::stat_compare_means()


left_join(db_full6new_hr_fix_stim_select2_NT_no_outl, kmean_select)%>%
  subset(!is.na(TAS))%>%
  subset(!is.na(stimDescription))%>%
   subset(!is.na(alex_1st_vs_3rd_qrt))%>%
  group_by(ssid, alex_1st_vs_3rd_qrt, y_kmeans)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(alex_1st_vs_3rd_qrt, BIO_CDA.PhasicMax_z))+
  geom_jitter(width = .1, alpha = .1)+
  stat_summary(geom = 'pointrange')+
  facet_grid(~y_kmeans)+
    ggpubr::stat_compare_means()


left_join(db_full6new_hr_fix_stim_select2_NT_no_outl, kmean_select)%>%
  subset(!is.na(TAS))%>%
  subset(!is.na(stimDescription))%>%
  subset(!is.na(alex_1st_vs_3rd_qrt))%>%
  group_by(ssid, alex_1st_vs_3rd_qrt, y_kmeans)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(alex_1st_vs_3rd_qrt, arousal))+
  geom_jitter(width = .1, alpha = .1)+
  stat_summary(geom = 'pointrange')+
  facet_grid(~y_kmeans)+
    ggpubr::stat_compare_means()


left_join(db_full6new_hr_fix_stim_select2_NT_no_outl, kmean_select)%>%
  subset(!is.na(TAS))%>%
  subset(!is.na(stimDescription))%>%
  subset(!is.na(alex_1st_vs_3rd_qrt))%>%
  group_by(ssid, alex_1st_vs_3rd_qrt, y_kmeans)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(alex_1st_vs_3rd_qrt, valence))+
  geom_jitter(width = .1, alpha = .1)+
  stat_summary(geom = 'pointrange')+
  facet_grid(~y_kmeans)+
    ggpubr::stat_compare_means()

```


BADIA

```{r}

db_full6new_hr_fix_stim_select2_NT_no_outl

summary(db_full6new_hr_fix_stim_select2_NT_select_agg_no_na$TAS)

db_full6new_hr_fix_stim_select2_NT_no_outl_agg_bysubj<- db_full6new_hr_fix_stim_select2_NT_no_outl%>%
  subset(!is.na(TAS))%>%
  group_by(ssid)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)

summary(db_full6new_hr_fix_stim_select2_NT_no_outl_agg_bysubj$TAS)

db_full6new_hr_fix_stim_select2_NT_no_outl_agg_bysubj$alex_quartil <- if_else(db_full6new_hr_fix_stim_select2_NT_no_outl_agg_bysubj$TAS< 33, "1st", 
if_else(db_full6new_hr_fix_stim_select2_NT_no_outl_agg_bysubj$TAS> 52, "3rd",                                                                              "Mean"))

table(db_full6new_hr_fix_stim_select2_NT_no_outl_agg_bysubj$alex_quartil)

# reformat
colnames(db_full6new_hr_fix_stim_select2_NT_no_outl)

db_full6new_hr_fix_stim_select2_NT_no_outl$log1p_BIO_CDA.PhasicMax<- log1p(db_full6new_hr_fix_stim_select2_NT_no_outl$BIO_CDA.PhasicMax+.1)

# select only necesssary columns
db_full6new_hr_fix_stim_select2_NT_no_outl

db_full6new_hr_fix_stim_select2_NT_no_outl$stimIAPS2<- substr(db_full6new_hr_fix_stim_select2_NT_no_outl$stimIAPS, 1,4)

db_full6new_hr_fix_stim_select2_NT_no_outl_3<- select(db_full6new_hr_fix_stim_select2_NT_no_outl,
                                                      c(ssid, stimIAPS, stimIAPS2, stimDescription, TAS, AQ, Group, pup_basCor, Bio_Mean_HR_dif, log1p_BIO_CDA.PhasicMax, arousal, valence))

# stoee residual
db_full6new_hr_fix_stim_select2_NT_no_outl_3.1<- select(db_full6new_hr_fix_stim_select2_NT_no_outl,
                                                      c(ssid, stimIAPS, stimIAPS2, stimDescription, TAS, AQ, Group, pup_basCor, Bio_Mean_HR_dif, log1p_BIO_CDA.PhasicMax, arousal, valence))

# eliminate NAs in stimuli
db_full6new_hr_fix_stim_select2_NT_no_outl_3<- subset(db_full6new_hr_fix_stim_select2_NT_no_outl_3,!is.na(stimDescription))


unique(db_full6new_hr_fix_stim_select2_NT_no_outl_3$stimIAPS)

db_full6new_hr_fix_stim_select2_NT_no_outl_3$stimIAPS2<- substr(db_full6new_hr_fix_stim_select2_NT_no_outl_3$stimIAPS, 1,4)

# factor(db_full6new_hr_fix_stim_select2_NT_no_outl_3$stimIAPS2)

# reshape
colnames(db_full6new_hr_fix_stim_select2_NT_no_outl_3)

table(is.na(db_full6new_hr_fix_stim_select2_NT_no_outl_3))

# eliminante no scores in TAS
db_full6new_hr_fix_stim_select2_NT_no_outl_4<- subset(db_full6new_hr_fix_stim_select2_NT_no_outl_3, !is.na(TAS))

table(is.na(db_full6new_hr_fix_stim_select2_NT_no_outl_4$TAS))
# dcast()

colnames(db_full6new_hr_fix_stim_select2_NT_no_outl_4)

# fill in NA with average per individual
# - not working
# are things being recognised as something otehr than NA, eg NaN
# table(is.nan(db_full6new_hr_fix_stim_select2_NT_no_outl_4))

db_full6new_hr_fix_stim_select2_NT_no_outl_4[db_full6new_hr_fix_stim_select2_NT_no_outl_4 == "NaN"] <- NA

# seems like it

db_full6new_hr_fix_stim_select2_NT_no_outl_5 <- db_full6new_hr_fix_stim_select2_NT_no_outl_4%>%
  group_by(ssid)%>%
  mutate(ssid_pup_basCor_mean = mean(pup_basCor, na.rm = TRUE), 
         ssid_Bio_Mean_HR_dif_mean = mean(Bio_Mean_HR_dif, na.rm = TRUE),
         ssid_log1p_BIO_CDA.PhasicMax_mean = mean(log1p_BIO_CDA.PhasicMax, na.rm = TRUE))%>%
  mutate(pup_basCor = if_else(is.na(pup_basCor) == TRUE, ssid_pup_basCor_mean, pup_basCor))%>%
  mutate(Bio_Mean_HR_dif = if_else(is.na(Bio_Mean_HR_dif) == TRUE, ssid_Bio_Mean_HR_dif_mean, Bio_Mean_HR_dif))%>%
  mutate(log1p_BIO_CDA.PhasicMax = if_else(is.na(log1p_BIO_CDA.PhasicMax) == TRUE, ssid_log1p_BIO_CDA.PhasicMax_mean, log1p_BIO_CDA.PhasicMax)) 

library(data.table)

db_forBADA1<- data.table::dcast(setDT(db_full6new_hr_fix_stim_select2_NT_no_outl_5), 
                    ssid + TAS+AQ+Group ~ stimIAPS2, value.var = c('pup_basCor',
                'Bio_Mean_HR_dif', 'log1p_BIO_CDA.PhasicMax', 'arousal', 'valence'))



table(is.na(db_forBADA1))
View(db_forBADA1)
na.omit(db_forBADA1)

# try to fill means rowwise
colnames(db_forBADA1)

db_forBADA1_pupil_1_4<- db_forBADA1_pupil[,1:4]

db_forBADA1_pupil<- db_forBADA1[,5:60]
table(is.na(db_forBADA1_pupil$TAS))

k <- which(is.na(db_forBADA1_pupil), arr.ind=TRUE)
k

db_forBADA1_pupil$ssid<- as.numeric(as.character(db_forBADA1_pupil$ssid))
db_forBADA1_pupil[k] <- rowMeans(db_forBADA1_pupil, na.rm=TRUE)[k[,1]]

# hr
colnames(db_forBADA1)
db_forBADA1_hr<- db_forBADA1[,c(61:(61+55))]
# table(is.na(db_forBADA1_pupil$TAS))
colnames(db_forBADA1_hr)

k <- which(is.na(db_forBADA1_hr), arr.ind=TRUE)
k

db_forBADA1_hr$ssid<- as.numeric(as.character(db_forBADA1_hr$ssid))
db_forBADA1_hr[k] <- rowMeans(db_forBADA1_hr, na.rm=TRUE)[k[,1]]

db_forBADA1_hr

# scr
colnames(db_forBADA1)
db_forBADA1_scr<- db_forBADA1[,c(117:172)]
# table(is.na(db_forBADA1_pupil$TAS))

k <- which(is.na(db_forBADA1_scr), arr.ind=TRUE)
k

db_forBADA1_scr$ssid<- as.numeric(as.character(db_forBADA1_scr$ssid))
db_forBADA1_scr[k] <- rowMeans(db_forBADA1_scr, na.rm=TRUE)[k[,1]]

db_forBADA1_scr

# table(is.na(bind_cols(db_forBADA1_pupil, db_forBADA1_hr[,3:58], db_forBADA1_scr[,3:58])))

# arousal and valence
# scr
colnames(db_forBADA1)
db_forBADA1_ar_vl<- db_forBADA1[,c(173:284)]
# table(is.na(db_forBADA1_pupil$TAS))

k <- which(is.na(db_forBADA1_ar_vl), arr.ind=TRUE)
k

db_forBADA1_ar_vl$ssid<- as.numeric(as.character(db_forBADA1_ar_vl$ssid))
db_forBADA1_ar_vl[k] <- rowMeans(db_forBADA1_ar_vl, na.rm=TRUE)[k[,1]]

db_forBADA1_ar_vl



# create quartiles for alexithymia
summary(db_forBADA1_pupil$TAS)
# Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#   22.00   33.00   42.00   42.82   52.00   71.00 

# db_forBADA1_pupil$alex_quartil<- if_else(db_forBADA1_pupil$TAS<33, "1st",
#                                          if_else(db_forBADA1_pupil$TAS>52, "2nd", "Mean"))

colnames(db_forBADA1_ar_vl)
db_forBADA1_pupil$ssid<- NULL
db_forBADA1_hr$ssid<- NULL
db_forBADA1_scr$ssid<- NULL
db_forBADA1_ar_vl$ssid<- NULL
db_forBADA1_ar_vl$ssid<- NULL

db_badia_nona <- bind_cols(db_forBADA1_pupil_1_4, 
                           db_forBADA1_pupil, 
                           db_forBADA1_hr, 
                           db_forBADA1_scr, 
                           db_forBADA1_ar_vl)

colnames(db_badia_nona)

colnames(db_badia_nona)
db_badia_nona1<- db_badia_nona[,c(1:2,59,3:58,60:284)]

nrow(db_badia_nona1)
table(is.na(db_badia_nona1))
```
PCA and BADA just NT

```{r}
install.packages("TInPosition")
install.packages("ade4")
install.packages("TExPosition")
install.packages("MExPosition")
install.packages("ExPosition")
install.packages("prettyGraphs")

library(TInPosition)

library(MExPosition)

ExPosition::epPCA()

##PCA with Inference
# all.data <- read.csv("PCA_Dataset_2.csv",header=TRUE)
db_badia_nona1
all.data<- db_badia_nona1

all.data$TAS_mediansplit<- if_else(all.data$TAS> median(all.data$TAS), "High", "Low")
all.data$AQ_mediansplit<- if_else(all.data$AQ> median(all.data$AQ), "High", "Low")
 # design
var.design_asd <- as.factor(all.data$Group)
var.design_aq <- as.factor(all.data$AQ_mediansplit)
var.design_tas <- as.factor(all.data$TAS_mediansplit)
colnames(all.data)

var.data <- all.data[,c(6:172)]

# Mexposition package missing

# oiginal
?epPCA.inference.battery
# InPosition::
all.data$ssid

?InPosition::epPCA.inference.battery

# PCA ASD
var.PCA.inf_asd <-InPosition::epPCA.inference.battery(var.data, 
                                       scale = FALSE, 
                                       center = FALSE, 
                                       DESIGN = var.design_asd, 
                                       make_design_nominal = TRUE, 
                                       graphs = TRUE, k = 0, 
                                       test.iters = 1000, 
                                       constrained = FALSE, 
                                       critical.value = 2)

# PCA AQ NT

var.PCA.inf_AQ <-InPosition::epPCA.inference.battery(var.data, 
                                       scale = FALSE, 
                                       center = FALSE, 
                                       DESIGN = var.design_aq, 
                                       make_design_nominal = TRUE, 
                                       graphs = TRUE, k = 0, 
                                       test.iters = 1000, 
                                       constrained = FALSE, 
                                       critical.value = 2)

# tas

var.PCA.inf_tas <-InPosition::epPCA.inference.battery(var.data, 
                                       scale = FALSE, 
                                       center = FALSE, 
                                       DESIGN = var.design_tas, 
                                       make_design_nominal = TRUE, 
                                       graphs = TRUE, k = 0, 
                                       test.iters = 1000, 
                                       constrained = FALSE, 
                                       critical.value = 2)




```
graphic stuff to explore later
?ExPosition::epPCA
?correlationPlotter
library(prettyGraphs)

var.PCA.inf <- ExPosition::epPCA(var.data1, scale = TRUE, center = TRUE, DESIGN = var.design, make_design_nominal = TRUE, graphs = TRUE, k = 0)


# let's try tinpositioinsta

install.packages('InPosition')

?epPCA.inference.battery

# var.PCA.inf <- InPosition::epPCA.inference.battery(var.data1, scale = TRUE, center = TRUE, DESIGN = var.design, make_design_nominal = TRUE, graphs = TRUE, k = 0, test.iters = 100, constrained = FALSE, critical.value = 2)


row.cols<- var.PCA.inf$Fixed.Data$Plotting.Data$fi.col
## Look at other dimensions
row.cols <- read.csv("row_cols.csv",header=TRUE)

# row.cols <- var.data[,2]

# row.cols<- all.data_highlow[,3]

x_axis <- 1
y_axis <- 2
var.PCA.inf$ExPosition.Data

tau <- var.PCA.inf$Fixed.Data$ExPosition.Data$t
p.val <- var.PCA.inf$Inference.Data$components$p.vals
xlab = paste("Component", x_axis, "Variance:",round(tau[x_axis],digits = 2),"%, ","p =",p.val[x_axis])
ylab = paste("Component", y_axis, "Variance:",round(tau[y_axis],digits = 2),"%, ","p =",p.val[y_axis])
main = "PCA with Inference"

pca.plot <- prettyPlot(var.PCA.inf$Fixed.Data$ExPosition.Data$fi,
x_axis=x_axis,
y_axis=y_axis,
col=row.cols,
pch=22,
cex=NULL,
text.cex=NULL,
pos=3,
xlab=xlab,ylab=ylab,main=main,display_names=FALSE,display_points=TRUE,
constraints=NULL,contributionCircles=TRUE,contributions=var.PCA.inf$Fixed.Data$ExPosition.Data$ci, axes=TRUE, fg.line.width=3,fg.type="l", fg.col="black",
bg.line.width=1.5, bg.lty=3, bg.col="black",flip=FALSE,asp=1, findBounds=TRUE,dev.new=TRUE,new.plot=TRUE)

## Barycentric Discriminant Analysis (BaDa)
# var.data <- all.data_highlow[,c(4:171)]

TInPosition::tepBADA.inference.battery()
# 
# table(is.na(var.data))
# na.omit(var.data)
# 
#  var.data$log1p_BIO_CDA.PhasicMax_9926
# 
#  
#  var.data %>%
#     select_if(~ any(is.infinite(.)))
#  
#  var.data1<- na.omit(var.data)
 
 
var.design<- as.factor(all.data_highlow$alex_quartil)


resBADA <- TExPosition::tepBADA(var.data, DESIGN = var.design, scale = TRUE,
                   graphs = FALSE)

colnames(var.data)
nrow(var.data)

?TInPosition::tepBADA.inference.battery

nrow(var.data_asd)
var.design



BADA part
```{r}

var.PCA.inf_tas <-InPosition::epPCA.inference.battery(var.data, 
                                       scale = FALSE, 
                                       center = FALSE, 
                                       DESIGN = var.design_tas, 
                                       make_design_nominal = TRUE, 
                                       graphs = TRUE, k = 0, 
                                       test.iters = 1000, 
                                       constrained = FALSE, 
                                       critical.value = 2)

# aq

var.BADA.inf_aq <- TInPosition::tepBADA.inference.battery(var.data, 
                                                       scale = FALSE, 
                                                       center = FALSE, 
                                                       DESIGN = var.design_aq, 
                                                       make_design_nominal = TRUE,
                                                       group.masses = NULL, 
                                                       weights = NULL, 
                                                       graphs = TRUE, 
                                                       k = 0, 
                                                       test.iters = 1000, 
                                                       critical.value = 2)

# TAS

var.BADA.inf_tas <- TInPosition::tepBADA.inference.battery(var.data, 
                                                       scale = FALSE, 
                                                       center = FALSE, 
                                                       DESIGN = var.design_tas, 
                                                       make_design_nominal = TRUE,
                                                       group.masses = NULL, 
                                                       weights = NULL, 
                                                       graphs = TRUE, 
                                                       k = 0, 
                                                       test.iters = 1000, 
                                                       critical.value = 2)

# if I scale i have a singular
# resBADA$Plotting.Data
# 
# row.names(resBADA.inf$Inference.Data$loo.data$fixed.confuse) <- c("Low", "High")
# colnames(resBADA.inf$Inference.Data$loo.data$fixed.confuse) <- c("Low", "High")
# resBADA.inf$Inference.Data$loo.data$fixed.confuse

plot(resBADA.inf)


TInPosition::tinGraphs(resBADA.inf)
```


lets try including asd



```{r}
nrow(db_full6new_hr_fix_stim_select2)
db_full6new_hr_fix_stim_select3<- db_full6new_hr_fix_stim_select2
colnames(db_full6new_hr_fix_stim_select3)

# flag the multiple outliers in pupil scr arousal and heart rate

db_full6new_hr_fix_stim_select3$stimIAPS<- db_full6new_hr_fix_stim_select3$stim

db_full6new_hr_fix_stim_select3<- db_full6new_hr_fix_stim_select3%>%
  group_by(stimIAPS) %>%
  mutate(arousal_outler = if_else(arousal > (median(arousal, na.rm = TRUE) + 
                                               (4*mad(arousal, na.rm = TRUE))), TRUE,
         if_else(arousal < (median(arousal, na.rm = TRUE) - 
                              (4*mad(arousal, na.rm = TRUE))), TRUE, FALSE)))%>%
   mutate(valence_outler = if_else(valence > (median(valence, na.rm = TRUE) + 
                                               (4*mad(valence, na.rm = TRUE))), TRUE,
         if_else(valence < (median(valence, na.rm = TRUE) - 
                              (4*mad(valence, na.rm = TRUE))), TRUE, FALSE)))%>%
  group_by(ssid)%>%
   mutate(pupil_outlier = if_else(pup_basCor > (median(pup_basCor, na.rm = TRUE) 
                                                + (3*mad(pup_basCor, na.rm = TRUE))), TRUE,
         if_else(pup_basCor < (median(pup_basCor, na.rm = TRUE) - 
                                 (3*mad(pup_basCor, na.rm = TRUE))), TRUE, FALSE)))%>%
    mutate(BIO_CDA.PhasicMax_z = scale(BIO_CDA.PhasicMax))%>%
  mutate(BIO_CDA.PhasicMax_z_outl = if_else(abs(BIO_CDA.PhasicMax_z)> 3, TRUE, FALSE))%>%
  ungroup()%>%
  mutate(arousal_c = scale(arousal, center = TRUE, scale = TRUE)[,1],
         valence_c = scale(valence, center = TRUE, scale = TRUE)[,1],
         # Mean_gray_z = scale(Mean)[,1],
         TASc = scale(TAS)[,1],
         AQc = scale(AQ)[,1],
         BPQc = scale(BPQ)[,1],
         WASIM_c =scale(WASIM)[,1],
         DASSTotalc = scale(DASSTotal)[,1])


# is there is at least one outlier in HR, SCR or pupil flag true

db_full6new_hr_fix_stim_select3$Bio_Mean_HR_dif_outl2<- if_else(db_full6new_hr_fix_stim_select3$Bio_Mean_HR_dif_outl == "outlier", TRUE, FALSE)


colnames(db_full6new_hr_fix_stim_select3)

table(db_full6new_hr_fix_stim_select3$Bio_Mean_HR_dif_outl2)
table(db_full6new_hr_fix_stim_select3$pupil_outlier)
table(db_full6new_hr_fix_stim_select3$BIO_CDA.PhasicMax_z_outl)

db_full6new_hr_fix_stim_select3_no_outl<-
subset(db_full6new_hr_fix_stim_select3, db_full6new_hr_fix_stim_select3$Bio_Mean_HR_dif_outl2 == FALSE)

db_full6new_hr_fix_stim_select3
# db_full6new_hr_fix_stim_select3_no

db_full6new_hr_fix_stim_select3_no_outl
```
db_full6new_hr_fix_stim_select3

BADIA

```{r}
# db_full6new_hr_fix_stim_select3_no_outl

# reformat
colnames(db_full6new_hr_fix_stim_select3_no_outl)

db_full6new_hr_fix_stim_select3_no_outl$log1p_BIO_CDA.PhasicMax<- log1p(db_full6new_hr_fix_stim_select3_no_outl$BIO_CDA.PhasicMax+.1)

# select only necessary columns
db_full6new_hr_fix_stim_select3_backup<- db_full6new_hr_fix_stim_select3
db_full6new_hr_fix_stim_select3<- db_full6new_hr_fix_stim_select3_no_outl
# db_full6new_hr_fix_stim_select3_no_outl

db_full6new_hr_fix_stim_select3$stimIAPS2<- substr(db_full6new_hr_fix_stim_select3$stimIAPS, 1,4)

# include image statistics
colnames(imageJ_IAPS)
db_full6new_hr_fix_stim_select3_withgray<- left_join(db_full6new_hr_fix_stim_select3, imageJ_IAPS[,c(4,15)])
nrow(db_full6new_hr_fix_stim_select3_withgray)
nrow(db_full6new_hr_fix_stim_select3)


pupil_arousal_findings$pupil_from_brightness_lm_2 <- lm(pup_basCor ~ 
                                                    Mean,
                                                    
                      data = db_full6new_hr_fix_stim_select3_withgray, na.action=na.exclude) 


summary(pupil_arousal_findings$pupil_from_brightness_lm_2)

plot(pupil_arousal_findings$pupil_from_brightness)

# store residuals

db_full6new_hr_fix_stim_select3_withgray$pup_resid_lm <- resid(pupil_arousal_findings$pupil_from_brightness_lm_2,
                                                            na.action=na.exclude)


# 
db_full6new_hr_fix_stim_select4_backup<- db_full6new_hr_fix_stim_select4

# select columns with residuals or pupil
db_full6new_hr_fix_stim_select4 <- select(db_full6new_hr_fix_stim_select3_withgray,
                                                      c(ssid, Group,TAS, AQ, stimIAPS, stimIAPS2, stimDescription, pup_resid_lm, Bio_Mean_HR_dif, log1p_BIO_CDA.PhasicMax, arousal, valence))


db_full6new_hr_fix_stim_select4<- subset(db_full6new_hr_fix_stim_select4,!is.na(stimDescription))
db_full6new_hr_fix_stim_select4<- subset(db_full6new_hr_fix_stim_select4,!is.na(TAS))


unique(db_full6new_hr_fix_stim_select4$stimIAPS)

db_full6new_hr_fix_stim_select4$stimIAPS2<- substr(db_full6new_hr_fix_stim_select4$stimIAPS, 1,4)

factor(db_full6new_hr_fix_stim_select4$stimIAPS2)

# reshape
colnames(db_full6new_hr_fix_stim_select4)


db_full6new_hr_fix_stim_select4<- subset(db_full6new_hr_fix_stim_select4, !is.na(Group))

colnames(db_full6new_hr_fix_stim_select4)

# fill in NA with average per individual
# - not working
# are things being recognised as something otehr than NA, eg NaN
# table(is.nan(db_full6new_hr_fix_stim_select4))

db_full6new_hr_fix_stim_select4[db_full6new_hr_fix_stim_select4 == "NaN"] <- NA

# seems like it

db_full6new_hr_fix_stim_select4$pup_basCor<- db_full6new_hr_fix_stim_select4$pup_resid_lm
db_full6new_hr_fix_stim_select4$pup_resid_lm<- NULL

db_full6new_hr_fix_stim_select5 <- db_full6new_hr_fix_stim_select4 %>%
  group_by(ssid)%>%
  mutate(ssid_pup_basCor_mean = mean(pup_basCor, na.rm = TRUE), 
         ssid_Bio_Mean_HR_dif_mean = mean(Bio_Mean_HR_dif, na.rm = TRUE),
         ssid_log1p_BIO_CDA.PhasicMax_mean = mean(log1p_BIO_CDA.PhasicMax, na.rm = TRUE))%>%
  mutate(pup_basCor = if_else(is.na(pup_basCor) == TRUE, ssid_pup_basCor_mean, pup_basCor))%>%
  mutate(Bio_Mean_HR_dif = if_else(is.na(Bio_Mean_HR_dif) == TRUE, ssid_Bio_Mean_HR_dif_mean, Bio_Mean_HR_dif))%>%
  mutate(log1p_BIO_CDA.PhasicMax = if_else(is.na(log1p_BIO_CDA.PhasicMax) == TRUE, ssid_log1p_BIO_CDA.PhasicMax_mean, log1p_BIO_CDA.PhasicMax)) 


nrow(db_full6new_hr_fix_stim_select5)

library(data.table)
# ?dcast
db_forBADA2_backup_properpupil<- db_forBADA2

db_forBADA2 <- data.table::dcast(setDT(db_full6new_hr_fix_stim_select5), 
                    ssid +TAS+AQ+ Group ~ stimIAPS2, value.var = c('pup_basCor',
                'Bio_Mean_HR_dif', 'log1p_BIO_CDA.PhasicMax', 'arousal', 'valence'),fun.aggregate = mean)



table(is.na(db_forBADA2))
View(db_forBADA2)
na.omit(db_forBADA2)

table(is.na(db_forBADA2$log1p_BIO_CDA.PhasicMax_9472))

# try to fill means rowwise
colnames(db_forBADA2)

db_forBADA2_pupil_ssid<- db_forBADA2[,1:4]

# 
db_forBADA2_pupil<- db_forBADA2[,5:60]
# table(is.na(db_forBADA1_pupil$TAS))

k <- which(is.na(db_forBADA2_pupil), arr.ind=TRUE)
k

# db_forBADA1_pupil$ssid<- as.numeric(as.character(db_forBADA1_pupil$ssid))
db_forBADA2_pupil[k] <- rowMeans(db_forBADA2_pupil, na.rm=TRUE)[k[,1]]

# hr
colnames(db_forBADA2)
db_forBADA2_hr<- db_forBADA2[,c(61:116)]
# table(is.na(db_forBADA1_pupil$TAS))

k <- which(is.na(db_forBADA2_hr), arr.ind=TRUE)
k

db_forBADA2_hr[k] <- rowMeans(db_forBADA2_hr, na.rm=TRUE)[k[,1]]

db_forBADA2_hr

# scr
colnames(db_forBADA2)
db_forBADA2_scr<- db_forBADA2[,117:172]
# table(is.na(db_forBADA1_pupil$TAS))

k <- which(is.na(db_forBADA2_scr), arr.ind=TRUE)
k

db_forBADA2_scr[k] <- rowMeans(db_forBADA2_scr, na.rm=TRUE)[k[,1]]

db_forBADA2_scr

# ar val
colnames(db_forBADA2)
db_forBADA2_ar_vl<- db_forBADA2[,173:284]
# table(is.na(db_forBADA1_pupil$TAS))

k <- which(is.na(db_forBADA2_ar_vl), arr.ind=TRUE)
k

db_forBADA2_ar_vl[k] <- rowMeans(db_forBADA2_ar_vl, na.rm=TRUE)[k[,1]]



# bind badia with asd
db_badia2_nona_backup_properPupil<-db_badia2_nona

db_badia2_nona <- bind_cols(db_forBADA2[,1:4], db_forBADA2_pupil, db_forBADA2_hr, db_forBADA2_scr,db_forBADA2_ar_vl)

db_badia2_nona$pup_basCor_1019
db_badia2_nona_backup_properPupil$pup_basCor_1019
```

now fit the same with the asd group

```{r}

install.packages("TInPosition")
install.packages("ade4")
install.packages("TExPosition")
install.packages("MExPosition")
install.packages("ExPosition")
install.packages("prettyGraphs")

library(TInPosition)
library(MExPosition)

colnames(db_badia2_nona)

var.data_asd_backup_properpupil<- var.data_asd
var.data_asd<- db_badia2_nona[,5:172]

db_badia2_nona$tas_mediansplit<- if_else(db_badia2_nona$TAS> median(db_badia2_nona$TAS, na.rm = TRUE), "High", "Low")
db_badia2_nona$aq_mediansplit<- if_else(db_badia2_nona$AQ> median(db_badia2_nona$AQ, na.rm = TRUE), "High", "Low")

var.design_asd_group<- as.factor(db_badia2_nona$Group)
var.design_asd_tas<- as.factor(db_badia2_nona$tas_mediansplit)
var.design_asd_aq<- as.factor(db_badia2_nona$aq_mediansplit)


colnames(var.data_asd)
# PCA asd
db_badia2_nona$ssid
library(prettyGraphs)


newnames_var

var.data_asd2<- var.data_asd
names(var.data_asd2)<- newnames_var

colnames(var.data_asd2)

bootratio_df2$MeasureStim<- paste0(bootratio_df2$measure1, paste0(".",bootratio_df2$stimDescription))
unique(bootratio_df2$MeasureStim)

?prettyGraphs::prettyBars
prettyGraphs::prettyBars(bootratio_df2$V1,
                         axis = 2)

measurenames<- bootratio_df2$measure1
variablethemes<- bootratio_df2$stimDescription
newnames_var<- bootratio_df2$MeasureStim
  
colnames(var.data_asd2)<- measurenames
library(prettyGraphs)
var.data_asd4<- var.data_asd
colnames(var.data_asd4)<- newnames_var

colnames(var.data_asd2)

var.data_asd3<- var.data_asd2
colnames(var.data_asd3)<- variablethemes

colnames(var.data_asd4)
library(prettyGraphs)

var.data_asd$pup_basCor_1019
var.data_asd_backup_properpupil$pup_basCor_1019
var.PCA.inf_asd_group <-InPosition::epPCA.inference.battery(var.data_asd, 
                                       scale = TRUE, 
                                       center = TRUE, 
                                       DESIGN = var.design_asd_group,
                                       make_design_nominal = TRUE, 
                                       graphs = TRUE, k = 0, 
                                       test.iters = 1000, 
                                       constrained = FALSE, critical.value = 2)
?InPosition::inGraphs
InPosition::inGraphs(var.PCA.inf_asd_group, y_axis = 2,
                     biplots = TRUE)

prettyGraphs::correlationPlotter(var.data_asd4,
  
  factor_scores= var.PCA.inf_asd_group$Fixed.Data$ExPosition.Data$fi)

prettyGraphs::

colnames(var.data_asd3)
var.PCA.inf_asd_group_stimdescr <-InPosition::epPCA.inference.battery(var.data_asd3, 
                                       scale = TRUE, 
                                       center = TRUE, 
                                       DESIGN = var.design_asd_group,
                                       make_design_nominal = TRUE, 
                                       graphs = TRUE, k = 0, 
                                       test.iters = 1000, 
                                       constrained = FALSE, critical.value = 2)

?InPosition::inGraphs
InPosition::inGraphs(var.PCA.inf_asd_group, y_axis = 2)
InPosition::inGraphs(var.PCA.inf_asd_group_stimdescr, y_axis = 2)

gpca.iris.res <- epPCA.inference.battery(var.data_asd2,
                                          DESIGN=var.design_asd_group,
                                          make_design_nominal=FALSE)
	inGraphs(gpca.iris.res,y_axis=3)


	
	InPosition::inGraphs(var.PCA.inf_asd_group, y_axis = 2)

# store boostrap rations
bootratio<- var.PCA.inf_asd_group[["Inference.Data"]][["fj.boots"]][["tests"]][["boot.ratios"]]

as.data.frame(bootratio)[,1:3]
bootratio_df<- as.data.frame(bootratio)[,1:3]
bootratio_df$variable<- row.names(bootratio_df)
bootratio_df$stimIAPS2<- unique(str_sub(bootratio_df$variable,-4))

install.packages("ggwordcloud")
# librar


bootratio_df$measure<- substr(bootratio_df$variable, 1,6)


unique(bootratio_df$measure)
bootratio_df$measure1<- if_else(bootratio_df$measure == "pup_ba", "PUP",
                                 if_else(bootratio_df$measure == "Bio_Me", "HR",
                                         if_else(bootratio_df$measure == "log1p_", "SCR", NULL)))

left_join(bootratio_df, cluster_stim)%>%
  subset(abs(V1)> 2 & abs(V2)< 2)%>% #| abs(V1)>2 & abs(V2)>2
  select(c(V1:stimIAPS2, stimDescription))%>%
  group_by(stimDescription)%>%
  mutate(n = n())%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(label = stimDescription, size = n)) +
  ggwordcloud::geom_text_wordcloud() +
  theme_minimal()


left_join(bootratio_df, cluster_stim)%>%
  subset(abs(V1)> 2 & abs(V2)< 2)%>% #| abs(V1)>2 & abs(V2)>2
  select(c(V1:stimIAPS2, stimDescription,measure))%>%
  group_by(stimDescription,measure)%>%
  mutate(n = n())%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(label = stimDescription, size = n)) +
  ggwordcloud::geom_text_wordcloud() +
  theme_minimal()+
  facet_grid(~measure)


left_join(bootratio_df, cluster_stim)%>%
  subset(abs(V1)< 2 & abs(V2)> 2)%>% #| abs(V1)>2 & abs(V2)>2
  select(c(V1:stimIAPS2, stimDescription,measure))%>%
  group_by(stimDescription,measure1)%>%
  mutate(n = n())%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(label = stimDescription, size = n)) +
  ggwordcloud::geom_text_wordcloud() +
  theme_minimal()+
  facet_grid(~measure1)


left_join(bootratio_df, cluster_stim)%>%
  subset(abs(V1)> 2 & abs(V2)> 2)%>% #| abs(V1)>2 & abs(V2)>2
  select(c(V1:stimIAPS2, stimDescription,measure,measure1))%>%
  group_by(stimDescription,measure1)%>%
  mutate(n = n())%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(label = stimDescription, size = n)) +
  ggwordcloud::geom_text_wordcloud() +
  theme_minimal()+
  facet_grid(~measure1)


bootratio_df2<- left_join(bootratio_df, cluster_stim)

bootratio_df2$MeasureStim<- paste0(bootratio_df2$measure1, paste0(".",bootratio_df2$stimDescription))
unique(bootratio_df2$MeasureStim)

?prettyGraphs::prettyBars
prettyGraphs::prettyBars(bootratio_df2$V1,
                         axis = 2)

newnames_var<- bootratio_df2$MeasureStim
  
  
  
library(tidyverse)
test<- left_join(bootratio_df, cluster_stim)%>%
  subset(abs(V1)< 2 & abs(V2)> 2)
  
test


unique(test$stimIAPS2)

```

# 24 seems to be an outlier

```{r}

# AQ median split
var.PCA.inf_asd_aq <-InPosition::epPCA.inference.battery(var.data_asd, 
                                       scale = TRUE, 
                                       center = TRUE, 
                                       DESIGN = var.design_asd_aq,
                                       make_design_nominal = TRUE, 
                                       graphs = TRUE, k = 0, 
                                       test.iters = 1000, 
                                       constrained = FALSE, critical.value = 2)
# who is 51 = 604

InPosition::inGraphs(var.PCA.inf_asd_aq, y_axis = 2)
InPosition::inGraphs(var.PCA.inf_asd_aq, y_axis = 2)

# TAS median split
var.PCA.inf_asd_tas <-InPosition::epPCA.inference.battery(var.data_asd, 
                                       scale = TRUE, 
                                       center = TRUE, 
                                       DESIGN = var.design_asd_tas,
                                       make_design_nominal = TRUE, 
                                       graphs = TRUE, k = 0, 
                                       test.iters = 1000, 
                                       constrained = FALSE, critical.value = 2)
# who is 51 = 604

InPosition::inGraphs(var.PCA.inf_asd_aq, y_axis = 2)

# BADIA

# Group AS
ar.design_tas_49_2[c(1:23, 25:49)]
var.BADA.inf_asd_group <- TInPosition::tepBADA.inference.battery(var.data_asd, 
                                                       scale = FALSE, 
                                                       center = FALSE, 
                                                       DESIGN = var.design_asd_group,
                                                       make_design_nominal = TRUE,
                                                       group.masses = NULL, 
                                                       weights = NULL, 
                                                       graphs = FALSE, 
                                                       k = 0, 
                                                       test.iters = 1000, 
                                                       critical.value = 2)

var.BADA.inf_asd_group$Inference.Data$omni$p.val
var.BADA.inf_asd_group$Inference.Data$components$p.vals
var.BADA.inf_asd_group$Inference.Data$r2$p.val
var.BADA.inf_asd_group$Inference.Data$r2$r2.perm


var.BADA.inf_asd_group$Inference.Data$components$p.vals
# aq split

var.BADA.inf_asd_group <- TInPosition::tepBADA.inference.battery(var.data_asd, 
                                                       scale = FALSE, 
                                                       center = FALSE, 
                                                       DESIGN = var.design_asd_aq,
                                                       make_design_nominal = TRUE,
                                                       group.masses = NULL, 
                                                       weights = NULL, 
                                                       graphs = TRUE, 
                                                       k = 0, 
                                                       test.iters = 1000, 
                                                       critical.value = 2)
# tas

var.BADA.inf_asd_group$Inference.Data$omni$p.val
var.BADA.inf_asd_group$Inference.Data$omni$inertia

var.BADA.inf_asd_group$Inference.Data$r2$r2
var.BADA.inf_asd_group$Inference.Data$r2$p.val
# aq split

var.BADA.inf_asd_tas <- TInPosition::tepBADA.inference.battery(var.data_asd, 
                                                       scale = FALSE, 
                                                       center = FALSE, 
                                                       DESIGN = var.design_asd_tas,
                                                       make_design_nominal = TRUE,
                                                       group.masses = NULL, 
                                                       weights = NULL, 
                                                       graphs = FALSE, 
                                                       k = 0, 
                                                       test.iters = 1000, 
                                                       critical.value = 2)

var.BADA.inf_asd_tas$Inference.Data$omni$p.val
var.BADA.inf_asd_tas$Inference.Data$omni$inertia

var.BADA.inf_asd_tas$Inference.Data$r2$r2
var.BADA.inf_asd_tas$Inference.Data$r2$p.val

var.BADA.inf_asd_group$Inference.Data$components$p.vals
var.BADA.inf_asd_tas$Inference.Data$components$p.vals
var.BADA.inf_asd_tas$Fixed.Data$TExPosition.Data$assign$
?ExPosition::epPCA


sum(var.PCA.inf_asd$Fixed.Data$ExPosition.Data$t) #explained variuances
# 
# color<- bind_rows(as.data.frame(rep("#305ABF", 56)),as.data.frame(rep("#84BF30", 56)),as.data.frame(rep("#84BF30", 56)))
# 
# rep("#84BF30", 56)
# rep("red", 56)

row.cols <- read.csv("row_cols.csv",header=TRUE)
row.cols <- row.cols[,2]
x_axis <- 1
y_axis <- 2
tau <- var.PCA.inf_asd$Fixed.Data$ExPosition.Data$t # variance
p.val <- var.PCA.inf_asd$Inference.Data$components$p.vals
xlab = paste("Component", x_axis, "Variance:",round(tau[x_axis],digits = 2),"%, ","p =",p.val[x_axis])
ylab = paste("Component", y_axis, "Variance:",round(tau[y_axis],digits = 2),"%, ","p =",p.val[y_axis])
main = "PCA with Inference"

var.PCA.inf_asd$Inference.Data$components$eigs.perm
?prettyPlot

write_csv("var.PCA.inf_asd_forpca.csv", var.data_asd)




summary(var.PCA.inf_asd)

var.PCA.inf_asd$Inference.Data$components$eigs

plot(var.PCA.inf_asd$Inference.Data$components$eigs)

# return just componet 1
var.PCA.inf_asd[["Inference.Data"]][["fj.boots"]][["boots"]]
as.data.frame(var.PCA.inf_asd$Inference.Data$fj.boots$boots)
test<- var.PCA.inf_asd$Inference.Data$fj.boots$boots
is.matrix(test)
is.list(test)

boottest <- as.data.frame(var.PCA.inf_asd$Inference.Data$fj.boots$tests$boot.ratios[,1:2])
boottest$stimIAPS<- row.names(boottest)
boottest

boottest$stimIAPS2<- sub('.*\\_', '', boottest$stimIAPS)

# merge descriptiopns
nrow(boottest)
nrow(new.data3)

db_full6new_hr_fix_stim_select5.3

stimiapstomerge<- new.data3 %>%
  subset(!is.na(stimDescription))%>%
  group_by(stimIAPS2,stimDescription)%>%
  summarise_at(c("arousal", "valence", "ValenceMean", "ArousalMean",
                 "log1p_BIO_CDA.PhasicMax",
                 "pup_basCor",
                 "Bio_Mean_HR_dif"), mean, na.rm = TRUE)
new.data3$stimIAPS2

boottest1 <- left_join(boottest, stimiapstomerge)

boottest1$variable_stim<- boottest1$stimIAPS
boottest1$variable_stim2<- substr(boottest1$variable_stim,1,9)

# return the name of the column witha  maximum value above 2
apply(df[,-1],1,function(x) names(df[,-1])[which(x>0.33)])


```
 

```{r}
boottest1$PC<- apply(boottest1[,1:2],1,function(x) names(boottest1[,1:2])[which(abs(x)>2)] 
      [which(abs(x) == max(abs(x)))])
# boottest1$PC<- if_else()

boottest1%>%
  subset(PC == "V1")%>%
  arrange(V1)%>%
  ggplot(aes(arousal))+
  geom_density(fill = "blue", alpha = .1)+
  geom_density(aes(x = valence), fill = "red", alpha = .4)+
  p$graphstyle


boottest1%>%
  subset(PC = "V2")%>%
  arrange(V2)%>%
  ggplot(aes(arousal))+
  geom_density(fill = "blue", alpha = .1)+
  geom_density(aes(x = 0-valence), fill = "red", alpha = .4)+
  p$graphstyle
  



unique(boottest1$PC)
# 
# unique(boottest$stimIAPS2)
# test[1:168,1,mean(1:1000)]

boottest1%>%
  subset(PC == "V1")%>%
  arrange(V1)


boottest1 %>%
  subset(!is.na(PC))%>%
  group_by(PC,stimIAPS2,stimDescription)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(PC, arousal))+
   geom_jitter(width = .1, alpha = .2)+
  geom_text(aes(label = stimDescription))+
  stat_summary(geom= "pointrange")+ggpubr::stat_compare_means()

boottest1%>%
  subset(!is.na(PC))%>%
   group_by(PC,stimIAPS2,stimDescription)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(PC, valence))+
  geom_jitter(width = .1, alpha = .2)+
  geom_text(aes(label = stimDescription))+
  stat_summary(geom= "pointrange")+
  ggpubr::stat_compare_means()


boottest1%>%
  subset(!is.na(PC))%>%
   group_by(PC,stimIAPS2,stimDescription)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(PC, log1p_BIO_CDA.PhasicMax))+
  geom_jitter(width = .1, alpha = .2)+
  # geom_text(aes(label = stimDescription))+
  stat_summary(geom= "pointrange")+
  ggpubr::stat_compare_means()


boottest1%>%
  subset(!is.na(PC))%>%
   group_by(PC,stimIAPS2,stimDescription)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(PC, pup_basCor))+
  geom_jitter(width = .1, alpha = .2)+
  # geom_text(aes(label = stimDescription))+
  stat_summary(geom= "pointrange")+
  ggpubr::stat_compare_means()


boottest1%>%
  subset(!is.na(PC))%>%
   group_by(PC,stimIAPS2,stimDescription)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(PC, Bio_Mean_HR_dif))+
  geom_jitter(width = .1, alpha = .2)+
  # geom_text(aes(label = stimDescription))+
  stat_summary(geom= "pointrange")+
  ggpubr::stat_compare_means()


boottest1%>%
  subset(!is.na(PC))%>%
   group_by(PC,stimIAPS2,stimDescription)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(PC, V2))+
  geom_jitter(width = .1, alpha = .2)+
  geom_text(aes(label = stimDescription))+
  stat_summary(geom= "pointrange")+
  ggpubr::stat_compare_means()


boottest1 %>%
  subset(is.na(PC) == TRUE)%>%
  group_by(PC,stimIAPS2,stimDescription)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(PC, arousal))+
  # geom_jitter(width = .1, alpha = .2)+
  geom_text(aes(label = stimDescription))+
  stat_summary(geom= "pointrange")+
  ggpubr::stat_compare_means()
```

# store factor scores
```{r}
var.PCA.inf_asd[["Fixed.Data"]][["ExPosition.Data"]][["cj"]][,1:3]


```
score_test <-var.PCA.inf_asd[["Fixed.Data"]][["ExPosition.Data"]][["fi"]][,1:3]
var.PCA.inf_asd


```{r}
library(ggplot2)
library(tidyverse)
# I think this is storing the first 2
as.data.frame(score_test)%>%
  ggplot(aes(V1, V2))+
  geom_point(aes(color = var.design_asd))

# now bidn this to dataset
# all.data_a

# store pcs on the data
var.data_asd_with2pcs$PC1 <- score_test[,1]
var.data_asd_with2pcs$PC2 <- score_test[,2]
var.data_asd_with2pcs$PC2 <- score_test[,2]

all.data_asd$PC1 <- score_test[,1]
all.data_asd$PC2 <- score_test[,2]
all.data_asd$PC3 <- score_test[,3]

# now try kmeans on the components
all.data_asd2pcs<- all.data_asd

# var.data_asd_with2pcs

colnames(all.data_asd2pcs)
all.data_asd2pcs_forkmean<- all.data_asd2pcs[,c(1,2,171:173)]
# Feature Scaling
# training_set = scale(training_set)
# test_set = scale(test_set)

# Using the elbow method to find the optimal number of clusters
set.seed(1)
wcss = vector()
for (i in 1:10) wcss[i] = sum(kmeans(scaled_all.data_asd2pcs_forkmean[,c(1:2,5)], i)$withinss)
plot(1:10,
     wcss,
     type = 'b',
     main = paste('The Elbow Method'),
     xlab = 'Number of clusters',
     ylab = 'WCSS')

# 3 or 2

# Fitting K-Means to the dataset
set.seed(25)

?kmeans
kmeans_res = kmeans(x = scaled_all.data_asd2pcs_forkmean, centers = 2)
y_kmeans = kmeans_res$cluster
rm(kmeans)

kmeans_res$

install.packages("factoextra")


```

# Visualising the clusters
# install.packages("cluster")
library(cluster)

# ?clusplot

clust_dataset_scaled
y_kmeans

scaled_all.data_asd2pcs_forkmean$y_kmeans<- y_kmeans

# all.data_asd2pcs_forkmean$TAS<- all.data

mean(all.data_asd2pcs_forkmean$PC1)
sd(all.data_asd2pcs_forkmean$PC1)
mean(all.data_asd2pcs_forkmean$PC2)
sd(all.data_asd2pcs_forkmean$PC2)
scaled_all.data_asd2pcs_forkmean <- as.data.frame(scale(all.data_asd2pcs_forkmean[,3:4])[,1:2])

?cluster::clusplot()
clust_plotalkmean<- clusplot(scaled_all.data_asd2pcs_forkmean,
         scaled_all.data_asd2pcs_forkmean$y_kmeans,
         lines = 2,
         shade = TRUE,
         color = TRUE,
         labels = 1,
         plotchar = FALSE,
         span = TRUE
         # label = 
         # main = paste('Clusters of customers'),
         # xlab = 'Annual Income',
         # ylab = 'Spending Score'
         )


pca_res <- prcomp(clustering_agg[,c(25,24,20)], center = TRUE, scale. = TRUE)
pca_res <- prcomp(clustering_agg_JASPtest[,c(24,23,19)], center = TRUE, scale. = TRUE)
plot_data <- cbind(as.data.frame(pca_res$x[, 1:2]), labels = clustering_agg$y_kmeans)

plot_data_kmeanpca<- scaled_all.data_asd2pcs_forkmean$ssid
scaled_all.data_asd2pcs_forkmean


scaled_all.data_asd2pcs_forkmean

all.data_asd2.1$TAS
all.data_asd2.1$ssid
scaled_all.data_asd2pcs_forkmean$ssid

scaled_all.data_asd2pcs_forkmean$TAS<- all.data_asd2.1$TAS
# plot_data$

colnames(all.data_asd2.1)

# all.data_asd2pcs2.1_forkmean$
# left_join(scaled_all.data_asd2pcs_forkmean,all.data_asd2.1[,1:2], by = "ssid")%>%

```{r}

all.data_asd2pcs2.1_forkmean$Cluster <- as.factor(all.data_asd2pcs2.1_forkmean$y_kmeans)
  
kmeanplots <- list()

kmeanplots$Kmeanplot<-
all.data_asd2pcs2.1_forkmean%>%

  ggplot(aes(x = PC1, y = PC2, colour = Cluster, fill = Cluster, linetype = Cluster, shape = Cluster)) +
  geom_point(size = 2, alpha = .6)+
  # geom_text(aes(label= ssid))+
  stat_ellipse(aes(fill = Cluster), show.legend = TRUE, size = 2)+
  ylab("Componet 2")+
  xlab("Component 1")+
  scale_fill_brewer(palette= "Dark2")+   
    scale_color_brewer(palette= "Dark2")+
  p$graphstyle_tsne +
  theme()

kmeanplots$Kmeanplot

# silhouete

?factoextra::fviz_nbclust
kmeanplots$clustsilhoute <- factoextra::fviz_nbclust(scaled_all.data_asd2pcs_forkmean[,c(1:2,5)], 
                         kmeans, 
                         method='silhouette') +
  xlab("k")+
  ylab("Silhouette")+
  p$graphstyle
kmeanplots$clustsilhoute
clustsilhoute$data

clustsilhoute


kmeanplots$clustelbow<- factoextra::fviz_nbclust(scaled_all.data_asd2pcs_forkmean[,c(1:2,5)], kmeans, method = "wss")+
  xlab("k")+
  ylab("WCSS")+
  p$graphstyle

kmeanplots$clustelbow
clustelbow$data
  
kmeanplots

all.data_asd2pcs2.1_forkmean
scaled_all.data_asd2pcs_forkmean

kmeanplots$cluster_vs_PC <-

all.data_asd2pcs2.1_forkmean %>%
gather( key = "measurement", value = "value",
       PC1, PC2, -Cluster,-ssid)%>%
  ggplot(aes(Cluster, value, fill = measurement,color = measurement, linetype = measurement))+
  stat_summary(geom = "pointrange", position = position_dodge(1), size = 1)+
    geom_bar(stat="summary", fun.y = "mean", alpha = .5, width = .5, position = position_dodge(1), size = 1.5)+
  geom_hline(yintercept = 0, size = 2, linetype = "dashed", alpha = .4)+
  scale_fill_brewer(palette = "Dark2")+
  scale_color_brewer(palette = "Dark2")+
  p$graphstyle

kmeanplots$cluster_vs_PC

# now cluster vs AQ and TAS

# create those density separatio plots
write_csv(all.data_asd2pcs2.1_forkmean, "all.data_asd2pcs2.1_forkmean.csv")

all.data_asd2pcs2.1_forkmean

kmeanplots$density<-
all.data_asd2pcs2.1_forkmean%>%
gather( key = "measurement", value = "value",
       PC1, PC2, -ssid, - Cluster)%>%
  ggplot(aes(value, fill = Cluster))+
  geom_density(color = FALSE, alpha = .6)+
  facet_grid(~measurement)+
  ylab("Density")+
  
  p$graphstyle+
  scale_fill_brewer(palette = "Dark2")+
  scale_color_brewer(palette = "Dark2")+
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank())


kmeanplots$aq_kmeans


```

```{r}
plot_datakmeans$tot.withinss/kmeans$totss

kmeans$tot.withinss/ kmeans$betweenss
(kmeans$tot.withinss + kmeans$betweenss)/kmeans$totss
db_full6new_hr_fix_stim_select5

# 
ssid_tasaq<- db_full6new_hr_fix_stim_select3%>%
  group_by(ssid, Group)%>%
  summarise_at(c('TAS', 'AQ'), mean, na.rm = TRUE)
# ssid_tas_aq<- select(db_full6new_hr_fix_stim_select3, c(ssid, TAS))

scaled_all.data_asd2pcs_forkmean$ssid<- all.data_asd2pcs_forkmean$ssid

left_join(scaled_all.data_asd2pcs_forkmean ,ssid_tasaq)%>%
  ggplot(aes(as.factor(y_kmeans), AQ))+
  stat_summary(geom = "pointrange")+
  geom_text(aes(label = ssid), alpha = .1)+
  ggpubr::stat_compare_means()

kmeans$ifault

left_join(scaled_all.data_asd2pcs_forkmean ,ssid_tasaq)%>%
  ggplot(aes(as.factor(y_kmeans), TAS))+
  stat_summary(geom = "pointrange")+
  geom_text(aes(label = ssid), alpha = .1)+
  ggpubr::stat_compare_means()


  ggplot(aes(Cluster, value, fill = measurement,color = measurement, linetype = measurement))+
  stat_summary(geom = "pointrange", position = position_dodge(1), size = 1)+
    geom_bar(stat="summary", fun.y = "mean", alpha = .5, width = .5, position = position_dodge(1), size = 1.5)+
  geom_hline(yintercept = 0, size = 2, linetype = "dashed", alpha = .4)+
  scale_fill_brewer(palette = "Dark2")+
  scale_color_brewer(palette = "Dark2")+
  p$graphstyle



# aq kmean plot
  
  
  kmeanplots$aq_kmeans<-
left_join(scaled_all.data_asd2pcs_forkmean ,ssid_tasaq)%>%
  # subset(Group == "NT")%>%
  ggplot(aes(as.factor(y_kmeans), AQ))+
   geom_jitter(aes(color = Group, shape = Group),width = .1, alpha = .5)+
  stat_summary(geom = "pointrange")+
  geom_boxplot(alpha = .5, width = .5, size = .6)+
  # facet_grid(~measurement)+
  ggpubr::stat_compare_means(method = "t.test")+
  scale_fill_brewer(palette = "Dark2")+
  scale_color_brewer(palette = "Dark2")+
  xlab("Cluster")+
  ylab("Austistic Traits")+
  p$graphstyle

  
    kmeanplots$tas_kmeans<-
left_join(scaled_all.data_asd2pcs_forkmean ,ssid_tasaq)%>%
  # subset(Group == "NT")%>%
  ggplot(aes(as.factor(y_kmeans), TAS))+
      geom_jitter(aes(color = Group, shape = Group),width = .1, alpha = .5)+
  stat_summary(geom = "pointrange")+
  geom_boxplot(alpha = .5, width = .5, size = .6)+
  # facet_grid(~measurement)+
  ggpubr::stat_compare_means(method = "t.test")+
  scale_fill_brewer(palette = "Dark2")+
  scale_color_brewer(palette = "Dark2")+
  xlab("Cluster")+
  ylab("Alexithymic Traits")+
  p$graphstyle

    kmeanplots$aq_kmeans
    kmeanplots$tas_kmeans
```

Bow how thus clustering relates to subjective ratings
```{r}
gather(new.data3, key = "measurement", value = "value",
       PC1, PC2, -ssid, - y_kmeans, -pca_v1_v2)
  # subset(Group == "NT")%>%
  
kmeanplots$valence_kmean <-  
  new.data3%>%
  group_by(ssid,Group, y_kmeans)%>%
  # mutate(value1 = scale(value))%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  
  ggplot(aes(as.factor(y_kmeans),valence))+
  geom_jitter(aes(color = Group, shape = Group),width = .1, alpha = .5)+
  stat_summary(geom = "pointrange")+
  geom_boxplot(alpha = .5, width = .5, size = .6)+
  # facet_grid(~measurement)+
  ggpubr::stat_compare_means(method = "t.test")+
    xlab("Cluster")+
    ylab("Subjective Valence")+
    scale_fill_brewer(palette = "Dark2")+
  scale_color_brewer(palette = "Dark2")+
    p$graphstyle


kmeanplots$arousal_kmean <-  
  new.data3%>%
  group_by(ssid,Group, y_kmeans)%>%
  # mutate(value1 = scale(value))%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  
  ggplot(aes(as.factor(y_kmeans),arousal))+
  geom_jitter(aes(color = Group, shape = Group),width = .1, alpha = .5)+
  stat_summary(geom = "pointrange")+
  geom_boxplot(alpha = .5, width = .5, size = .6)+
  # facet_grid(~measurement)+
  ggpubr::stat_compare_means(method = "t.test")+
    xlab("Cluster")+
    ylab("Subjective Arousal")+
    scale_fill_brewer(palette = "Dark2")+
  scale_color_brewer(palette = "Dark2")+
    p$graphstyle

kmeanplots$arousal_kmean 
kmeanplots$valence_kmean 

new.data3_agg<- new.data3%>%
  group_by(ssid,Group, y_kmeans)%>%
  # mutate(value1 = scale(value))%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)

t.test(new.data3_agg$TAS.x[new.data3_agg$y_kmeans == 1],new.data3_agg$TAS.x[new.data3_agg$y_kmeans == 2] )
t.test(new.data3_agg$AQ.x[new.data3_agg$y_kmeans == 1],new.data3_agg$AQ.x[new.data3_agg$y_kmeans == 2] )

kmeanplots

(kmeanplots$Kmeanplot + kmeanplots$clustsilhoute + kmeanplots$clustelbow+
  kmeanplots$cluster_vs_PC + kmeanplots$density+kmeanplots$aq_kmeans + kmeanplots$tas_kmeans+
  kmeanplots$valence_kmean+ kmeanplots$arousal_kmean)

# just clustering plots
kmeanplots$patchwork1 <- ((kmeanplots$Kmeanplot / 
  (kmeanplots$clustsilhoute + kmeanplots$clustelbow)+
  (kmeanplots$cluster_vs_PC + kmeanplots$density))|
  (kmeanplots$valence_kmean/kmeanplots$arousal_kmean/kmeanplots$aq_kmeans/kmeanplots$tas_kmeans))+
  patchwork::plot_layout(widths = c(2,1))+
  # nrow = 3, heights = c(2,1,1,1)
  plot_annotation(tag_levels = "A")


ggsave("jkmean_patchwork1.tiff", kmeanplots$patchwork1, device = "tiff", width = 10, height = 10, dpi = 800)

ggsave("jkmean_patchwork1.tiff", kmeanplots$patchwork1, device = "tiff", width = 10, height = 12, dpi = 800)

kmeanplots$aq_kmeans
kmeanplots$tas_kmeans

kmeanplots$valence_kmean
kmeanplots$arousal_kmean

new.data3
t.test(new.data3_agg$arousal[new.data3_agg$y_kmeans == 1],new.data3_agg$arousal[new.data3_agg$y_kmeans == 2] )
t.test(new.data3_agg$valence[new.data3_agg$y_kmeans == 1],new.data3_agg$valence[new.data3_agg$y_kmeans == 2] )

new.data3_forlmer<- new.data3%>%
  group_by(ssid, stimIAPS2, Group, y_kmeans)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)

# first do thes egroups whos diferences in trial by trial valence and arousal
new.data3_forlmer$Cluster<- as.factor(new.data3_forlmer$y_kmeans)
new.data3_forlmer$ssid<- as.factor(new.data3_forlmer$ssid)
new.data3_forlmer$stimIAPS2<- as.factor(new.data3_forlmer$stimIAPS2)

dimensional_lmers<- list()
library(lmerTest)
dimensional_lmers$val_clust <- lmer(valence ~ Cluster + (1|ssid)+
                        (1|stimIAPS2), REML = FALSE,
                        data = new.data3_forlmer)

summary(dimensional_lmers$val_clust)


dimensional_lmers$ar_clust <- lmer(arousal ~ Cluster + (1|ssid)+
                        (1|stimIAPS2), REML = FALSE,
                        data = new.data3_forlmer)

summary(dimensional_lmers$ar_clust)


# 

dimensional_lmers$val_pca_tas <- lmer(valence ~ (PC1_z + PC2_z)*TASc +(1|ssid)+
                        (1|stimIAPS2), REML = FALSE,
                        data =new.data3_forlmer%>%
                          subset(Group == "NT"))

summary(dimensional_lmers$val_pca_tas)
new.data3_forlmer$PC1_z<- scale(new.data3_forlmer$PC1)[,1]
new.data3_forlmer$PC2_z<- scale(new.data3_forlmer$PC2)[,1]
dimensional_lmers$ar_pca_tas <- lmer(arousal ~ (PC1_z + PC2_z)*TASc +(1|ssid)+
                        (1|stimIAPS2), REML = FALSE,
                        data = new.data3_forlmer%>%
                          subset(Group == "NT")%>%
                           subset(ssid!=336))

summary(dimensional_lmers$ar_pca_tas)


# AQ

dimensional_lmers$val_pca_aq <- lmer(valence ~ (PC1 + PC2)*AQc+ (1|ssid)+
                        (1|stimIAPS2), REML = FALSE,
                        data = new.data3_forlmer%>%
                          subset(Group == "NT"))

summary(dimensional_lmers$val_pca_aq)

dimensional_lmers$ar_pca_aq <- lmer(arousal ~ (PC1 + PC2)*AQc+ (1|ssid)+
                        (1|stimIAPS2), REML = FALSE,
                        data = new.data3_forlmer%>%
                          subset(Group == "NT"))

summary(dimensional_lmers$ar_pca_aq)

# the effects mirror one another
# the aq effect is primarly driven by autistic participants
# combine aq and tas

dimensional_lmers$val_pca_aq_tas <- lmer(valence ~ (PC1 + PC2)* (AQc+TASc)+ (1|ssid)+
                        (1|stimIAPS2), REML = FALSE,
                        data = new.data3_forlmer%>%
                          subset(ssid!=336))
                        # %>%
                          # subset(Group == "NT"))

summary(dimensional_lmers$val_pca_aq_tas)

dimensional_lmers$ar_pca_aq_tas <- lmer(arousal ~ (PC1 + PC2)*(AQc+TASc)+ (1|ssid)+
                        (1|stimIAPS2), REML = FALSE,
                        data = new.data3_forlmer%>% subset(ssid!=336))
                        # %>%
                          subset(Group == "NT"))

unique(new.data3_forlmer$ssid)

summary(dimensional_lmers$ar_pca_aq_tas)

```


scaled_all.data_asd2pcs_forkmean$PC3<- all.data_asd2pcs_forkmean$PC3

scaled_all.data_asd2pcs_forkmean2<- left_join(scaled_all.data_asd2pcs_forkmean ,ssid_tasaq)

table(scaled_all.data_asd2pcs_forkmean2$Group, scaled_all.data_asd2pcs_forkmean2$y_kmeans)

scaled_all.data_asd2pcs_forkmean2$alex_median<- if_else(scaled_all.data_asd2pcs_forkmean2$TAS> median(scaled_all.data_asd2pcs_forkmean2$TAS, na.rm = TRUE), "High", "Low")


table(scaled_all.data_asd2pcs_forkmean2$alex_median, scaled_all.data_asd2pcs_forkmean2$y_kmeans)


scaled_all.data_asd2pcs_forkmean2%>%
  ggplot(aes(as.factor(y_kmeans), TAS))+
  stat_summary(geom = "pointrange")+
  geom_text(aes(label = ssid), alpha = .1)+
  facet_grid(~alex_median)

scaled_all.data_asd2pcs_forkmean2$km_gr<- paste0(scaled_all.data_asd2pcs_forkmean2$y_kmeans, paste0(scaled_all.data_asd2pcs_forkmean2$Group))

scaled_all.data_asd2pcs_forkmean2%>%
  ggplot(aes(km_gr, TAS))+
  stat_summary(geom = "pointrange")+
  geom_text(aes(label = ssid), alpha = .1)
  facet_grid(~alex_median)
  
  
  # flag just the sigmificant variables
  # subset to keep the varioables that came sgnificant ut of the infernce PCA for either of the first 2 or 3 dimmensions
  signiftestpca_df<- as.data.frame(signiftestpca)
  signiftestpca1_2<- signiftestpca_df%>%
                            any(~(V1, V2) == TRUE)
  
  unique(signiftestpca1_2$V1)
  unique(signiftestpca1_2$V2)  
  
  new.data <- signiftestpca_df[ which( signiftestpca_df$V1 == TRUE | signiftestpca_df$V2 == TRUE) , ]
  
  
  unique(new.data$V1)
  unique(new.data$V2)
  
  View(new.data)
  
  new.data
  new.data$pca_v1_v2<- paste0(new.data$V1, paste0(new.data$V2))
  unique( new.data$pca_v1_v2)
  new.data1<- select(new.data, c(V1, V2, V3, pca_v1_v2))
  
  # store row name into a variable
  new.data1$variable<- rownames(new.data1)
  
  
  # extract pattern after the last underscore
     new.data1$stimIAPS2<- sub('.*\\_', '', new.data1$variable)
  new.data1$stimIAPS2
  
    new.data1$InPCA<- "YES"
    
    scaled_all.data_asd2pcs_forkmean2
    
    new.data1
     unique( new.data1$pca_v1_v2)


# merge this back with the full data
        db_full6new_hr_fix_stim_select5
        
        unique(scaled_all.data_asd2pcs_forkmean2$ssid)
  kmean_pca_longdata  <- left_join(scaled_all.data_asd2pcs_forkmean2, db_full6new_hr_fix_stim_select3, 
                                   by = c("ssid", "Group"))
  
  kmean_pca_longdata
  
 # new.data2 <- new.data1%>%
 #    arrange(stimIAPS2)%>%
 #    subset(!duplicated(stimIAPS2))
 
 new.data2<- new.data1
 
 unique( new.data2$pca_v1_v2)
 
 unique(new.data2)
 unique(kmean_pca_longdata$ssid)
 
 kmean_pca_longdata
new.data3<- left_join( new.data2,kmean_pca_longdata)
  # left_join( new.data2,kmean_pca_longdata) %>%

unique(new.data3$pca_v1_v2)


V3

all.data_asd2pcs_forkmean
new.data3$PC3<- all.data_asd2pcs_forkmean$PC3


# this is however takling all the data not only the data PCA deemed to be imorttant

new.data3$pca_v1_v2

unique(new.data3$stimIAPS2)
unique(new.data3$pca_v1_v2)

```{r}
new.data3 %>%
  # subset(Group == "NT")%>%
  subset(ssid!=336)%>%
    group_by(ssid, Group)%>%
    summarise_if(is.numeric, mean, na.rm = TRUE)%>%
    ggplot(aes( AQ.y, PC1))+
  geom_point()+
  geom_smooth(method = 'lm', se = F)+
  geom_text(aes(label = ssid))+
  ggpubr::stat_cor()+
    stat_ellipse()

?  ggpubr::stat_cor

new.data3 %>%
  # subset(Group == "NT")%>%
  subset(ssid!=336)%>%
    group_by(ssid, Group)%>%
    summarise_if(is.numeric, mean, na.rm = TRUE)%>%
    ggplot(aes( TAS.y, PC1))+
  geom_point()+
  geom_smooth(method = 'lm', se = F)+
  geom_text(aes(label = ssid))+
  ggpubr::stat_cor()+
    # stat_ellipse()+
  p$graphstyle

install.packages("ppcor")


new.data3.1<- new.data3 %>%
  # subset(Group == "NT")%>%
  subset(ssid!=336)

new.data3.2<- subset(new.data3.1, !is.na(TAS.x))

scaled_all.data_asd2pcs_forkmean_forcor<- left_join(scaled_all.data_asd2pcs_forkmean ,ssid_tasaq)

scaled_all.data_asd2pcs_forkmean_forcor_nona<- subset(scaled_all.data_asd2pcs_forkmean_forcor, !is.na(TAS))
ppcor::pcor.test(scaled_all.data_asd2pcs_forkmean_forcor_nona$TAS, scaled_all.data_asd2pcs_forkmean_forcor_nona$PC1, scaled_all.data_asd2pcs_forkmean_forcor_nona$AQ)

cor.test(scaled_all.data_asd2pcs_forkmean_forcor_nona$AQ, scaled_all.data_asd2pcs_forkmean_forcor_nona$PC1)

cor.test(scaled_all.data_asd2pcs_forkmean_forcor_nona$AQ, scaled_all.data_asd2pcs_forkmean_forcor_nona$PC2)

ppcor::pcor.test(scaled_all.data_asd2pcs_forkmean_forcor_nona$AQ, scaled_all.data_asd2pcs_forkmean_forcor_nona$PC1, scaled_all.data_asd2pcs_forkmean_forcor_nona$TAS) #not significanr

# exclude 336
scaled_all.data_asd2pcs_forkmean_forcor_nona1<- scaled_all.data_asd2pcs_forkmean_forcor_nona%>%
  subset(ssid!=336)


ppcor::pcor.test(scaled_all.data_asd2pcs_forkmean_forcor_nona1$TAS, scaled_all.data_asd2pcs_forkmean_forcor_nona1$PC1, scaled_all.data_asd2pcs_forkmean_forcor_nona1$AQ)

ppcor::pcor.test(scaled_all.data_asd2pcs_forkmean_forcor_nona1$AQ, scaled_all.data_asd2pcs_forkmean_forcor_nona1$PC1, scaled_all.data_asd2pcs_forkmean_forcor_nona1$TAS)
  


ppcor::pcor.test(AQ, PC1, TAS) 

pcor(test_teoPi,method="spearman")$estimate


# new.data3 %>%
#   # subset(Group == "NT")%>%
#   subset(ssid!=336)%>%
#     group_by(ssid, Group)%>%
#     summarise_if(is.numeric, mean, na.rm = TRUE)%>%

unique(scaled_all.data_asd2pcs_forkmean_forcor_nona1$ssid)

selfrep_pc_plots<-list()
selfrep_pc_plots$TASpc1<-
scaled_all.data_asd2pcs_forkmean_forcor_nona1%>%
  subset(ssid!=336)%>%
  ggplot(aes( TAS, PC1))+
  geom_point(aes(color = Group, shape = Group), alpha = .7, size = 2)+
  geom_smooth(method = 'lm', se = F)+
  # geom_text(aes(label = ssid))+
  ggpubr::stat_cor()+
  xlab("Autism")+
  p$graphstyle+
  scale_color_brewer(palette = "Dark2")+
    scale_fill_brewer(palette = "Dark2")+
  scale_y_continuous(limits = c(-1.5, 2.5))

selfrep_pc_plots$TASpc1

selfrep_pc_plots$AQpc1<-
scaled_all.data_asd2pcs_forkmean_forcor_nona1%>%
  subset(ssid!=336)%>%
  ggplot(aes( AQ, PC1))+
  geom_point(aes(color = Group, shape = Group), alpha = .7, size = 2)+
  geom_smooth(method = 'lm', se = F)+
  # geom_text(aes(label = ssid))+

  xlab("Autsim")+
  p$graphstyle+
  scale_color_brewer(palette = "Dark2")+
    scale_fill_brewer(palette = "Dark2")+
  scale_y_continuous(limits = c(-1.5, 2.5))+
    ggpubr::stat_cor()

selfrep_pc_plots$AQpc1

# PC2
 

selfrep_pc_plots$TASpc2<-
scaled_all.data_asd2pcs_forkmean_forcor_nona1%>%
  subset(ssid!=336)%>%
  ggplot(aes( TAS, PC2))+
  geom_point(aes(color = Group, shape = Group), alpha = .7, size = 2)+
  geom_smooth(method = 'lm', se = F)+
  # geom_text(aes(label = ssid))+
  ggpubr::stat_cor()+
  xlab("Alexithymia")+
  p$graphstyle+
  scale_color_brewer(palette = "Dark2")+
    scale_fill_brewer(palette = "Dark2")+
  scale_y_continuous(limits = c(-1.5, 2.5))

selfrep_pc_plots$TASpc2

selfrep_pc_plots$AQpc2<-
scaled_all.data_asd2pcs_forkmean_forcor_nona1%>%
  subset(ssid!=336)%>%
  ggplot(aes( AQ, PC2))+
  geom_point(aes(color = Group, shape = Group), alpha = .7, size = 2)+
  geom_smooth(method = 'lm', se = F)+
  # geom_text(aes(label = ssid))+

  xlab("Alexithymia")+
  p$graphstyle+
  scale_color_brewer(palette = "Dark2")+
    scale_fill_brewer(palette = "Dark2")+
  scale_y_continuous(limits = c(-1.5, 2.5))+
    ggpubr::stat_cor()

selfrep_pc_plots$AQpc2   

selfrep_clust_patchwork<- 
  
  # ((kmeanplots$valence_kmean|kmeanplots$arousal_kmean|kmeanplots$aq_kmeans|kmeanplots$tas_kmeans)/
  ((selfrep_pc_plots$TASpc1|selfrep_pc_plots$AQpc1)/
  (selfrep_pc_plots$TASpc2|selfrep_pc_plots$AQpc2))+
  plot_layout(nrow = 2 )+
  plot_annotation(tag_levels = 'A')

ggsave("selfrep_clust_patchwork.tiff", selfrep_clust_patchwork, device = "tiff",
       width = 10, height = 10, dpi = 800)
```
      
      new.data3$Alex_median<- if_else(new.data3$TAS.x> median(new.data3$TAS.x, na.rm = TRUE), "High", "Low")
      
      new.data3 %>%
      
        subset(ssid!=336)%>%
        subset(!is.na(TAS.x))%>%
    group_by(ssid, Alex_median)%>%
    summarise_if(is.numeric, mean, na.rm = TRUE)%>%
    ggplot(aes( Alex_median, PC3))+
          stat_summary(geom = "pointrange")+
  # geom_point()+
  geom_smooth(method = 'lm', se = F)+
  geom_text(aes(label = ssid))+
        ylim(-1.6, 2.5)+
  ggpubr::stat_compare_means()
    # stat_ellipse()
  # stat_summary(geom = 'pointrange')+
      geom_jitter(alpha = .1, width = .1)+
  



```{r}
new.data3$PCAsolution<- paste0(new.data3$V1, paste0(new.data3$V2))

unique(new.data3$PCAsolution)
# show the average cluster profile

new.data3 %>%
    group_by(ssid, Group, y_kmeans)%>%
    summarise_if(is.numeric, mean, na.rm = TRUE)%>%
    ggplot(aes(as.factor(y_kmeans), pup_basCor, color = V1))+
  stat_summary(geom = 'pointrange')+
    # geom_jitter(alpha = .1, width = .1)
    facet_grid(Group~V2)


new.data3 %>%
  # group_by(ssid)%>%
  # mutate()
    group_by(ssid, y_kmeans)%>%
    summarise_if(is.numeric, mean, na.rm = TRUE)%>%
    ggplot(aes(as.factor(y_kmeans), log1p_BIO_CDA.PhasicMax))+
  stat_summary(geom = 'pointrange')+
    ggpubr::stat_compare_means()

```


```{r}
new.data3 %>%
  # group_by(ssid)%>%
  # mutate()
    group_by(ssid)%>%
    summarise_if(is.numeric, mean, na.rm = TRUE)%>%
    ggplot(aes(as.factor(y_kmeans), Bio_Mean_HR_dif))+
  stat_summary(geom = 'pointrange')+
      ggpubr::stat_compare_means()
    # geom_jitter(alpha = .1, width = .1)
    facet_grid(alex_median~V2)
    
    
    
    
new.data3 %>%
  # group_by(ssid)%>%
  # mutate()
    group_by(ssid)%>%
    summarise_if(is.numeric, mean, na.rm = TRUE)%>%
    ggplot(aes(as.factor(y_kmeans), pup_basCor))+
  stat_summary(geom = 'pointrange')+
      ggpubr::stat_compare_means()
    # geom_jitter(alpha = .1, width = .1)
    facet_grid(alex_median~V2)
    
    
    new.data3 %>%
  # group_by(ssid)%>%
  # mutate()
    group_by(ssid)%>%
    summarise_if(is.numeric, mean, na.rm = TRUE)%>%
    ggplot(aes(as.factor(y_kmeans), PC1))+
  stat_summary(geom = 'pointrange')+
      ggpubr::stat_compare_means()
    # geom_jitter(alpha = .1, width = .1)
    facet_grid(alex_median~V2)
    
    
    
        
    new.data3 %>%
  # group_by(ssid)%>%
  # mutate()
    group_by(ssid)%>%
    summarise_if(is.numeric, mean, na.rm = TRUE)%>%
    ggplot(aes(as.factor(y_kmeans), PC2))+
  stat_summary(geom = 'pointrange')+
      ggpubr::stat_compare_means()

```




new.data3%>%
  gather()
```{r}
gather(new.data3, key = "measurement", value = "value",
       pup_basCor, Bio_Mean_HR_dif,log1p_BIO_CDA.PhasicMax, -ssid, - y_kmeans, -pca_v1_v2)%>%
  # subset(!is.na(alex_median))%>%
  group_by(ssid)%>%
  mutate(value1 = scale(value))%>%
  ggplot(aes(measurement,value1, color = as.factor(pca_v1_v2)))+
  stat_summary(geom = "pointrange", position = position_dodge(1))+
  facet_grid(~y_kmeans)


gather(new.data3, key = "measurement", value = "value",
       pup_basCor, Bio_Mean_HR_dif,log1p_BIO_CDA.PhasicMax, -ssid, - y_kmeans, -pca_v1_v2)%>%
  # subset(!is.na(alex_median))%>%
  group_by(ssid)%>%
  mutate(value1 = scale(value))%>%
  ggplot(aes(measurement,value1))+
  stat_summary(geom = "pointrange", position = position_dodge(1))+
  facet_grid(pca_v1_v2~y_kmeans)



gather(new.data3, key = "measurement", value = "value",
       pup_basCor, Bio_Mean_HR_dif,log1p_BIO_CDA.PhasicMax, -ssid, - y_kmeans)%>%
  # subset(!is.na(alex_median))%>%
  group_by(ssid)%>%
  mutate(value1 = scale(value))%>%
  ggplot(aes(measurement,value1))+
  stat_summary(geom = "pointrange", position = position_dodge(1))+
  facet_grid(~y_kmeans)

```



```{r}
gather(new.data3, key = "measurement", value = "value",
       pup_basCor, Bio_Mean_HR_dif,log1p_BIO_CDA.PhasicMax, -ssid, - y_kmeans, -pca_v1_v2)%>%
  group_by(ssid,measurement)%>%
  mutate(value1 = scale(value))%>%
  ggplot(aes(measurement,SacAmp, color = as.factor(pca_v1_v2)))+
  stat_summary(geom = "pointrange")+
  facet_grid(~y_kmeans)
unique(new.data3$ssid)


# compare them on the scores components
gather(new.data3, key = "measurement", value = "value",
       PC1, PC2, -ssid, - y_kmeans, -pca_v1_v2)%>%
  group_by(ssid,y_kmeans,measurement)%>%
  # mutate(value1 = scale(value))%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  ggplot(aes(as.factor(y_kmeans),value))+
  geom_jitter(width = .1, alpha = .2)+
  stat_summary(geom = "pointrange")+
  geom_boxplot(alpha = .1)+
  facet_grid(~measurement)+
  ggpubr::stat_compare_means()
unique(new.data3$ssid)

gather(new.data3, key = "measurement", value = "value",
       PC1, PC2, -ssid, - y_kmeans, -pca_v1_v2)%>%
  # subset(Group == "NT")%>%
  group_by(ssid,y_kmeans)%>%
  # mutate(value1 = scale(value))%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  
  ggplot(aes(as.factor(y_kmeans),valence))+
  geom_jitter(width = .1, alpha = .2)+
  stat_summary(geom = "pointrange")+
  geom_boxplot(alpha = .1)+
  # facet_grid(~measurement)+
  ggpubr::stat_compare_means()


gather(new.data3, key = "measurement", value = "value",
       PC1, PC2, -ssid, - y_kmeans, -pca_v1_v2)%>%
  # subset(Group == "NT")%>%
  group_by(ssid,y_kmeans)%>%
  # mutate(value1 = scale(value))%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)%>%
  
  ggplot(aes(as.factor(y_kmeans),arousal))+
  geom_jitter(width = .1, alpha = .2)+
  stat_summary(geom = "pointrange")+
  geom_boxplot(alpha = .1)+
  # facet_grid(~measurement)+
  ggpubr::stat_compare_means()


unique(new.data3$PC1)

new.data3 %>%
  # group_by(ssid)%>%
  # mutate()
    group_by(ssid, alex_median, y_kmeans, V1, V2)%>%
    summarise_if(is.numeric, mean, na.rm = TRUE)%>%
    ggplot(aes(as.factor(y_kmeans), Bio_Mean_HR_dif, color = V1))+
  stat_summary(geom = 'pointrange')+
    # geom_jitter(alpha = .1, width = .1)
    facet_grid(alex_median~V2)
  
```

try and aggregate trials so we have less variables than

also remove missing tas



```{r}

unique(db_full6new_hr_fix_stim_select3$Group)
db_full6new_hr_fix_stim_select3

# create categories based on ground valence
db_full6new_hr_fix_stim_select3$ValenceGround_cut<- cut(db_full6new_hr_fix_stim_select3$ValenceMean,3)

# reformat
colnames(db_full6new_hr_fix_stim_select3)

# select only necessary columns

db_full6new_hr_fix_stim_select4.1 <- select(db_full6new_hr_fix_stim_select3,
                                                      c(ssid, Group,TAS, AQ, stimIAPS, stimIAPS2, stimDescription,ValenceGround_cut, pup_basCor, Bio_Mean_HR_dif, log1p_BIO_CDA.PhasicMax, arousal, valence))

# subset out missing stim descrioption and tas
db_full6new_hr_fix_stim_select4.1<- db_full6new_hr_fix_stim_select4.1%>%
  subset(!is.na(stimDescription))%>%
  subset(!is.na(TAS))

unique(db_full6new_hr_fix_stim_select4.1$stimIAPS)

db_full6new_hr_fix_stim_select4.1$stimIAPS2<- substr(db_full6new_hr_fix_stim_select4.1$stimIAPS, 1,4)

factor(db_full6new_hr_fix_stim_select4$stimIAPS2)

# reshape
colnames(db_full6new_hr_fix_stim_select4.1)


db_full6new_hr_fix_stim_select4.1 <- subset(db_full6new_hr_fix_stim_select4.1, !is.na(Group))

colnames(db_full6new_hr_fix_stim_select4.1)

# fill in NA with average per individual
# - not working
# are things being recognised as something otehr than NA, eg NaN
db_full6new_hr_fix_stim_select4.1[db_full6new_hr_fix_stim_select4.1 == "NaN"] <- NA

# seems like it
# no need for this as well be computing averages
db_full6new_hr_fix_stim_select5.1 <- db_full6new_hr_fix_stim_select4.1 %>%
  group_by(ssid)%>%
  mutate(ssid_pup_basCor_mean = mean(pup_basCor, na.rm = TRUE), 
         ssid_Bio_Mean_HR_dif_mean = mean(Bio_Mean_HR_dif, na.rm = TRUE),
         ssid_log1p_BIO_CDA.PhasicMax_mean = mean(log1p_BIO_CDA.PhasicMax, na.rm = TRUE))%>%
  mutate(pup_basCor = if_else(is.na(pup_basCor) == TRUE, ssid_pup_basCor_mean, pup_basCor))%>%
  mutate(Bio_Mean_HR_dif = if_else(is.na(Bio_Mean_HR_dif) == TRUE, ssid_Bio_Mean_HR_dif_mean, Bio_Mean_HR_dif))%>%
  mutate(log1p_BIO_CDA.PhasicMax = if_else(is.na(log1p_BIO_CDA.PhasicMax) == TRUE, ssid_log1p_BIO_CDA.PhasicMax_mean, log1p_BIO_CDA.PhasicMax)) 

# compute averages
db_full6new_hr_fix_stim_select5.1 <- db_full6new_hr_fix_stim_select4.1 %>%
  group_by(ssid,ValenceGround_cut)%>%
  mutate(pup_basCor_avg = mean(pup_basCor, na.rm = TRUE),
         Bio_Mean_HR_dif_avg = mean(Bio_Mean_HR_dif, na.rm = TRUE),
         log1p_BIO_CDA.PhasicMax_avg = mean(log1p_BIO_CDA.PhasicMax, na.rm = TRUE))


nrow(db_full6new_hr_fix_stim_select5.1)

library(data.table)
# ?dcast
db_full6new_hr_fix_stim_select5.2<- select(db_full6new_hr_fix_stim_select5.1, 
                                           c(ssid, TAS,AQ, Group,ValenceGround_cut, stimIAPS2,
                                             pup_basCor_avg,
                                             Bio_Mean_HR_dif_avg,
                                             log1p_BIO_CDA.PhasicMax_avg, arousal, valence))

db_full6new_hr_fix_stim_select5.3 <- db_full6new_hr_fix_stim_select5.2%>%
    group_by(ssid,Group, ValenceGround_cut)%>%
  summarise_if(is.numeric, mean, na.rm = TRUE)
  
# 

db_forBADA2.1 <- data.table::dcast(setDT(db_full6new_hr_fix_stim_select5.3), 
                    ssid +TAS+AQ+ Group ~ ValenceGround_cut, value.var = c('pup_basCor_avg',
                'Bio_Mean_HR_dif_avg', 'log1p_BIO_CDA.PhasicMax_avg', 'arousal', 'valence'),fun.aggregate = mean)



table(is.na(db_forBADA2.1))
View(db_forBADA2.1)
db_forBADA2.2<- na.omit(db_forBADA2.1)



# try to fill means rowwise
colnames(db_forBADA2.2)
db_forBADA2.2_pupil_ssid<- db_forBADA2.2[,1:4]

db_forBADA2.2_pupil<- db_forBADA2.2[,6:19]


# hr
db_forBADA2.2_hr<- db_forBADA2.2[,c(7:9)]
# table(is.na(db_forBADA1_pupil$TAS))

# scr
colnames(db_forBADA2)
db_forBADA2.2_scr<- db_forBADA2.2[,10:12]


# bind
db_badia2.1_nona <- bind_cols(db_forBADA2.2[,1:3], db_forBADA2.2_pupil, db_forBADA2.2_hr, 
                              db_forBADA2.2_scr)


db_badia2.1_nona<- db_forBADA2.2

```






Aggregated data with TAS and asd
```{r}

install.packages("TInPosition")
install.packages("ade4")
install.packages("TExPosition")
install.packages("MExPosition")
install.packages("ExPosition")
install.packages("prettyGraphs")

library(TInPosition)
library(MExPosition)

colnames(db_badia2.1_nona)
var.data_asd_agg<- db_badia2.1_nona[,5:13]

var.design_asd_agg<- as.factor(db_badia2.1_nona$Group)

all.data_asd2.1$tas_mediansplit<- if_else(db_badia2.1_nona$TAS> median(db_badia2.1_nona$TAS, na.rm = TRUE), "High", "Low")
all.data_asd2.1$aq_mediansplit<- if_else(db_badia2.1_nona$AQ> median(db_badia2.1_nona$AQ, na.rm = TRUE), "High", "Low")

var.design_asd_aq_agg<-as.factor(all.data_asd2.1$aq_mediansplit)
var.design_asd_tas_agg<-as.factor(all.data_asd2.1$tas_mediansplit)

# group

colnames(var.data_asd_agg)

var.data_asd_agg_2<- var.data_asd_agg

colnames(var.data_asd_agg_2)<- c("PUP_Neg", "PUP_Neu","PUP_Pos", "HR_Neg", "HR_Neu","HR_Pos",
                                 "SC_Neg", "SCR_Neu","SCR_Pos")
var.PCA.inf_asd2.2 <-InPosition::epPCA.inference.battery(var.data_asd_agg_2, 
                                       scale = TRUE, 
                                       center = TRUE, 
                                       DESIGN = var.design_asd_agg,
                                       make_design_nominal = TRUE, 
                                       graphs = TRUE, k = 0, 
                                       test.iters = 1000, 
                                       constrained = FALSE, critical.value = 2)

InPosition::inGraphs(var.PCA.inf_asd2.2, y_axis = 2)

var.PCA.inf_asd2.2
# aq median split

var.PCA.inf_agg_aq <-InPosition::epPCA.inference.battery(var.data_asd_agg_2, 
                                       scale = TRUE, 
                                       center = TRUE, 
                                       DESIGN = var.design_asd_aq_agg,
                                       make_design_nominal = TRUE, 
                                       graphs = TRUE, k = 0, 
                                       test.iters = 1000, 
                                       constrained = FALSE, critical.value = 2)

InPosition::inGraphs(var.PCA.inf_agg_aq, y_axis = 2)

# tas
var.PCA.inf_agg_tas <-InPosition::epPCA.inference.battery(var.data_asd_agg_2, 
                                       scale = TRUE, 
                                       center = TRUE, 
                                       DESIGN = var.design_asd_tas_agg,
                                       make_design_nominal = TRUE, 
                                       graphs = TRUE, k = 0, 
                                       test.iters = 1000, 
                                       constrained = FALSE, critical.value = 2)

InPosition::inGraphs(var.PCA.inf_agg_tas, y_axis = 2)


```

```{r}
# ?ExPosition::epPCA

var.PCA.inf_asd2.2$Fixed.Data$Plotting.Data$fi.col
# color<- bind_rows(as.data.frame(rep("#305ABF", 56)),as.data.frame(rep("#84BF30", 56)),as.data.frame(rep("#84BF30", 56)))
# 
# rep("#84BF30", 56)
# rep("red", 56)

row.cols <- read.csv("row_cols.csv",header=TRUE)
row.cols <- var.PCA.inf_asd2.2$Fixed.Data$Plotting.Data$fi.col
x_axis <- 1
y_axis <- 2
tau <- var.PCA.inf_asd2.2$Fixed.Data$ExPosition.Data$t # variance
p.val <- var.PCA.inf_asd2.2$Inference.Data$components$p.vals
xlab = paste("Component", x_axis, "Variance:",round(tau[x_axis],digits = 2),"%, ","p =",p.val[x_axis])
ylab = paste("Component", y_axis, "Variance:",round(tau[y_axis],digits = 2),"%, ","p =",p.val[y_axis])
main = "PCA with Inference"


?prettyPlot

write_csv("var.PCA.inf_asd_forpca.csv", var.data_asd)
pca.plot <- prettyGraphs::prettyPlot(var.PCA.inf_asd2.2$Fixed.Data$ExPosition.Data$fi,
                       x_axis=x_axis,
                       y_axis=y_axis,
                       col=row.cols,
                       pch=22,
                       cex=NULL,
                       text.cex=NULL,
                       pos=3,

                       xlab=xlab,
                       ylab=ylab,
                       main=main,
                       display_names=TRUE,
                       display_points=TRUE,
                       constraints=NULL,
                       contributionCircles=TRUE,
                       contributions=var.PCA.inf_asd2.2$Fixed.Data$ExPosition.Data$ci, 
                       axes=TRUE, 
                       fg.line.width=3,
                       fg.type="l", 
                       fg.col="black",
                       bg.line.width=1.5, 
                       bg.lty=3, 
                       bg.col="black",
                       flip=FALSE,asp=1, 
                       findBounds=TRUE,
                       dev.new=TRUE,
                       new.plot=TRUE)
?prettyGraphs::correlationPlotter()


prettyGraphs::correlationPlotter(var.data_asd2.2,
  var.PCA.inf_asd2.2$Fixed.Data$ExPosition.Data$fi,
  col= row.cols,
                       pch=22,
                       # cex=NULL,
                       # text.cex=NULL,
                       # pos=3,

                       xlab=xlab,
                       ylab=ylab,
                       main=main
                       # display_names=TRUE,
                       # display_points=TRUE,
                       # constraints=NULL,
                       # contributionCircles=TRUE,
                       # contributions=var.PCA.inf_asd$Fixed.Data$ExPosition.Data$ci, 
                       # axes=TRUE, 
                       # fg.line.width=3,
                       # fg.type="l", 
                       # fg.col="black",
                       # bg.line.width=1.5, 
                       # bg.lty=3, 
                       # bg.col="black",
                       # flip=FALSE,asp=1, 
                       # findBounds=TRUE,
                       # dev.new=TRUE,
                       # new.plot=TRUE
                                 )



summary(var.PCA.inf_asd2.2)

var.PCA.inf_asd2.2$Inference.Data$components$eigs

plot(var.PCA.inf_asd2.2$Inference.Data$components$eigs)

```

# BADIA  aggregated

```{r}
# group
var.BADA.inf_agg_asd_gr<- TInPosition::tepBADA.inference.battery(var.data_asd_agg, 
                                                       scale = FALSE, 
                                                       center = FALSE, 
                                                       DESIGN = var.design_asd_agg,
                                                       make_design_nominal = TRUE, 
                                                       group.masses = NULL, 
                                                       weights = NULL, 
                                                       graphs = TRUE, 
                                                       k = 0, 
                                                       test.iters = 1000, 
                                                       critical.value = 2)

# aq

var.BADA.inf_agg_asd_aq<- TInPosition::tepBADA.inference.battery(var.data_asd_agg, 
                                                       scale = FALSE, 
                                                       center = TRUE, 
                                                       DESIGN = var.design_asd_aq_agg,
                                                       make_design_nominal = TRUE, 
                                                       group.masses = NULL, 
                                                       weights = NULL, 
                                                       graphs = TRUE, 
                                                       k = 0, 
                                                       test.iters = 1000, 
                                                       critical.value = 2)

# tas


var.BADA.inf_agg_asd_tas<- TInPosition::tepBADA.inference.battery(var.data_asd_agg, 
                                                       scale = FALSE, 
                                                       center = TRUE, 
                                                       DESIGN = var.design_asd_tas_agg,
                                                       make_design_nominal = TRUE, 
                                                       group.masses = NULL, 
                                                       weights = NULL, 
                                                       graphs = TRUE, 
                                                       k = 0, 
                                                       test.iters = 1000, 
                                                       critical.value = 2)





var.BADA.inf_asd2.2$Fixed.Data$TExPosition.Data$ci

var.BADA.inf_asd2.2$Inference.Data$omni$p.val

var.BADA.inf_asd2.2$Fixed.Data$TExPosition.Data
?TInPosition::tepDICA.inference.battery
na.omit(var.data_asd)
na.action(var.data_asd)

write_csv(var.data_asd2.2, "var.data_asd2.2.csv")


# bada still won't work
```

kmean on PCS
# store factor scores
fi	
factor scores for the row items.

di	
square distances of the row items.

ci	
contributions (to the variance) of the row items.

ri	
cosines of the row items.

fj	
factor scores for the column items.

dj	
square distances of the column items.

cj	
contributions (to the variance) of the column items.

rj	
cosines of the column items.

t	
the percent of explained variance per component (tau).

eigs	
the eigenvalues from the decomposition.
```{r}
scorefactor2 <-var.PCA.inf_asd2.2[["Fixed.Data"]][["ExPosition.Data"]][["fi"]][,1:3]

var.PCA.inf_asd2.2$Fixed.Data$ExPosition.Data$cj
cj	
contributions (to the variance) of the column items.
var.PCA.inf_asd2.2
library(ggplot2)
library(tidyverse)


# now bidn this to dataset
# all.data_a

# store pcs on the data

colnames(all.data_asd2.1)
all.data_asd2.2
all.data_asd2.1$PC1 <- scorefactor2[,1]
all.data_asd2.1$PC2 <- scorefactor2[,2]
all.data_asd2.1$PC3 <- scorefactor2[,3]

# now try kmeans on the components
all.data_asd2pcs2.1<- all.data_asd2.1

# var.data_asd_with2pcs

colnames(all.data_asd2pcs2.1)
all.data_asd2pcs2.1_forkmean<- all.data_asd2pcs2.1[,c(1,2,13:15)]
# Feature Scaling
# training_set = scale(training_set)
# test_set = scale(test_set)
colnames(all.data_asd2pcs2.1_forkmean)

# Using the elbow method to find the optimal number of clusters
scaled_all.data_asd2pcs2.1_forkmean <-scale(all.data_asd2pcs2.1_forkmean[,3:4])
set.seed(1)
wcss = vector()
for (i in 1:10) wcss[i] = sum(kmeans(all.data_asd2pcs2.1_forkmean[,3:4], i)$withinss)
plot(1:10,
     wcss,
     type = 'b',
     main = paste('The Elbow Method'),
     xlab = 'Number of clusters',
     ylab = 'WCSS')

#  2 or 3

# Fitting K-Means to the dataset
set.seed(25)

?kmeans
kmeans_res = kmeans(x = all.data_asd2pcs2.1_forkmean[,3:4], centers = 2)
y_kmeans = kmeans_res$cluster
rm(kmeans)

# install.packages("factoextra")

?factoextra::fviz_nbclust
factoextra::fviz_nbclust(all.data_asd2pcs2.1_forkmean[,3:4], 
                         kmeans, 
                         method='silhouette')


# Visualising the clusters
# install.packages("cluster")
library(cluster)


scaled_all.data_asd2pcs2.1_forkmean <- as.data.frame(scale(all.data_asd2pcs2.1_forkmean[,3:4])[,1:2])
all.data_asd2pcs2.1_forkmean
  colnames(all.data_asd2pcs2.1_forkmean)
scaled_all.data_asd2pcs2.1_forkmean
?cluster::clusplot


range(scaled_all.data_asd2pcs2.1_forkmean)
range(all.data_asd2pcs2.1_forkmean$PC1)
cluster::clusplot(all.data_asd2pcs2.1_forkmean[,3:4],
         y_kmeans,
         lines = 2,
         shade = TRUE,
         color = TRUE,
         labels = 1,
         plotchar = FALSE,
         span = TRUE
         # label = 
         # main = paste('Clusters of customers'),
         # xlab = 'Annual Income',
         # ylab = 'Spending Score'
         )


```


```{r}

# 
ssid_tasaq<- db_full6new_hr_fix_stim_select3%>%
  group_by(ssid, Group)%>%
  summarise_at(c('TAS', 'AQ'), mean, na.rm = TRUE)
# ssid_tas_aq<- select(db_full6new_hr_fix_stim_select3, c(ssid, TAS))

scaled_all.data_asd2pcs2.1_forkmean
as.factor(all.data_asd2pcs_forkmean2$ssid)
scaled_all.data_asd2pcs2.1_forkmean$ssid<- all.data_asd2pcs2.1$ssid

scaled_all.data_asd2pcs2.1_forkmean$TAS<- all.data_asd2pcs2.1$TAS

# left_join(scaled_all.data_asd2pcs_forkmean ,ssid_tasaq)%>%

all.data_asd2pcs2.1_forkmean$y_kmeans<- y_kmeans
all.data_asd2pcs2.1_forkmean%>%
  ggplot(aes(as.factor(y_kmeans), TAS))+
  stat_summary(geom = "pointrange")+
  geom_text(aes(label = ssid), alpha = .1)

cor.test(all.data_asd2pcs2.1_forkmean$PC1, all.data_asd2pcs2.1_forkmean$TAS)
cor.test(all.data_asd2pcs2.1_forkmean$PC2, all.data_asd2pcs2.1_forkmean$TAS)
cor.test(all.data_asd2pcs2.1_forkmean$PC3 , all.data_asd2pcs2.1_forkmean$TAS)




# scaled_all.data_asd2pcs_forkmean$PC3<- all.data_asd2pcs_forkmean$PC3

scaled_all.data_asd2pcs_forkmean2<- left_join(scaled_all.data_asd2pcs_forkmean ,ssid_tasaq)


all.data_asd2pcs2.1_forkmean$alex_median<- if_else(all.data_asd2pcs2.1_forkmean$TAS> median(all.data_asd2pcs2.1_forkmean$TAS, na.rm = TRUE), "High", "Low")

table(all.data_asd2pcs2.1_forkmean$alex_median, all.data_asd2pcs2.1_forkmean$y_kmeans)


table(scaled_all.data_asd2pcs2.1_forkmean$alex_median, 
      
      scaled_all.data_asd2pcs2.1_forkmean$y_kmeans)


all.data_asd2pcs2.1_forkmean%>%
  ggplot(aes(as.factor(y_kmeans), TAS))+
  stat_summary(geom = "pointrange")+
  geom_text(aes(label = ssid), alpha = .1)+
  facet_grid(~alex_median)


  
  # flag just the sigmificant variables
  # subset to keep the varioables that came sgnificant ut of the infernce PCA for either of the first 2 or 3 dimmensions
  signiftestpca_df<- as.data.frame(signiftestpca)
  signiftestpca1_2<- signiftestpca_df%>%
                            any(~(V1, V2) == TRUE)
  
  unique(signiftestpca1_2$V1)
  unique(signiftestpca1_2$V2)  
  
  new.data <- signiftestpca_df[ which( signiftestpca_df$V1 == TRUE | signiftestpca_df$V2 == TRUE) , ]
  
  
  unique(new.data$V1)
  unique(new.data$V2)
  
  View(new.data)
  
  new.data
  new.data$pca_v1_v2<- paste0(new.data$V1, paste0(new.data$V2))
  unique( new.data$pca_v1_v2)
  new.data1<- select(new.data, c(V1, V2, V3, pca_v1_v2))
  
  # store row name into a variable
  new.data1$variable<- rownames(new.data1)
  
  
  # extract pattern after the last underscore
     new.data1$stimIAPS2<- sub('.*\\_', '', new.data1$variable)
  new.data1$stimIAPS2
  
    new.data1$InPCA<- "YES"
    
    scaled_all.data_asd2pcs_forkmean2
    
    new.data1
     unique( new.data1$pca_v1_v2)


# merge this back with the full data
        db_full6new_hr_fix_stim_select5
        
        unique(scaled_all.data_asd2pcs_forkmean2$ssid)
  kmean_pca_longdata  <- left_join(scaled_all.data_asd2pcs_forkmean2, db_full6new_hr_fix_stim_select3, 
                                   by = c("ssid", "Group"))
  
  kmean_pca_longdata
  
 # new.data2 <- new.data1%>%
 #    arrange(stimIAPS2)%>%
 #    subset(!duplicated(stimIAPS2))
 
 new.data2<- new.data1
 
 unique( new.data2$pca_v1_v2)
 
 unique(new.data2)
 unique(kmean_pca_longdata$ssid)
 
 kmean_pca_longdata
new.data3<- left_join( new.data2,kmean_pca_longdata)
  # left_join( new.data2,kmean_pca_longdata) %>%

unique(new.data3$pca_v1_v2)


V3

all.data_asd2pcs_forkmean
new.data3$PC3<- all.data_asd2pcs_forkmean$PC3


# this is however takling all the data not only the data PCA deemed to be imorttant

new.data3$pca_v1_v2

unique(new.data3$stimIAPS2)
unique(new.data3$pca_v1_v2)
new.data3 %>%
  # subset(Group == "NT")%>%
  subset(ssid!=336)%>%
    group_by(ssid, Group)%>%
    summarise_if(is.numeric, mean, na.rm = TRUE)%>%
    ggplot(aes( AQ.y, PC3))+
  geom_point()+
  geom_smooth(method = 'lm', se = F)+
  geom_text(aes(label = ssid))+
  ggpubr::stat_cor(method = 'spearman')+
    stat_ellipse()
  # stat_summary(geom = 'pointrange')+
      geom_jitter(alpha = .1, width = .1)+
  
        
        
      # facet_grid(~Group)+
  ggpubr::stat_compare_means()
      
      new.data3$Alex_median<- if_else(new.data3$TAS.x> median(new.data3$TAS.x, na.rm = TRUE), "High", "Low")
      
      new.data3 %>%
      
        subset(ssid!=336)%>%
        subset(!is.na(TAS.x))%>%
    group_by(ssid, Alex_median)%>%
    summarise_if(is.numeric, mean, na.rm = TRUE)%>%
    ggplot(aes( Alex_median, PC3))+
          stat_summary(geom = "pointrange")+
  # geom_point()+
  geom_smooth(method = 'lm', se = F)+
  geom_text(aes(label = ssid))+
        ylim(-1.6, 2.5)+
  ggpubr::stat_compare_means()
    # stat_ellipse()
  # stat_summary(geom = 'pointrange')+
      geom_jitter(alpha = .1, width = .1)+
  


```




# score_test


?correlationPlotter
library(prettyGraphs)

var.PCA.inf_asd$Fixed.Data



# let's try tinpositioinsta

install.packages('InPosition')

?epPCA.inference.battery

# var.PCA.inf <- InPosition::epPCA.inference.battery(var.data1, scale = TRUE, center = TRUE, DESIGN = var.design, make_design_nominal = TRUE, graphs = TRUE, k = 0, test.iters = 100, constrained = FALSE, critical.value = 2)


row.cols<- var.data_asd
  
  var.PCA.inf_asd$Fixed.Data$Plotting.Data$fi.col
## Look at other dimensions
row.cols <- read.csv("row_cols.csv",header=TRUE)


# row.cols <- var.data[,2]

# row.cols<- all.data_highlow[,3]

x_axis <- 1
y_axis <- 2

var.PCA.inf$ExPosition.Data

tau <- var.PCA.inf_asd$Fixed.Data$ExPosition.Data$t
p.val <- var.PCA.inf_asd$Inference.Data$components$p.vals
xlab = paste("Component", x_axis, "Variance:",round(tau[x_axis],digits = 2),"%, ","p =",p.val[x_axis])
ylab = paste("Component", y_axis, "Variance:",round(tau[y_axis],digits = 2),"%, ","p =",p.val[y_axis])
main = "PCA with Inference"

pca.plot <- prettyPlot(var.PCA.inf_asd$Fixed.Data$ExPosition.Data$fi,
x_axis=x_axis,
y_axis=y_axis,
col= var.PCA.inf_asd$Fixed.Data$Plotting.Data$fi.col,
pch=22,
cex=NULL,
text.cex=NULL,
pos=3,
xlab=xlab,ylab=ylab,main=main,display_names=FALSE,display_points=TRUE,
constraints=NULL,contributionCircles=TRUE,contributions=var.PCA.inf$Fixed.Data$ExPosition.Data$ci, axes=TRUE, fg.line.width=3,fg.type="l", fg.col="black",
bg.line.width=1.5, bg.lty=3, bg.col="black",flip=FALSE,asp=1, findBounds=TRUE,dev.new=TRUE,new.plot=TRUE)

var.PCA.inf_asd$Inference.Data$components$
```

## Barycentric Discriminant Analysis (BaDa)
```{r}
# var.data <- all.data_highlow[,c(4:171)]

TInPosition::tepBADA.inference.battery()
# 
# table(is.na(var.data))
# na.omit(var.data)
# 
#  var.data$log1p_BIO_CDA.PhasicMax_9926
# 
#  
#  var.data %>%
#     select_if(~ any(is.infinite(.)))
#  
#  var.data1<- na.omit(var.data)
 
 
var.design<- as.factor(all.data_highlow$alex_quartil)


resBADA <- TExPosition::tepBADA(var.data, DESIGN = var.design, scale = TRUE,
                   graphs = FALSE)

colnames(var.data)

?TInPosition::tepBADA.inference.battery

?TExPosition::tepBADA

```

```{r}
test <- TExPosition::tepBADA(var.data_asd, 
                                                       scale = FALSE, 
                                                       center = FALSE, 
                                                       DESIGN = var.design_asd, 
                                                       make_design_nominal = TRUE, 
                                                       group.masses = NULL, 
                                                       # weights = NULL, 
                                                       graphs = TRUE, 
                                                       k = 0
                                                       # test.iters = 100, 
                                                       # critical.value = 2
                     )

```


test$Plotting.Data

TExPosition::tepDICA()
?TInPosition::print.tepDICA.inference.battery()
var.BADA.inf_asd <- TInPosition::tepBADA.inference.battery(var.data_asd, 
                                                       scale = TRUE, 
                                                       center = TRUE, 
                                                       DESIGN = all.data_asd$Group, 
                                                       make_design_nominal = TRUE, 
                                                       group.masses = NULL, 
                                                       weights = NULL, 
                                                       graphs = TRUE, 
                                                       k = 0, 
                                                       test.iters = 100, 
                                                       critical.value = 2)


?TInPosition::tepDICA.inference.battery
na.omit(var.data_asd)
na.action(var.data_asd)
```
