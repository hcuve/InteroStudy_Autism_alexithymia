---
title: "Mixed models - alex vs autism on physiology, subjective and their relationship"
output: html_document
date: "2025-12-04"
---

Mixed models

Some pre-processing <!-- - we need to cut data and impute data -->

first get some understanding of how much data is missing per ppt per signal
606 missing all HR

```{r}

require(tidyverse)


table(dta_4_lmms$ssid)
table(is.na(dta_4_lmms$arousal))
dta_4_lmms%>%
  subset(is.na(arousal))

cor.test(dta_4_lmms$arousal_0_1, dta_4_lmms$arousal)
cor.test(dta_4_lmms$valence_0_1, dta_4_lmms$valence)

unique(dta_4_lmms$ssid)

dta_4_lmms
colnames(dta_4_lmms_sel_1)

dta_4_lmms_sel<- dta_4_lmms[, c(1:8,11:23)]
colnames(dta_4_lmms_sel)

# first code how mnay trials are there out of 50
length(unique(dta_4_lmms_sel$ssid)) #87

# compute proportion of valid data
dta_4_lmms_sel<- dta_4_lmms_sel%>%
  group_by(ssid)%>%
  mutate(prop_trials_o50 = n()/50)%>%
  mutate(scr_na = sum(is.na(bio_cda_phasicmax))/50,
         hr_na = sum(is.na(bio_cda_phasicmax))/50,
         pup_na = sum(is.na(pup_bascor))/50,
         arousal_na = sum(is.na(arousal_0_1)/50))%>%
           mutate(na_prop_avg = (scr_na+hr_na+pup_na+arousal_na)/4)%>%
           
  ungroup()

# quick checks

dta_4_lmms_sel%>%
  group_by(ssid)%>%
  summarise_if(is.numeric, mean, na.rm = T)%>%
  ggplot(aes(x = prop_trials_o50))+
  geom_histogram()+
   geom_vline(xintercept = .8, linetype = "dashed")


dta_4_lmms_sel%>%
  group_by(ssid)%>%
  summarise_if(is.numeric, mean, na.rm = T)%>%
  ggplot(aes(x = na_prop_avg))+
  geom_histogram()+
  geom_vline(xintercept = .05, linetype = "dashed")

dta_4_lmms_sel%>%
  group_by(ssid)%>%
  summarise_if(is.numeric, mean, na.rm = T)%>%
  ggplot(aes(x = pup_na))+
  geom_histogram()+
  geom_vline(xintercept = .2, linetype = "dashed")


dta_4_lmms_sel%>%
  group_by(ssid)%>%
  summarise_if(is.numeric, mean, na.rm = T)%>%
  ggplot(aes(x = hr_na))+
  geom_histogram()+
  geom_vline(xintercept = .2, linetype = "dashed")

dta_4_lmms_sel%>%
  group_by(ssid)%>%
  summarise_if(is.numeric, mean, na.rm = T)%>%
  ggplot(aes(x = scr_na))+
  geom_histogram()+
  geom_vline(xintercept = .2, linetype = "dashed")




dta_4_lmms_sel %>%
  filter(na_prop_avg > .2) %>%
  distinct(ssid)
# ssid
# <chr>
# 371


dta_4_lmms_sel %>%
  filter(prop_trials_o50 < .60) %>%
  distinct(ssid)

# 328

dta_4_lmms_sel_1<- dta_4_lmms_sel%>%
# participant exclusion%>%
  subset(ssid!= 371)%>%
  subset(ssid!= 328)

colnames(dta_4_lmms_sel_1)

dta_4_lmms_sel_1%>%
  group_by(ssid)%>%
  summarise_if(is.numeric, mean, na.rm = T)%>%
  ggplot(aes(x = na_prop_avg))+
  geom_histogram()+
  geom_vline(xintercept = .2, linetype = "dashed")


dta_4_lmms_sel_1%>%
  group_by(ssid)%>%
  summarise_if(is.numeric, mean, na.rm = T)%>%
  ggplot(aes(x = prop_trials_o50))+
  geom_histogram()+
  geom_vline(xintercept = .8, linetype = "dashed")

dta_4_lmms_sel_1

#trial exclusions
dta_4_lmms_sel_1<- dta_4_lmms_sel_1%>%
  group_by(ssid)%>%
  mutate(bio_cda_phasicmax_log = log1p(bio_cda_phasicmax+.01),
         bio_cda_iscr_log = log1p(bio_cda_iscr+.01),
         bio_cda_scr_log = log1p(bio_cda_scr+.01))%>%

  mutate(
 pup_bascor_z_sid = scale(pup_bascor)[, 1],
  pup_bascor_z_sid_pot_outl = abs(pup_bascor_z_sid) >= 3,
         bio_mean_hr_dif_z_sid = scale(bio_mean_hr_dif)[, 1],
         hr_z_sid_pot_outl = abs(bio_mean_hr_dif_z_sid) >= 4,
         bio_cda_phasicmax_log_z_sid = scale(bio_cda_phasicmax_log)[, 1],
         bio_cda_phasicmax_log_z_sid_pot_outl = abs(bio_cda_phasicmax_log_z_sid) >= 4,
  bio_cda_iscr_log_z_sid = scale(bio_cda_iscr_log)[, 1],
         bio_cda_iscr_log_z_sid_pot_outl = abs(bio_cda_iscr_log_z_sid) >= 4,
 
   bio_cda_scr_log_z_sid = scale(bio_cda_scr_log)[, 1],
        bio_cda_scr_log_z_sid_pot_outl = abs(bio_cda_scr_log_z_sid) >= 5,
 
         )%>%
  select(-bio_mean_hr_dif_z_sid,-pup_bascor_z_sid,,-bio_cda_phasicmax_log_z_sid,-bio_cda_iscr_log_z_sid,-bio_cda_scr_log_z_sid, -bio_cda_phasicmax_log,-bio_cda_iscr_log,-bio_cda_scr_log)%>%
#TRUE is exclusion
  ungroup()

table(dta_4_lmms_sel_1$pup_bascor_z_sid_pot_outl)
table(dta_4_lmms_sel_1$hr_z_sid_pot_outl)
table(dta_4_lmms_sel_1$scr_z_sid_pot_outl)
# FALSE  TRUE 
#  4145     9 
# 
# FALSE  TRUE 
#  4124    34 
# 
# FALSE  TRUE 
#  4182    34 

# remove outliers

dta_4_lmms_sel_1<- dta_4_lmms_sel_1%>%
 # replace outliers with NA
  mutate(
    pup_bascor_no_outl              = ifelse(pup_bascor_z_sid_pot_outl, NA, pup_bascor),
    bio_mean_hr_dif_no_outl         = ifelse(hr_z_sid_pot_outl, NA, bio_mean_hr_dif),
    bio_cda_phasicmax_no_outl   = ifelse(bio_cda_phasicmax_log_z_sid_pot_outl, NA, bio_cda_phasicmax),
     bio_cda_iscr_no_outl   = ifelse(bio_cda_iscr_log_z_sid_pot_outl, NA, bio_cda_iscr),
     bio_cda_scr_no_outl   = ifelse(bio_cda_scr_log_z_sid_pot_outl, NA, bio_cda_scr))

dta_4_lmms_sel_1

colnames(dta_4_lmms_sel_1)
dta_4_lmms_sel_1%>%
  group_by(ssid)%>%
  mutate(na_count = sum(is.na(bio_cda_scr_no_outl)))%>%
  summarise_if(is.numeric, mean, na.rm = T)%>%
  select(ssid, na_count)


dta_4_lmms_sel_1%>%
  group_by(ssid)%>%
  mutate(na_count = sum(is.na(bio_mean_hr_dif_no_outl)))%>%
  summarise_if(is.numeric, mean, na.rm = T)%>%
  select(ssid, na_count)


dta_4_lmms_sel_1%>%
  group_by(ssid)%>%
  mutate(na_count = sum(is.na(pup_bascor_no_outl)))%>%
  summarise_if(is.numeric, mean, na.rm = T)%>%
  select(ssid, na_count)
  
```

for now keep these in just fill in the dataset

```{r}

dta_4_lmms_sel_1<- dta_4_lmms_sel_1%>%subset(ssid!= 606)
unique(dta_4_lmms_sel_1$ssid)

dta_4_lmms_sel_1$ssid<- factor(dta_4_lmms_sel_1$ssid)
colnames(dta_4_lmms_sel_1[,c(1,3:5,9:10,30:34)])
 # [1] "age"                       "tas"                       "aq"                        "arousal"                  
 # [5] "valence"                   "pup_bascor_no_outl"        "bio_mean_hr_dif_no_outl"   "bio_cda_phasicmax_no_outl"
 # [9] "bio_cda_iscr_no_outl"      "bio_cda_scr_no_outl"

chk_missing <- as.matrix(sapply(dta_4_lmms_sel_1[,c(3:5,9:10,34:37)], function(x) sum(is.na(x))))
chk_missing
# Show in New Window
# age                        247
# tas                        247
# aq                         296
# arousalmean                  0
# valencemean                  0
# bio_mean_hr_dif_no_outl     13
# bio_cda_phasicmax_no_outl   34
# bio_cda_iscr_no_outl        31
# bio_cda_scr_no_outl         28

# mputation



# install.packages("missMDA")
library(missMDA)

?missMDA::imputeMultilevel()

# get an estimate for the ncp value



dta_4_lmms_sel_1$ssid<- factor(dta_4_lmms_sel_1$ssid)
colnames(dta_4_lmms_sel_1)


colnames(dta_4_lmms_sel_1[,c(1,3:5,20:21,34:37)])


dta_4_lmms_sel_1_impute<- imputeMultilevel(dta_4_lmms_sel_1[,c(1,3:5,20:21,33:37)], ifac=1, ncpB=2, ncpW=2)

dta_4_lmms_sel_1_impute$completeObs%>%
  group_by(ssid)%>%
  summarise_if(is.numeric, mean, na.rm = T)%>%
  ggplot(aes(tas,aq))+
  geom_point()+
  geom_smooth(method = "lm")+
  ggpubr::stat_cor()


dta_4_lmms_sel_1[,c(1,3:5,20:21,34:37)]%>%
  group_by(ssid)%>%
  summarise_if(is.numeric, mean, na.rm = T)%>%
  ggplot(aes(tas,aq))+
  geom_point()+
  geom_smooth(method = "lm")+
  ggpubr::stat_cor()


# install.packages("GGally")
dta_4_lmms_sel_1[,c(1,3:5,20:21,34:37)] %>%
  group_by(ssid) %>%
   summarise_if(is.numeric, mean, na.rm = T)%>%
  ungroup()%>%
  select(-ssid)%>%
GGally::ggpairs(.)

table(is.na(dta_4_lmms_sel_1$age))
table(is.na(dta_4_lmms_sel_1_impute$completeObs))


cor.test(dta_4_lmms_sel_1_impute$completeObs$valence_0_1,dta_4_lmms_sel_1$valence_0_1)

colnames(dta_4_lmms_sel_1_impute$completeObs)

dta_4_lmms_sel_1_impute_only<- dta_4_lmms_sel_1_impute$completeObs[,c(2:4,7:11)]

names(dta_4_lmms_sel_1_impute_only)<- paste0(colnames(dta_4_lmms_sel_1_impute_only),"_imptd")


dta_4_lmms_sel_1_w_impt<-bind_cols(dta_4_lmms_sel_1,dta_4_lmms_sel_1_impute_only)

dta_4_lmms_sel_1_w_impt
unique(dta_4_lmms_sel_1_w_impt$ssid)

```

mixed models

```{r}
dta_4_lmms_sel_1_w_impt
require(lmerTest)

options(contrasts = c("contr.sum", "contr.poly"))
# Type III F-tests for fixed effects


```

Models on each signal

```{r}
mod_lmer<- list()
unique(dta_4_lmms_sel_1_w_impt$ssid)

dta_4_lmms_sel_1_w_impt%>%
  subset(ssid == 324)

dta_4_lmms_sel_1_w_impt$tas_imptd_z<- scale(dta_4_lmms_sel_1_w_impt$tas_imptd)[,1]
dta_4_lmms_sel_1_w_impt$aq_imptd_z<- scale(dta_4_lmms_sel_1_w_impt$aq_imptd)[,1]
dta_4_lmms_sel_1_w_impt$ssid<- factor(dta_4_lmms_sel_1_w_impt$ssid)
dta_4_lmms_sel_1_w_impt$stimiaps2<- factor(dta_4_lmms_sel_1_w_impt$stimiaps2)


mod_lmer$arousal_0 <- lmer(arousal_0_1 ~ 1+ (1 | stimiaps2)  + (1 | ssid), REML = FALSE,
                      data = dta_4_lmms_sel_1_w_impt)

mod_lmer$arousal_1 <- lmer(arousal_0_1 ~ tas_imptd_z + (1 | stimiaps2)  + (1 | ssid), REML = FALSE,
                      data = dta_4_lmms_sel_1_w_impt)


car::Anova(mod_lmer$arousal_1, type = 3)
anova(mod_lmer$arousal_1, type = 3)
summary(mod_lmer$arousal_1)

# nothing - as expected
mod_lmer$arousal_2 <- lmer(arousal_0_1 ~ aq_imptd_z + (1 | stimiaps2)  + (1 | ssid), REML = FALSE,
                      data = dta_4_lmms_sel_1_w_impt)


car::Anova(mod_lmer$arousal_2, type = 3)
anova(mod_lmer$arousal_2, type = 3)
summary(mod_lmer$arousal_2)
# nothing - as expected

# valence
mod_lmer$val_0 <- lmer(valence_0_1 ~ 1 + (1 | stimiaps2)  + (1 | ssid), REML = FALSE,
                      data = dta_4_lmms_sel_1_w_impt)
mod_lmer$val_1 <- lmer(valence_0_1 ~ tas_imptd_z + (1 | stimiaps2)  + (1 | ssid), REML = FALSE,
                      data = dta_4_lmms_sel_1_w_impt)


car::Anova(mod_lmer$val_1, type = 3)
anova(mod_lmer$val_1, type = 3)
summary(mod_lmer$val_1)

# nothing - as expected
mod_lmer$val_2 <- lmer(valence_0_1 ~ aq_imptd_z + (1 | stimiaps2)  + (1 | ssid), REML = FALSE,
                      data = dta_4_lmms_sel_1_w_impt)


car::Anova(mod_lmer$val_2, type = 3)
anova(mod_lmer$val_2, type = 3)
summary(mod_lmer$val_2)
# nothing - as expected


```

now physiology models lets use ISCR

```         
It captures total phasic activity over time, not just peaks.
•   It is less sensitive to noise than counting SCRs or picking a single amplitude.
•   It reflects both strength and duration of the response.
•   It’s widely used as the primary summary metric in CDA-based analyses.

Alternatives (and why they’re less ideal as a single metric)
•   CDA.SCR (average phasic driver) – also very good, but ISCR is easier to interpret as “total response”.
•   CDA.AmpSum – depends on defining discrete SCRs, which CDA is designed to avoid.
•   CDA.PhasicMax – focuses on the highest moment only; loses information.
•   CDA.nSCR – too dependent on thresholding; not ideal for continuous models.
•   CDA.Tonic – not a measure of phasic SCR at all.

note models are called cda phas max ut its ISCR
```

```{r}
dta_4_lmms_sel_1_w_impt$bio_cda_iscr_no_outl_imptd
dta_4_lmms_sel_1_w_impt$bio_cda_phasicmax

table(is.na((dta_4_lmms_sel_1_w_impt$bio_cda_iscr_no_outl_imptd+.1)))
table(is.na(log(dta_4_lmms_sel_1_w_impt$bio_cda_phasicmax+1.1)))

# dta_4_lmms_sel_1_w_impt$arousal_0_1_z<- scale(dta_4_lmms_sel_1_w_impt$arousal_0_1)[,1]


dta_4_lmms_sel_1_w_impt$bio_cda_iscr_no_outl_imptd_log1p<-log1p(dta_4_lmms_sel_1_w_impt$bio_cda_iscr_no_outl_imptd+.109)

```



```{r}
dta_4_lmms_sel_1_w_impt$tas_imptd_z
dta_4_lmms_sel_1_w_impt$arous

dta_4_lmms_sel_1_w_impt_scr<-
dta_4_lmms_sel_1_w_impt%>%
  ungroup() %>%
  subset(!is.na(bio_cda_iscr_no_outl_imptd_log1p))%>%
  mutate(tas_imptd_z = scale(tas_imptd)[,1],
         aq_imptd_z = scale(aq_imptd)[,1],
  arousal_0_1_z = scale(arousal_0_1)[,1])



```


```{r}
mod_lmer$cda_phasmax_0 <- lmer(bio_cda_iscr_no_outl_imptd_log1p ~ 1+ (1 | stimiaps2)  + 
                                 (1 | ssid), REML = FALSE,
                      data = dta_4_lmms_sel_1_w_impt_scr)

# mod_lmer$cda_phasmax_0 
car::Anova(mod_lmer$cda_phasmax_0 , type = 3)
anova(mod_lmer$cda_phasmax_0 , type = 3)
summary(mod_lmer$cda_phasmax_0 )
```
Analysis of Deviance Table (Type III Wald chisquare tests)

Response: bio_cda_iscr_no_outl_imptd_log1p
             Chisq Df            Pr(>Chisq)    
(Intercept) 129.34  1 < 0.00000000000000022 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
```{r}

mod_lmer$cda_phasmax_0_ar <- lmer(bio_cda_iscr_no_outl_imptd_log1p ~ 1+arousal_0_1_z+ (1 | stimiaps2)  + 
                                 (1 | ssid), REML = FALSE,
                      data = dta_4_lmms_sel_1_w_impt_scr)


car::Anova(mod_lmer$cda_phasmax_0_ar , type = 3)
# anova(mod_lmer$cda_phasmax_0_ar , type = 3)
# summary(mod_lmer$cda_phasmax_0_ar )

```
nalysis of Deviance Table (Type III Wald chisquare tests)

Response: bio_cda_iscr_no_outl_imptd_log1p
                 Chisq Df           Pr(>Chisq)    
(Intercept)   129.6026  1 < 0.0000000000000002 ***
arousal_0_1_z   5.0666  1              0.02439 *  
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

```{r}

# now test direct effects

mod_lmer$cda_phasmax_1 <- lmer(bio_cda_iscr_no_outl_imptd_log1p ~ 1+tas_imptd_z*arousal_0_1_z+ (1 | stimiaps2)  + 
                                 (1 | ssid), REML = FALSE,
                      data = dta_4_lmms_sel_1_w_impt_scr)

car::Anova(mod_lmer$cda_phasmax_1 , type = 3)
anova(mod_lmer$cda_phasmax_1 , type = 3)
summary(mod_lmer$cda_phasmax_1 )

#alexithymia effects
#and arousal effects
# 
```
Type III Analysis of Variance Table with Satterthwaite's method
                          Sum Sq Mean Sq NumDF  DenDF F value   Pr(>F)   
tas_imptd_z               3.0397  3.0397     1   84.0 10.8299 0.001461 **
arousal_0_1_z             1.3885  1.3885     1  308.7  4.9469 0.026861 * 
tas_imptd_z:arousal_0_1_z 0.2990  0.2990     1 4150.5  1.0653 0.302071   
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

```{r}
mod_lmer$cda_phasmax_2 <- lmer(bio_cda_iscr_no_outl_imptd_log1p ~ 1+aq_imptd_z*arousal_0_1_z+ (1 | stimiaps2)  + 
                                 (1 | ssid), REML = FALSE,
                      data = dta_4_lmms_sel_1_w_impt_scr)

car::Anova(mod_lmer$cda_phasmax_2 , type = 3)
anova(mod_lmer$cda_phasmax_2 , type = 3)
summary(mod_lmer$cda_phasmax_2 )
# borderline significant model for autism
```


Analysis of Deviance Table (Type III Wald chisquare tests)

Response: bio_cda_iscr_no_outl_imptd_log1p
                            Chisq Df           Pr(>Chisq)    
(Intercept)              136.5281  1 < 0.0000000000000002 ***
aq_imptd_z                 4.5555  1              0.03281 *  
arousal_0_1_z              5.1100  1              0.02379 *  
aq_imptd_z:arousal_0_1_z   0.0424  1              0.83686    
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
```{r}
anova(mod_lmer$cda_phasmax_0,mod_lmer$cda_phasmax_0_ar, mod_lmer$cda_phasmax_1, mod_lmer$cda_phasmax_2)
# alex model is best except for BIC

```
Data: dta_4_lmms_sel_1_w_impt_scr
Models:
mod_lmer$cda_phasmax_0: bio_cda_iscr_no_outl_imptd_log1p ~ 1 + (1 | stimiaps2) + (1 | ssid)
mod_lmer$cda_phasmax_0_ar: bio_cda_iscr_no_outl_imptd_log1p ~ 1 + arousal_0_1_z + (1 | stimiaps2) + (1 | ssid)
mod_lmer$cda_phasmax_1: bio_cda_iscr_no_outl_imptd_log1p ~ 1 + tas_imptd_z * arousal_0_1_z + (1 | stimiaps2) + (1 | ssid)
mod_lmer$cda_phasmax_2: bio_cda_iscr_no_outl_imptd_log1p ~ 1 + aq_imptd_z * arousal_0_1_z + (1 | stimiaps2) + (1 | ssid)
                          npar    AIC    BIC  logLik -2*log(L)  Chisq Df Pr(>Chisq)   
mod_lmer$cda_phasmax_0       4 6849.9 6875.3 -3421.0    6841.9                        
mod_lmer$cda_phasmax_0_ar    5 6847.3 6879.0 -3418.7    6837.3  4.598  1   0.032010 * 
mod_lmer$cda_phasmax_1       7 6840.1 6884.5 -3413.1    6826.1 11.187  2   0.003722 **
mod_lmer$cda_phasmax_2       7 6846.9 6891.2 -3416.4    6832.9  0.000 

```{r}
# tas centred by group
dta_4_lmms_sel_1_w_impt$nt_asd<- if_else(dta_4_lmms_sel_1_w_impt$asd_sid == "ASD", "ASD", "NON ASD")
dta_4_lmms_sel_1_w_impt_scr$nt_asd<- if_else(dta_4_lmms_sel_1_w_impt_scr$asd_sid == "ASD", "ASD", "NON ASD")

dta_4_lmms_sel_1_w_impt_scr
  # now new z score
dta_4_lmms_sel_1_w_impt_scr<-  dta_4_lmms_sel_1_w_impt_scr%>%
    group_by(nt_asd)%>%
    mutate(tas_imptd_z_asid = scale(tas_imptd)[,1],
           aq_imptd_z_asid = scale(aq_imptd)[,1]
           
           )%>%
  ungroup()
```

```{r}

mod_lmer$cda_phasmax_3 <- lmer(bio_cda_iscr_no_outl_imptd_log1p~ 1+tas_imptd_z_asid*arousal_0_1_z+ (1 | stimiaps2)  + 
                                 (1 | ssid), REML = FALSE,
                      data = dta_4_lmms_sel_1_w_impt_scr)

car::Anova(mod_lmer$cda_phasmax_3 , type = 3)
anova(mod_lmer$cda_phasmax_3 , type = 3)
summary(mod_lmer$cda_phasmax_3 )

#alexithymia effects hold
#and arousal effects hoold
# 


mod_lmer$cda_scr_1 <- lmer(bio_cda_scr_no_outl_imptd ~ 1+tas_imptd_z*arousal_0_1_z+ (1 | stimiaps2)  + 
                                 (1 | ssid), REML = FALSE,
                      data = dta_4_lmms_sel_1_w_impt_scr)

# singular
```

```{r}
mod_lmer$cda_phasmax_4 <- lmer(bio_cda_iscr_no_outl_imptd_log1p ~ 1+aq_imptd_z_asid*arousal_0_1_z+ (1 | stimiaps2)  + 
                                 (1 | ssid), REML = FALSE,
                      data = dta_4_lmms_sel_1_w_impt_scr)

car::Anova(mod_lmer$cda_phasmax_4 , type = 3)
anova(mod_lmer$cda_phasmax_4 , type = 3)
summary(mod_lmer$cda_phasmax_4 )
# effects hold

```
4352.8    4397.2   -2169.4    4338.8      4209 
```{r}
anova(mod_lmer$cda_phasmax_0,mod_lmer$cda_phasmax_0_ar, mod_lmer$cda_phasmax_1, mod_lmer$cda_phasmax_2,mod_lmer$cda_phasmax_3,mod_lmer$cda_phasmax_4)
# alex model is the best model
```
Data: dta_4_lmms_sel_1_w_impt_scr
Models:
mod_lmer$cda_phasmax_0: bio_cda_iscr_no_outl_imptd_log1p ~ 1 + (1 | stimiaps2) + (1 | ssid)
mod_lmer$cda_phasmax_0_ar: bio_cda_iscr_no_outl_imptd_log1p ~ 1 + arousal_0_1_z + (1 | stimiaps2) + (1 | ssid)
mod_lmer$cda_phasmax_1: bio_cda_iscr_no_outl_imptd_log1p ~ 1 + tas_imptd_z * arousal_0_1_z + (1 | stimiaps2) + (1 | ssid)
mod_lmer$cda_phasmax_2: bio_cda_iscr_no_outl_imptd_log1p ~ 1 + aq_imptd_z * arousal_0_1_z + (1 | stimiaps2) + (1 | ssid)
mod_lmer$cda_phasmax_3: bio_cda_iscr_no_outl_imptd_log1p ~ 1 + tas_imptd_z_asid * arousal_0_1_z + (1 | stimiaps2) + (1 | ssid)
mod_lmer$cda_phasmax_4: bio_cda_iscr_no_outl_imptd_log1p ~ 1 + aq_imptd_z_asid * arousal_0_1_z + (1 | stimiaps2) + (1 | ssid)
                          npar    AIC    BIC  logLik -2*log(L)   Chisq Df Pr(>Chisq)   
mod_lmer$cda_phasmax_0       4 6849.9 6875.3 -3421.0    6841.9                         
mod_lmer$cda_phasmax_0_ar    5 6847.3 6879.0 -3418.7    6837.3  4.5980  1   0.032010 * 
mod_lmer$cda_phasmax_1       7 6840.1 6884.5 -3413.1    6826.1 11.1867  2   0.003722 **
mod_lmer$cda_phasmax_2       7 6846.9 6891.2 -3416.4    6832.9  0.0000  0              
mod_lmer$cda_phasmax_3       7 6840.3 6884.6 -3413.1    6826.3  6.5856  0              
mod_lmer$cda_phasmax_4       7 6846.7 6891.0 -3416.3    6832.7  0.0000  0     
hr
given that HR is a difference score, there is a case for droping the stim id random effect
```{r}

dta_4_lmms_sel_1_w_impt$tas_imptd_z<- scale(dta_4_lmms_sel_1_w_impt$tas_imptd)[,1]
dta_4_lmms_sel_1_w_impt$aq_imptd_z<- scale(dta_4_lmms_sel_1_w_impt$aq_imptd)[,1]
dta_4_lmms_sel_1_w_impt$arousal_0_1_z<- scale(dta_4_lmms_sel_1_w_impt$arousal_0_1)[,1]
dta_4_lmms_sel_1_w_impt$bio_mean_hr_dif_no_outl_imptd_z<- scale(dta_4_lmms_sel_1_w_impt$bio_mean_hr_dif_no_outl_imptd)[,1]
dta_4_lmms_sel_1_w_impt$bio_cda_iscr_no_outl_imptd_log1p_z<- scale(dta_4_lmms_sel_1_w_impt$bio_cda_iscr_no_outl_imptd_log1p)[,1]
dta_4_lmms_sel_1_w_impt$pup_bascor_no_outl_imptd_z<- scale(dta_4_lmms_sel_1_w_impt$pup_bascor_no_outl_imptd)[,1]
dta_4_lmms_sel_1_w_impt$nt_asd<- if_else(dta_4_lmms_sel_1_w_impt$asd_sid == "ASD", "ASD", "NON ASD")

dta_4_lmms_sel_1_w_impt<-  dta_4_lmms_sel_1_w_impt%>%
    group_by(nt_asd)%>%
    mutate(tas_imptd_z_asid = scale(tas_imptd)[,1],
           aq_imptd_z_asid = scale(aq_imptd)[,1]
           
           )%>%
  ungroup()

mod_lmer$hr_dif_0 <- lmer(bio_mean_hr_dif_no_outl_imptd ~ 1+ 
                            # (1 | stimiaps2)  + 
                                 (1 | ssid), REML = FALSE,
                      data = dta_4_lmms_sel_1_w_impt)





car::Anova(mod_lmer$hr_dif_0 , type = 3)
anova(mod_lmer$hr_dif_0 , type = 3)
summary(mod_lmer$hr_dif_0 )

mod_lmer$hr_dif_0_ar <- lmer(bio_mean_hr_dif_no_outl_imptd ~ 1+ arousal_0_1_z+
                               # (1 | stimiaps2)  + 
                                 (1 | ssid), REML = FALSE,
                      data = dta_4_lmms_sel_1_w_impt)




car::Anova(mod_lmer$hr_dif_0_ar , type = 3)
anova(mod_lmer$hr_dif_0_ar , type = 3)
summary(mod_lmer$hr_dif_0_ar )
# now test direct effects

table(is.na(dta_4_lmms_sel_1_w_impt$tas_imptd_z))
dta_4_lmms_sel_1_w_impt$aq_imptd_z
mod_lmer$hr_dif_1 <- lmer(bio_mean_hr_dif_no_outl_imptd ~ 1+tas_imptd_z*arousal_0_1_z+ 
                            # (1 | stimiaps2)  + 
                                 (1 | ssid), REML = FALSE,
                      data = dta_4_lmms_sel_1_w_impt)

car::Anova(mod_lmer$hr_dif_1 , type = 3)
anova(mod_lmer$hr_dif_1 , type = 3)
summary(mod_lmer$hr_dif_1 )


```
Type III Analysis of Variance Table with Satterthwaite's method
                           Sum Sq Mean Sq NumDF  DenDF F value    Pr(>F)    
tas_imptd_z                 3.181   3.181     1   83.1  0.1663 0.6844971    
arousal_0_1_z             218.408 218.408     1 4101.8 11.4147 0.0007354 ***
tas_imptd_z:arousal_0_1_z  24.603  24.603     1 3589.0  1.2858 0.2568968    
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
arousla only

```{r}
mod_lmer$hr_dif_2 <- lmer(bio_mean_hr_dif_no_outl_imptd ~ 1+aq_imptd_z*arousal_0_1_z+ 
                            # (1 | stimiaps2)  + 
                                 (1 | ssid), REML = FALSE,
                      data = dta_4_lmms_sel_1_w_impt)

car::Anova(mod_lmer$cda_phasmax_2 , type = 3)
anova(mod_lmer$cda_phasmax_2 , type = 3)
summary(mod_lmer$cda_phasmax_2 )

```
Analysis of Deviance Table (Type III Wald chisquare tests)

Response: bio_cda_iscr_no_outl_imptd_log1p
                            Chisq Df           Pr(>Chisq)    
(Intercept)              136.5281  1 < 0.0000000000000002 ***
aq_imptd_z                 4.5555  1              0.03281 *  
arousal_0_1_z              5.1100  1              0.02379 *  
aq_imptd_z:arousal_0_1_z   0.0424  1              0.83686    
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

# AQ and arousal effcet

```{r}

anova(mod_lmer$hr_dif_0,mod_lmer$hr_dif_0_ar, mod_lmer$hr_dif_1, mod_lmer$hr_dif_2 )
# all models are poor compared to NULL
```
Data: dta_4_lmms_sel_1_w_impt
Models:
mod_lmer$hr_dif_0: bio_mean_hr_dif_no_outl_imptd ~ 1 + (1 | ssid)
mod_lmer$hr_dif_0_ar: bio_mean_hr_dif_no_outl_imptd ~ 1 + arousal_0_1_z + (1 | ssid)
mod_lmer$hr_dif_1: bio_mean_hr_dif_no_outl_imptd ~ 1 + tas_imptd_z * arousal_0_1_z + (1 | ssid)
mod_lmer$hr_dif_2: bio_mean_hr_dif_no_outl_imptd ~ 1 + aq_imptd_z * arousal_0_1_z + (1 | ssid)
                     npar   AIC   BIC logLik -2*log(L)   Chisq Df Pr(>Chisq)    
mod_lmer$hr_dif_0       3 24306 24325 -12150     24300                          
mod_lmer$hr_dif_0_ar    4 24297 24322 -12144     24289 11.0500  1  0.0008869 ***
mod_lmer$hr_dif_1       6 24300 24338 -12144     24288  1.4614  2  0.4815763    
mod_lmer$hr_dif_2       6 24300 24338 -12144     24288  0.0000  0               
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

# now test direct effects

```{r}
mod_lmer$hr_dif_3 <- lmer(bio_mean_hr_dif_no_outl_imptd ~ 1+tas_imptd_z_asid*arousal_0_1_z+ 
                            # (1 | stimiaps2)  + 
                                 (1 | ssid), REML = FALSE,
                      data = dta_4_lmms_sel_1_w_impt)

car::Anova(mod_lmer$hr_dif_3 , type = 3)
anova(mod_lmer$hr_dif_3 , type = 3)
summary(mod_lmer$hr_dif_3 )

cor.test(dta_4_lmms_sel_1_w_impt$tas_imptd_z, dta_4_lmms_sel_1_w_impt$aq_imptd_z)

# 
mod_lmer$hr_dif_4 <- lmer(bio_mean_hr_dif_no_outl_imptd ~ 1+aq_imptd_z_asid*arousal_0_1_z+ 
                            # (1 | stimiaps2)  + 
                                 (1 | ssid), REML = FALSE,
                      data = dta_4_lmms_sel_1_w_impt)

car::Anova(mod_lmer$hr_dif_4 , type = 3)
anova(mod_lmer$hr_dif_4 , type = 3)
summary(mod_lmer$hr_dif_4 )

anova(mod_lmer$hr_dif_0, mod_lmer$hr_dif_1, mod_lmer$hr_dif_2,mod_lmer$hr_dif_3, mod_lmer$hr_dif_4 )
# all models perform poorer than the null


```

Models:
mod_lmer$hr_dif_0: bio_mean_hr_dif_no_outl_imptd ~ 1 + (1 | ssid)
mod_lmer$hr_dif_1: bio_mean_hr_dif_no_outl_imptd ~ 1 + tas_imptd_z * arousal_0_1_z + (1 | ssid)
mod_lmer$hr_dif_2: bio_mean_hr_dif_no_outl_imptd ~ 1 + aq_imptd_z * arousal_0_1_z + (1 | ssid)
mod_lmer$hr_dif_3: bio_mean_hr_dif_no_outl_imptd ~ 1 + tas_imptd_z_asid * arousal_0_1_z + (1 | ssid)
mod_lmer$hr_dif_4: bio_mean_hr_dif_no_outl_imptd ~ 1 + aq_imptd_z_asid * arousal_0_1_z + (1 | ssid)
                  npar   AIC   BIC logLik -2*log(L)   Chisq Df Pr(>Chisq)   
mod_lmer$hr_dif_0    3 24306 24325 -12150     24300                         
mod_lmer$hr_dif_1    6 24300 24338 -12144     24288 12.5114  3   0.005822 **
mod_lmer$hr_dif_2    6 24300 24338 -12144     24288  0.0000  0              
mod_lmer$hr_dif_3    6 24298 24336 -12143     24286  2.5711  0              
mod_lmer$hr_dif_4    6 24300 24338 -12144     24288  0.0000  




Pupil

```{r}

cor.test(dta_4_lmms_sel_1_w_impt$pup_bascor_no_outl, dta_4_lmms_sel_1_w_impt$pup_bascor)

mod_lmer$pup_0 <- lmer(pup_bascor_no_outl_imptd ~ 1+ 
                         # (1 | stimiaps2)  + 
                                 (1 | ssid), REML = FALSE,
                      data = dta_4_lmms_sel_1_w_impt)



car::Anova(mod_lmer$pup_0 , type = 3)
anova(mod_lmer$pup_0 , type = 3)
summary(mod_lmer$pup_0 )


mod_lmer$pup_0_ar <- lmer(pup_bascor_no_outl_imptd ~ 1+arousal_0_1_z+ 
                            # (1 | stimiaps2)  + 
                                 (1 | ssid), REML = FALSE,
                      data = dta_4_lmms_sel_1_w_impt)
anova(mod_lmer$pup_0_ar)
# now test direct effects
mod_lmer$pup_1 <- lmer(pup_bascor_no_outl_imptd ~ 1+tas_imptd_z*arousal_0_1_z+ 
                         # (1 | stimiaps2)  + 
                                 (1 | ssid), REML = FALSE,
                      data = dta_4_lmms_sel_1_w_impt)

car::Anova(mod_lmer$pup_1 , type = 3)
anova(mod_lmer$pup_1 , type = 3)
summary(mod_lmer$pup_1 )

# efects of arousal
# 
mod_lmer$pup_2 <- lmer(pup_bascor_no_outl_imptd ~ 1+aq_imptd_z*arousal_0_1_z+ 
                         # (1 | stimiaps2)  + 
                                 (1 | ssid), REML = FALSE,
                      data = dta_4_lmms_sel_1_w_impt)

car::Anova(mod_lmer$pup_2 , type = 3)
anova(mod_lmer$pup_2 , type = 3)
summary(mod_lmer$pup_2 )
# arpusal and interatcion


anova(mod_lmer$pup_0,mod_lmer$pup_0_ar, mod_lmer$pup_1, mod_lmer$pup_2 )
# aq best?
```
# no diff

```{r}
# aq and tas normalised by group
mod_lmer$pup_3 <- lmer(pup_bascor_no_outl_imptd ~ 1+tas_imptd_z_asid*arousal_0_1_z+ 
                         # (1 | stimiaps2)  + 
                                 (1 | ssid), REML = FALSE,
                      data = dta_4_lmms_sel_1_w_impt)

car::Anova(mod_lmer$pup_3 , type = 3)
anova(mod_lmer$pup_3 , type = 3)
summary(mod_lmer$pup_3 )

# effects of arousal 
# 
mod_lmer$pup_4 <- lmer(pup_bascor_no_outl_imptd ~ 1+aq_imptd_z_asid*arousal_0_1_z+
                         # (1 | stimiaps2)  + 
                                 (1 | ssid), REML = FALSE,
                      data = dta_4_lmms_sel_1_w_impt)

car::Anova(mod_lmer$pup_4 , type = 3)
anova(mod_lmer$pup_4 , type = 3)
summary(mod_lmer$pup_4 )

# similar effect of arousal only
anova(mod_lmer$pup_0, mod_lmer$pup_0_ar, mod_lmer$pup_1, mod_lmer$pup_2, mod_lmer$pup_3, mod_lmer$pup_4 )


```

coherence among physiology
<!-- just physio to physio -->

```{r eval=FALSE, include=FALSE}



mod_lmer$cda_phasmax_from_hr_0 <- lmer(bio_cda_iscr_no_outl_imptd_log1p ~ 1+bio_mean_hr_dif_no_outl_imptd+ (1 | stimiaps2)  + 
                                 (1 | ssid), REML = FALSE,
                      data = dta_4_lmms_sel_1_w_impt)

# car::Anova(mod_lmer$cda_phasmax_from_hr_0 , type = 3)
anova(mod_lmer$cda_phasmax_from_hr_0 , type = 3)
# summary(mod_lmer$cda_phasmax_from_hr_0 )

mod_lmer$cda_phasmax_from_pup_0 <- lmer( bio_cda_iscr_no_outl_imptd_log1p ~ 1+pup_bascor_no_outl_imptd_z+ (1 | stimiaps2)  + 
                                 (1 | ssid), REML = FALSE,
                      data = dta_4_lmms_sel_1_w_impt%>%
                        subset(!is.na(bio_cda_iscr_no_outl_imptd_log1p)))

# car::Anova(mod_lmer$cda_phasmax_from_hr_0 , type = 3)
anova(mod_lmer$cda_phasmax_from_pup_0 , type = 3)


mod_lmer$pup_from_hr_0 <- lmer(pup_bascor_no_outl_imptd ~bio_mean_hr_dif_no_outl_imptd_z + (1 | stimiaps2)  + 
                                 (1 | ssid), REML = FALSE,
                      data = dta_4_lmms_sel_1_w_impt)

# car::Anova(mod_lmer$cda_phasmax_from_hr_0 , type = 3)
anova(mod_lmer$pup_from_hr_0 , type = 3)



# flip
mod_lmer$hr_from_scr0 <- lmer(bio_mean_hr_dif_no_outl_imptd ~ 1+bio_cda_iscr_no_outl_imptd_log1p_z+ (1 | stimiaps2)  + 
                                 (1 | ssid), REML = FALSE,
                      data = dta_4_lmms_sel_1_w_impt)

# car::Anova(mod_lmer$cda_phasmax_from_hr_0 , type = 3)
anova(mod_lmer$hr_from_scr0 , type = 3)
# summary(mod_lmer$cda_phasmax_from_hr_0 )

mod_lmer$pup_from_scr0 <- lmer(pup_bascor_no_outl_imptd  ~ 1+bio_cda_iscr_no_outl_imptd_log1p_z+ (1 | stimiaps2)  + 
                                 (1 | ssid), REML = FALSE,
                      data = dta_4_lmms_sel_1_w_impt%>%
                        subset(!is.na(bio_cda_iscr_no_outl_imptd_log1p)))

# car::Anova(mod_lmer$cda_phasmax_from_hr_0 , type = 3)
anova(mod_lmer$pup_from_scr0 , type = 3)


mod_lmer$hr_from_pup0 <- lmer( bio_mean_hr_dif_no_outl_imptd~ 1+pup_bascor_no_outl_imptd_z+ (1 | stimiaps2)  + 
                                 (1 | ssid), REML = FALSE,
                      data = dta_4_lmms_sel_1_w_impt)

# car::Anova(mod_lmer$cda_phasmax_from_hr_0 , type = 3)
anova(mod_lmer$hr_from_pup0 , type = 3)

mod_lmer$hr_from_cda_phasmax_0 <- lmer(bio_mean_hr_dif_no_outl_imptd ~ 
                                         1+bio_cda_iscr_no_outl_imptd_log1p_z+ (1 | stimiaps2)  + 
                                 (1 | ssid), REML = FALSE,
                      data = dta_4_lmms_sel_1_w_impt%>%
                        subset(!is.na(bio_cda_iscr_no_outl_imptd_log1p)))


# car::Anova(mod_lmer$hr_from_cda_phasmax_0 , type = 3)

anova(mod_lmer$hr_from_cda_phasmax_0 , type = 3)
# summary(mod_lmer$hr_from_cda_phasmax_0 )





```


mod_lmer$cda_phasmax_from_hr_1 <- lmer(log1p(bio_cda_iscr_no_outl_imptd+.109) ~ 1+bio_mean_hr_dif_no_outl_imptd+
                                         
                                         tas_imptd_z:bio_mean_hr_dif_no_outl_imptd + (1 | stimiaps2)  + 
                                 (1 | ssid), REML = FALSE,
                      data = dta_4_lmms_sel_1_w_impt)

# car::Anova(mod_lmer$cda_phasmax_from_hr_1 , type = 3)
anova(mod_lmer$cda_phasmax_from_hr_1 , type = 3)
summary(mod_lmer$cda_phasmax_from_hr_1 )


mod_lmer$cda_phasmax_from_hr_2 <- lmer(log1p(bio_cda_iscr_no_outl_imptd+.109) ~ 1+bio_mean_hr_dif_no_outl_imptd+
                                         
                                         aq_imptd_z:bio_mean_hr_dif_no_outl_imptd + (1 | stimiaps2)  + 
                                 (1 | ssid), REML = FALSE,
                      data = dta_4_lmms_sel_1_w_impt)

car::Anova(mod_lmer$cda_phasmax_from_hr_2 , type = 3)
anova(mod_lmer$cda_phasmax_from_hr_2 , type = 3)
summary(mod_lmer$cda_phasmax_from_hr_1 )

anova(mod_lmer$cda_phasmax_0,mod_lmer$cda_phasmax_from_hr_0,mod_lmer$cda_phasmax_from_hr_1,mod_lmer$cda_phasmax_from_hr_2)
# the HR model is slightly better

# is the otehr eay around the same
mod_lmer$hr_from_cda_phasmax_0 <- lmer(bio_mean_hr_dif_no_outl_imptd ~ 
                                         1+bio_cda_iscr_no_outl_imptd_log1p+ (1 | stimiaps2)  + 
                                 (1 | ssid), REML = FALSE,
                      data = dta_4_lmms_sel_1_w_impt)

# car::Anova(mod_lmer$hr_from_cda_phasmax_0 , type = 3)
anova(mod_lmer$hr_from_cda_phasmax_0 , type = 3)
summary(mod_lmer$hr_from_cda_phasmax_0 )


mod_lmer$hr_from_cda_phasmax_1 <- lmer(bio_mean_hr_dif_no_outl_imptd ~ 1+bio_cda_iscr_no_outl_imptd_log1p+
                                         
                                         tas_imptd_z:bio_cda_iscr_no_outl_imptd_log1p + (1 | stimiaps2)  + 
                                 (1 | ssid), REML = FALSE,
                      data = dta_4_lmms_sel_1_w_impt)

car::Anova(mod_lmer$hr_from_cda_phasmax_1 , type = 3)
anova(mod_lmer$hr_from_cda_phasmax_1 , type = 3)
summary(mod_lmer$hr_from_cda_phasmax_1 )


mod_lmer$hr_from_cda_phasmax_2 <- lmer(bio_mean_hr_dif_no_outl_imptd ~ 1+bio_cda_iscr_no_outl_imptd_log1p+
                                         
                                         aq_imptd_z:bio_cda_iscr_no_outl_imptd_log1p + (1 | stimiaps2)  + 
                                 (1 | ssid), REML = FALSE,
                      data = dta_4_lmms_sel_1_w_impt)

car::Anova(mod_lmer$hr_from_cda_phasmax_2 , type = 3)
anova(mod_lmer$hr_from_cda_phasmax_2 , type = 3)
summary(mod_lmer$cda_phasmax_from_hr_1 )

anova(mod_lmer$cda_phasmax_0,mod_lmer$cda_phasmax_from_hr_0,mod_lmer$cda_phasmax_from_hr_1,mod_lmer$cda_phasmax_from_hr_2)


some sanity checks using correlations

```{r}
colnames(dta_4_lmms_sel_1_w_impt)

  
vars <- c(
  "bio_mean_hr_dif_no_outl_imptd",
  "bio_cda_iscr_no_outl_imptd_log1p",
  "pup_bascor_no_outl_imptd",
  "arousal_0_1"
)


# all unique pairs of variables
pairs <- combn(vars, 2, simplify = FALSE)

 
length(unique(dta_4_lmms_sel_1_w_impt$ssid))

dta_cor<- dta_4_lmms_sel_1_w_impt %>%
  group_by(ssid) %>%
  summarise(
    cor_mat = list(cor(as.matrix(across(all_of(vars))),
                       use = "pairwise.complete.obs")),
    .groups = "drop"
  ) %>%
  mutate(
    cor_long = lapply(cor_mat, \(m) as.data.frame(as.table(m)))
  ) %>%
  select(-cor_mat) %>%
  unnest(cor_long) %>%
  # turn factors into character first
  mutate(
    var1 = as.character(Var1),
    var2 = as.character(Var2)
  ) %>%
  rename(r = Freq) %>%
  select(-Var1, -Var2) %>%
  # keep only unique pairs (upper triangle, no diagonal)
  filter(var1 < var2) %>%
  unite("pair", var1, var2, sep = "_") %>%
  pivot_wider(
    names_from  = pair,
    values_from = r
  )


colnames(dta_cor)<- c("ssid", paste0(colnames(dta_cor[,2:7]), "_rho"))

# colnames(dta_cor)



dta_cor<- dta_cor %>%
  mutate(
    across(
      ends_with("_rho"),
      ~ atanh(.x),          # Fisher z
      # ~ atanh(pmin(pmax(.x, -0.999999), 0.999999)),#Add trimming to avoid atanh() producing Inf:
      .names = "r2z_{.col}"   # create new columns
    )
  )

colnames(dta_4_lmms_sel_1_w_impt)

dta_4_lmms_sel_1_w_impt_sid_agg<- dta_4_lmms_sel_1_w_impt%>%
  group_by(ssid,asd_sid)%>%
  summarise_at(c("tas", "aq", "age", "age_imptd", "tas_imptd","aq_imptd", "tas_imptd_z","aq_imptd_z"), mean, na.rm = T)%>%
  ungroup()

dta_4_lmms_sel_1_w_impt_sid_agg

dta_cor<- left_join(dta_4_lmms_sel_1_w_impt_sid_agg,dta_cor)




dta_cor %>%
  pivot_longer(
    cols = starts_with("r2z"),
    names_to = "pair",
    values_to = "rho"
  ) %>%
  subset(ssid!= 606)%>%
   # subset(ssid!= 605)%>%
  ggplot(aes(x = tas_imptd_z, y = rho)) +   # or `tas` if you prefer
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
 
  facet_wrap(~ pair) +
   ggpubr::stat_cor()+
  theme_minimal()+
  geom_text(aes(label = ssid))


dta_cor %>%
  pivot_longer(
    cols = starts_with("r2z"),
    names_to = "pair",
    values_to = "rho"
  ) %>%
  subset(ssid!= 606)%>%
  ggplot(aes(x = aq_imptd_z, y = rho)) +   # or `tas` if you prefer
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
 
  facet_wrap(~ pair) +
   ggpubr::stat_cor()+
  theme_minimal()+
  geom_text(aes(label = ssid))


unique(dta_cor$asd_sid)

dta_cor$nt_asd<- if_else(dta_cor$asd_sid == "ASD", "ASD", "NON ASD")
  
# now new z score
dta_cor<-  dta_cor%>%
    group_by(nt_asd)%>%
    mutate(tas_imptd_z_asid = scale(tas_imptd)[,1],
           aq_imptd_z_asid = scale(aq_imptd)[,1]
           
           )

# new vis

dta_cor %>%
  pivot_longer(
    cols = starts_with("r2z"),
    names_to = "pair",
    values_to = "rho"
  ) %>%
  subset(ssid!= 606)%>%
   subset(ssid!= 606)%>%
  ggplot(aes(x = tas_imptd_z_asid, y = rho)) +   # or `tas` if you prefer
  geom_point(aes(colour = nt_asd)) +
  geom_smooth(method = "lm", se = FALSE) +
 
  facet_wrap(~ pair) +
   ggpubr::stat_cor()+
  theme_minimal()+
  geom_text(aes(label = ssid))


dta_cor %>%
  pivot_longer(
    cols = starts_with("r2z"),
    names_to = "pair",
    values_to = "rho"
  ) %>%
  subset(ssid!= 606)%>%
  ggplot(aes(x = aq_imptd_z_asid, y = rho)) +   # or `tas` if you prefer
   geom_point(aes(colour = nt_asd)) +
  geom_smooth(method = "lm", se = FALSE) +
 
  facet_wrap(~ pair) +
   ggpubr::stat_cor()+
  theme_minimal()+
  geom_text(aes(label = ssid))

dta_cor%>%
  select(-c(starts_with("r2z")))%>%
  pivot_longer(
    cols = ends_with("rho"),
    names_to = "pair",
    values_to = "rho"
  )%>%
  subset(abs(rho)> .8)

dta_cor%>%
  select(-c(starts_with("r2z")))%>%
  pivot_longer(
    cols = ends_with("rho"),
    names_to = "pair",
    values_to = "rho"
  )%>%
  ggplot(aes(rho))+
  geom_histogram()+
  geom_density()+
  facet_grid(~pair)


t.test(dta_cor$r2z_bio_cda_iscr_no_outl_imptd_log1p_bio_mean_hr_dif_no_outl_imptd_rho^2)
t.test(dta_cor$r2z_arousal_0_1_bio_cda_iscr_no_outl_imptd_log1p_rho^2)

cor.test(dta_cor$r2z_arousal_0_1_bio_cda_iscr_no_outl_imptd_log1p_rho^2, dta_cor$tas_imptd_z)

cor.test(dta_cor$r2z_bio_cda_iscr_no_outl_imptd_log1p_bio_mean_hr_dif_no_outl_imptd_rho^2, dta_cor$tas_imptd_z)
```

debug 606
```{r}

dta_4_lmms_sel_1_w_impt%>%
  subset(ssid == 606)

```
check the model excluding ASD
```{r}
save.image("~/Library/CloudStorage/GoogleDrive-helioclemente.c@gmail.com/My Drive/Papers 2022/InteroceptionStudy/InteroStudy2020/analysis/DataAnalysisJanuary2020/DataAnalysisJan2020/2022_2023_Analyses/Data/2025 - autism and alexithymia/dta_oxf_alex_aut_coherence_Dec2025.RData")

```
